<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic|Lobster+Two:300,300italic,400,400italic,700,700italic|EB+Garamond:300,300italic,400,400italic,700,700italic|Roboto+Slab:300,300italic,400,400italic,700,700italic|Source+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"driverxdw.github.io","root":"/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="前言之前就对linux上附加的一些小工具像netstat、ps、top等的功能比较感兴趣，虽然知道本质上还是去解析vfs中的信息，但对其细节比较好奇，这边做下源码分析，同时也为后续对其它相对于netstat更复杂的程序&#x2F;项目的分析做下铺垫，如sysdig、osquery、linux kernel等等；这块spoock江城子师傅已经写过类似的文章，个人觉得写的很好，要点都get到了，作为读者受益匪浅">
<meta property="og:type" content="article">
<meta property="og:title" content="Netstat Source Code Debug">
<meta property="og:url" content="https://driverxdw.github.io/2020/08/30/Netstat-Source-Code-Debug/index.html">
<meta property="og:site_name" content="in0va&#39;S Blog  JustLearnM0re">
<meta property="og:description" content="前言之前就对linux上附加的一些小工具像netstat、ps、top等的功能比较感兴趣，虽然知道本质上还是去解析vfs中的信息，但对其细节比较好奇，这边做下源码分析，同时也为后续对其它相对于netstat更复杂的程序&#x2F;项目的分析做下铺垫，如sysdig、osquery、linux kernel等等；这块spoock江城子师傅已经写过类似的文章，个人觉得写的很好，要点都get到了，作为读者受益匪浅">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-08-30T10:27:23.000Z">
<meta property="article:modified_time" content="2020-10-20T13:27:36.009Z">
<meta property="article:author" content="XDW">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="二进制">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://driverxdw.github.io/2020/08/30/Netstat-Source-Code-Debug/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Netstat Source Code Debug | in0va'S Blog  JustLearnM0re</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">in0va'S Blog  JustLearnM0re</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">犯二</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">84</span></a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调试环境"><span class="nav-number">2.</span> <span class="nav-text">调试环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XDW"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">XDW</p>
  <div class="site-description" itemprop="description">一枚很菜但是仍在学习的二进制菜逼</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">84</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.ixuchao.cn/" title="https:&#x2F;&#x2F;blog.ixuchao.cn&#x2F;" rel="noopener" target="_blank">Archerx's Blog</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://driverxdw.github.io/2020/08/30/Netstat-Source-Code-Debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="XDW">
      <meta itemprop="description" content="一枚很菜但是仍在学习的二进制菜逼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="in0va'S Blog  JustLearnM0re">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Netstat Source Code Debug
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-30 18:27:23" itemprop="dateCreated datePublished" datetime="2020-08-30T18:27:23+08:00">2020-08-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-10-20 21:27:36" itemprop="dateModified" datetime="2020-10-20T21:27:36+08:00">2020-10-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前就对linux上附加的一些小工具像netstat、ps、top等的功能比较感兴趣，虽然知道本质上还是去解析vfs中的信息，但对其细节比较好奇，这边做下源码分析，同时也为后续对其它相对于netstat更复杂的程序/项目的分析做下铺垫，如sysdig、osquery、linux kernel等等；这块spoock江城子师傅已经写过类似的文章，个人觉得写的很好，要点都get到了，作为读者受益匪浅，贴下链接致敬下引路人：<a href="https://blog.spoock.com/2019/05/26/netstat-learn/。" target="_blank" rel="noopener">https://blog.spoock.com/2019/05/26/netstat-learn/。</a></p>
<p>下面所做分析可能无法面面俱到，非核心的函数和功能分析将被drop。</p>
<a id="more"></a>

<h2 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h2><p>此次调试是在vscode下使用gdbserver launch远程进行的，调试端的launch.json配置如下，被调端gdbserver挂住就好了</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"(gdb) Launch"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"cppdbg"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"$&#123;workspaceFolder&#125;/netstat"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [],</span><br><span class="line">            <span class="attr">"stopAtEntry"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceFolder&#125;"</span>,</span><br><span class="line">            <span class="attr">"environment"</span>: [],</span><br><span class="line">            <span class="attr">"externalConsole"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">            <span class="attr">"linux"</span>: &#123;</span><br><span class="line">                <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">                <span class="attr">"miDebuggerPath"</span>: <span class="string">"/usr/bin/gdb"</span>,</span><br><span class="line">                <span class="attr">"miDebuggerServerAddress"</span>: <span class="string">"10.211.55.4:7777"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"setupCommands"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">"Enable pretty-printing for gdb"</span>,</span><br><span class="line">                    <span class="attr">"text"</span>: <span class="string">"-enable-pretty-printing"</span>,</span><br><span class="line">                    <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>2286行之前大量操作用在判断程序启动参数上，并给当作参数标志位使用的变量置位，以及其它一些初始化操作</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if I18N</span></span><br><span class="line">    setlocale (LC_ALL, <span class="string">""</span>);</span><br><span class="line">    bindtextdomain(<span class="string">"net-tools"</span>, <span class="string">"/usr/share/locale"</span>);</span><br><span class="line">    textdomain(<span class="string">"net-tools"</span>);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">    getroute_init();		<span class="regexp">/* Set up AF routing support */</span></span><br><span class="line"></span><br><span class="line">    afname[<span class="number">0</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">while</span> ((i = getopt_long(argc, argv, <span class="string">"A:CFMacdeghilnNoprsStuUvVWw2fx64?Z"</span>, longopts, &amp;lop)) != EOF)</span><br><span class="line">	switch (i) &#123;</span><br><span class="line">	case -<span class="number">1</span>:</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="number">1</span>:</span><br><span class="line">	    <span class="keyword">if</span> (lop &lt; <span class="number">0</span> || lop &gt;= AFTRANS_CNT) &#123;</span><br><span class="line">		EINTERN(<span class="string">"netstat.c"</span>, <span class="string">"longopts 1 range"</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(longopts[lop].name))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'A'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(optarg))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'M'</span>:</span><br><span class="line">	    flag_mas++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'a'</span>:</span><br><span class="line">	    flag_all++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'l'</span>:</span><br><span class="line">	    flag_lst++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'c'</span>:</span><br><span class="line">	    flag_cnt++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	case <span class="string">'d'</span>:</span><br><span class="line">	    flag_deb++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'g'</span>:</span><br><span class="line">	    flag_igmp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'e'</span>:</span><br><span class="line">	    flag_exp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'p'</span>:</span><br><span class="line">	    flag_prg++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'i'</span>:</span><br><span class="line">	    flag_int++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'W'</span>:</span><br><span class="line">	    flag_wide++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'n'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'!'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_HOST;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'@'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_PORT;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'#'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_USER;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'N'</span>:</span><br><span class="line">	    flag_not |= FLAG_SYM;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'C'</span>:</span><br><span class="line">	    flag_cf |= FLAG_CACHE;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'F'</span>:</span><br><span class="line">	    flag_cf |= FLAG_FIB;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'o'</span>:</span><br><span class="line">	    flag_opt++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'6'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"inet6"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'4'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"inet"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'V'</span>:</span><br><span class="line">	    version();</span><br><span class="line">	    <span class="regexp">/*NOTREACHED */</span></span><br><span class="line">	case <span class="string">'v'</span>:</span><br><span class="line">	    flag_ver |= FLAG_VERBOSE;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'r'</span>:</span><br><span class="line">	    flag_rou++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'t'</span>:</span><br><span class="line">	    flag_tcp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'S'</span>:</span><br><span class="line">	    flag_sctp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'u'</span>:</span><br><span class="line">	    flag_udp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'U'</span>:</span><br><span class="line">	    flag_udplite++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'w'</span>:</span><br><span class="line">	    flag_raw++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'2'</span>:</span><br><span class="line">	    flag_l2cap++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'f'</span>:</span><br><span class="line">	    flag_rfcomm++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'x'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"unix"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'Z'</span>:</span><br><span class="line"><span class="comment">#if HAVE_SELINUX</span></span><br><span class="line">	    <span class="keyword">if</span> (is_selinux_enabled() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		fprintf(stderr, _(<span class="string">"SELinux is not enabled on this machine.\n"</span>));</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    flag_prg++;</span><br><span class="line">	    flag_selinux++;</span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">            fprintf(stderr, _(<span class="string">"SELinux is not enabled for this application.\n"</span>));</span><br><span class="line">	    <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'?'</span>:</span><br><span class="line">	    usage(E_OPTERR);</span><br><span class="line">	case <span class="string">'h'</span>:</span><br><span class="line">	    usage(E_USAGE);</span><br><span class="line">	case <span class="string">'s'</span>:</span><br><span class="line">	    flag_sta++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag_int + flag_rou + flag_mas + flag_sta &gt; <span class="number">1</span>)</span><br><span class="line">	usage(E_OPTERR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flag_inet || flag_inet6 || flag_sta) &amp;&amp;</span><br><span class="line">        !(flag_tcp || flag_sctp || flag_udp || flag_udplite || flag_raw))</span><br><span class="line">	   flag_noprot = flag_tcp = flag_sctp = flag_udp = flag_udplite = flag_raw = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flag_tcp || flag_sctp || flag_udp || flag_udplite || flag_raw || flag_igmp) &amp;&amp;</span><br><span class="line">        !(flag_inet || flag_inet6))</span><br><span class="line">        flag_inet = flag_inet6 = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag_bluetooth &amp;&amp; !(flag_l2cap || flag_rfcomm))</span><br><span class="line">	   flag_l2cap = flag_rfcomm = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    flag_arg = flag_tcp + flag_sctp + flag_udplite + flag_udp + flag_raw + flag_unx</span><br><span class="line">        + flag_ipx + flag_ax25 + flag_netrom + flag_igmp + flag_x25 + flag_rose</span><br><span class="line">	+ flag_l2cap + flag_rfcomm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag_mas) &#123;</span><br><span class="line"><span class="comment">#if HAVE_FW_MASQUERADE &amp;&amp; HAVE_AFINET</span></span><br><span class="line"><span class="comment">#if MORE_THAN_ONE_MASQ_AF</span></span><br><span class="line">	<span class="keyword">if</span> (!afname[<span class="number">0</span>])</span><br><span class="line">        safe_strncpy(afname, DFLT_AF, sizeof(afname));</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	    i = ip_masq_info(flag_not &amp; FLAG_NUM_HOST,</span><br><span class="line">			     flag_not &amp; FLAG_NUM_PORT, flag_exp);</span><br><span class="line">	    <span class="keyword">if</span> (i || !flag_cnt)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    wait_continous();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">	ENOSUPP(<span class="string">"netstat"</span>, <span class="string">"FW_MASQUERADE"</span>);</span><br><span class="line">	i = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">	return (i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag_sta) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!afname[<span class="number">0</span>])</span><br><span class="line">            safe_strncpy(afname, DFLT_AF, sizeof(afname));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!strcmp(afname, <span class="string">"inet"</span>)) &#123;</span><br><span class="line"><span class="comment">#if HAVE_AFINET</span></span><br><span class="line">            parsesnmp(flag_raw, flag_tcp, flag_udp, flag_sctp);</span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">            ENOSUPP(<span class="string">"netstat"</span>, <span class="string">"AF INET"</span>);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!strcmp(afname, <span class="string">"inet6"</span>)) &#123;</span><br><span class="line"><span class="comment">#if HAVE_AFINET6</span></span><br><span class="line">            parsesnmp6(flag_raw, flag_tcp, flag_udp);</span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">            ENOSUPP(<span class="string">"netstat"</span>, <span class="string">"AF INET6"</span>);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          printf(_(<span class="string">"netstat: No statistics support for specified address family: %s\n"</span>), afname);</span><br><span class="line">          <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flag_rou) &#123;</span><br><span class="line">	int options = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!afname[<span class="number">0</span>])</span><br><span class="line">        safe_strncpy(afname, DFLT_AF, sizeof(afname));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flag_exp == <span class="number">2</span>)</span><br><span class="line">	    flag_exp = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (flag_exp == <span class="number">1</span>)</span><br><span class="line">	    flag_exp = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	options = (flag_exp &amp; FLAG_EXT) | flag_not | flag_cf | flag_ver;</span><br><span class="line">	<span class="keyword">if</span> (!flag_cf)</span><br><span class="line">	    options |= FLAG_FIB;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	    i = route_info(afname, options);</span><br><span class="line">	    <span class="keyword">if</span> (i || !flag_cnt)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            wait_continous();</span><br><span class="line">	&#125;</span><br><span class="line">	return (i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flag_int) &#123;</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	    i = iface_info();</span><br><span class="line">	    <span class="keyword">if</span> (!flag_cnt || i)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">            wait_continous();</span><br><span class="line">	&#125;</span><br><span class="line">	return (i);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>prg_cache_load</strong></p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">if</span> HAVE_AFINET</span><br><span class="line">	    prg_cache_load();</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">"Active Internet connections "</span>));	<span class="comment">/* xxx */</span></span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (flag_all)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">"(servers and established)"</span>));</span><br><span class="line">	    <span class="keyword">else</span> &#123;</span><br><span class="line">	      <span class="keyword">if</span> (flag_lst)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">"(only servers)"</span>));</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">"(w/o servers)"</span>));</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">"\nProto Recv-Q Send-Q Local Address           Foreign Address         State      "</span>));	<span class="comment">/* xxx */</span></span><br><span class="line">	    <span class="keyword">if</span> (flag_exp &gt; <span class="number">1</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">" User       Inode     "</span>));</span><br><span class="line">	    print_progname_banner();</span><br><span class="line">	    print_selinux_banner();</span><br><span class="line">	    <span class="keyword">if</span> (flag_opt)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="symbol">_</span>(<span class="string">" Timer"</span>));	<span class="comment">/* xxx */</span></span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">	    <span class="keyword">if</span> (flag_arg) &#123;</span><br><span class="line">		i = <span class="number">1</span>;</span><br><span class="line">		ENOSUPP(<span class="string">"netstat"</span>, <span class="string">"AF INET"</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>​    2286行之后，首先需要引起注意的是<code>#if HAVE_AFINET</code>这句判断，需要了解的是，socket套接字协议类型是种类繁多的，官方将不同种类和功能的socket根据协议分类到不同的socket协议族中，如AF_BLUETOOTH、AF_NETLINK、AF_INET、AF_INET6等，这些不同协议族中的socket有的是用于进程间通信，有的是用于和硬件通信，有的是用于网络通信等等，不同类型功能各不相同，所以需要分类去显示，<code>#if HAVE_xxxx</code>也就是用于netstat去分类显示用的。</p>
<p>​    其次比较重要的是prg_cache_load这个函数，先贴下</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prg_cache_load</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">line</span>[LINE_MAX], eacces=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> procfdlen, fd, cmdllen, lnamelen;</span><br><span class="line">    <span class="keyword">char</span> lname[<span class="number">30</span>], cmdlbuf[<span class="number">512</span>], finbuf[PROGNAME_WIDTH];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> inode;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cs, *cmdlp;</span><br><span class="line">    DIR *dirproc = <span class="literal">NULL</span>, *dirfd = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">direproc</span>, *<span class="title">direfd</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_SELINUX</span></span><br><span class="line">    <span class="keyword">security_context_t</span> scon = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prg_cache_loaded || !flag_prg) <span class="keyword">return</span>;</span><br><span class="line">    prg_cache_loaded = <span class="number">1</span>;</span><br><span class="line">    cmdlbuf[<span class="keyword">sizeof</span>(cmdlbuf) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(dirproc=opendir(PATH_PROC))) <span class="keyword">goto</span> fail;</span><br><span class="line">    <span class="keyword">while</span> (errno = <span class="number">0</span>, direproc = readdir(dirproc)) &#123;</span><br><span class="line">	<span class="keyword">for</span> (cs = direproc-&gt;d_name; *cs; cs++)</span><br><span class="line">	    <span class="keyword">if</span> (!<span class="built_in">isdigit</span>(*cs))</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">if</span> (*cs)</span><br><span class="line">	    <span class="keyword">continue</span>;</span><br><span class="line">	procfdlen = <span class="built_in">snprintf</span>(<span class="built_in">line</span>,<span class="keyword">sizeof</span>(<span class="built_in">line</span>),PATH_PROC_X_FD,direproc-&gt;d_name);</span><br><span class="line">	<span class="keyword">if</span> (procfdlen &lt;= <span class="number">0</span> || procfdlen &gt;= <span class="keyword">sizeof</span>(<span class="built_in">line</span>) - <span class="number">5</span>)</span><br><span class="line">	    <span class="keyword">continue</span>;</span><br><span class="line">	errno = <span class="number">0</span>;</span><br><span class="line">	dirfd = opendir(<span class="built_in">line</span>);</span><br><span class="line">	<span class="keyword">if</span> (! dirfd) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (errno == EACCES)</span><br><span class="line">		eacces = <span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">continue</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">line</span>[procfdlen] = <span class="string">'/'</span>;</span><br><span class="line">	cmdlp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">while</span> ((direfd = readdir(dirfd))) &#123;</span><br><span class="line">           <span class="comment">/* Skip . and .. */</span></span><br><span class="line">           <span class="keyword">if</span> (!<span class="built_in">isdigit</span>(direfd-&gt;d_name[<span class="number">0</span>]))</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">	    <span class="keyword">if</span> (procfdlen + <span class="number">1</span> + <span class="built_in">strlen</span>(direfd-&gt;d_name) + <span class="number">1</span> &gt; <span class="keyword">sizeof</span>(<span class="built_in">line</span>))</span><br><span class="line">		<span class="keyword">continue</span>;</span><br><span class="line">	    <span class="built_in">memcpy</span>(<span class="built_in">line</span> + procfdlen - PATH_FD_SUFFl, PATH_FD_SUFF <span class="string">"/"</span>,</span><br><span class="line">		   PATH_FD_SUFFl + <span class="number">1</span>);</span><br><span class="line">        safe_strncpy(<span class="built_in">line</span> + procfdlen + <span class="number">1</span>, direfd-&gt;d_name,</span><br><span class="line">                        <span class="keyword">sizeof</span>(<span class="built_in">line</span>) - procfdlen - <span class="number">1</span>);</span><br><span class="line">	    lnamelen = readlink(<span class="built_in">line</span>, lname, <span class="keyword">sizeof</span>(lname) - <span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">if</span> (lnamelen == <span class="number">-1</span>)</span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">            lname[lnamelen] = <span class="string">'\0'</span>;  <span class="comment">/*make it a null-terminated string*/</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (extract_type_1_socket_inode(lname, &amp;inode) &lt; <span class="number">0</span>)</span><br><span class="line">              <span class="keyword">if</span> (extract_type_2_socket_inode(lname, &amp;inode) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!cmdlp) &#123;</span><br><span class="line">		<span class="keyword">if</span> (procfdlen - PATH_FD_SUFFl + PATH_CMDLINEl &gt;=</span><br><span class="line">		    <span class="keyword">sizeof</span>(<span class="built_in">line</span>) - <span class="number">5</span>)</span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">        safe_strncpy(<span class="built_in">line</span> + procfdlen - PATH_FD_SUFFl, PATH_CMDLINE,</span><br><span class="line">                        <span class="keyword">sizeof</span>(<span class="built_in">line</span>) - procfdlen + PATH_FD_SUFFl);</span><br><span class="line">		fd = <span class="built_in">open</span>(<span class="built_in">line</span>, O_RDONLY);</span><br><span class="line">		<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">		cmdllen = <span class="built_in">read</span>(fd, cmdlbuf, <span class="keyword">sizeof</span>(cmdlbuf) - <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">close</span>(fd))</span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (cmdllen == <span class="number">-1</span>)</span><br><span class="line">		    <span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (cmdllen &lt; <span class="keyword">sizeof</span>(cmdlbuf) - <span class="number">1</span>)</span><br><span class="line">		    cmdlbuf[cmdllen]=<span class="string">'\0'</span>;</span><br><span class="line">		<span class="keyword">if</span> (cmdlbuf[<span class="number">0</span>] == <span class="string">'/'</span> &amp;&amp; (cmdlp = <span class="built_in">strrchr</span>(cmdlbuf, <span class="string">'/'</span>)))</span><br><span class="line">		    cmdlp++;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		    cmdlp = cmdlbuf;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="built_in">snprintf</span>(finbuf, <span class="keyword">sizeof</span>(finbuf), <span class="string">"%s/%s"</span>, direproc-&gt;d_name, cmdlp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_SELINUX</span></span><br><span class="line">	    <span class="keyword">if</span> (getpidcon(atoi(direproc-&gt;d_name), &amp;scon) == <span class="number">-1</span>) &#123;</span><br><span class="line">		    scon=xstrdup(<span class="string">"-"</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    prg_cache_add(inode, finbuf, scon);</span><br><span class="line">	    freecon(scon);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	    prg_cache_add(inode, finbuf, <span class="string">"-"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	closedir(dirfd);</span><br><span class="line">	dirfd = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dirproc)</span><br><span class="line">	closedir(dirproc);</span><br><span class="line">    <span class="keyword">if</span> (dirfd)</span><br><span class="line">	closedir(dirfd);</span><br><span class="line">    <span class="keyword">if</span> (!eacces)</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (prg_cache_loaded == <span class="number">1</span>) &#123;</span><br><span class="line">    fail:</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,_(<span class="string">"(No info could be read for \"-p\": geteuid()=%d but you should be root.)\n"</span>),</span><br><span class="line">		geteuid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, _(<span class="string">"(Not all processes could be identified, non-owned process info\n"</span></span><br><span class="line">			 <span class="string">" will not be shown, you would have to be root to see it all.)\n"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    这部分代码主要用来初始化保存pid/cmdline-inode之间对应关系的缓存链表，看上去很长，其实逻辑很清晰，首先<code>if (prg_cache_loaded || !flag_prg) return;</code>一句通过判断prg_cache是否已经加载以及netstat -p参数是否置位，来决定是否进入此分支；一旦进入此分支，则利用readdir进行二次循环，第一次拿到/proc下pid，第二次解析出/proc/pid/fd下的inode以及拿到cmdline等数据；最后，利用<code>prg_cache_add(inode, finbuf, &quot;-&quot;)</code>将解析出的inode及findbuf放入prg_node链表中，此处的finbuf是pid和cmdline的拼接，第三个参数scon为”-“，后面可知由于proc下pid具有瞬时特性，pid数据可能存在丢失，一旦netstat未解析出网络数据对应的pid，则用”-“在pid/program一栏进行代替。</p>
<p>​    看下prg_cache_add，如下，与之联动对链表进行增、查、删操作的还有prg_cache_get和prg_cache_get_con以及prg_cache_clear，一并贴下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">static void prg<span class="constructor">_cache_add(<span class="params">unsigned</span> <span class="params">long</span> <span class="params">inode</span>, <span class="params">char</span> <span class="operator">*</span><span class="params">name</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">scon</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    unsigned hi = <span class="constructor">PRG_HASHIT(<span class="params">inode</span>)</span>;</span><br><span class="line">    <span class="keyword">struct</span> prg_node **pnp,*pn;</span><br><span class="line"></span><br><span class="line">    prg_cache_loaded = <span class="number">2</span>;</span><br><span class="line">    for (pnp = prg_hash + hi; (pn = *pnp); pnp = &amp;pn-&gt;next) &#123;</span><br><span class="line">	<span class="keyword">if</span> (pn-&gt;inode<span class="operator"> == </span>inode) &#123;</span><br><span class="line">	    <span class="comment">/* Some warning should be appropriate here</span></span><br><span class="line"><span class="comment">	       as we got multiple processes for one i-node */</span></span><br><span class="line">	    return;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(*pnp = malloc(sizeof(**pnp))))</span><br><span class="line">	return;</span><br><span class="line">    pn = *pnp;</span><br><span class="line">    pn-&gt;next = NULL;</span><br><span class="line">    pn-&gt;inode = inode;</span><br><span class="line">    safe<span class="constructor">_strncpy(<span class="params">pn</span>-&gt;<span class="params">name</span>, <span class="params">name</span>, <span class="params">sizeof</span>(<span class="params">pn</span>-&gt;<span class="params">name</span>)</span>);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">	<span class="built_in">int</span> len = (strlen(scon) - sizeof(pn-&gt;scon)) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">            safe<span class="constructor">_strncpy(<span class="params">pn</span>-&gt;<span class="params">scon</span>, &amp;<span class="params">scon</span>[<span class="params">len</span> + 1], <span class="params">sizeof</span>(<span class="params">pn</span>-&gt;<span class="params">scon</span>)</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">            safe<span class="constructor">_strncpy(<span class="params">pn</span>-&gt;<span class="params">scon</span>, <span class="params">scon</span>, <span class="params">sizeof</span>(<span class="params">pn</span>-&gt;<span class="params">scon</span>)</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">static const <span class="built_in">char</span> *prg<span class="constructor">_cache_get(<span class="params">unsigned</span> <span class="params">long</span> <span class="params">inode</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    unsigned hi = <span class="constructor">PRG_HASHIT(<span class="params">inode</span>)</span>;</span><br><span class="line">    <span class="keyword">struct</span> prg_node *pn;</span><br><span class="line"></span><br><span class="line">    for (pn = prg_hash<span class="literal">[<span class="identifier">hi</span>]</span>; pn; pn = pn-&gt;next)</span><br><span class="line">	<span class="keyword">if</span> (pn-&gt;inode<span class="operator"> == </span>inode)</span><br><span class="line">	    return (pn-&gt;name);</span><br><span class="line">    return (<span class="string">"-"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const <span class="built_in">char</span> *prg<span class="constructor">_cache_get_con(<span class="params">unsigned</span> <span class="params">long</span> <span class="params">inode</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    unsigned hi = <span class="constructor">PRG_HASHIT(<span class="params">inode</span>)</span>;</span><br><span class="line">    <span class="keyword">struct</span> prg_node *pn;</span><br><span class="line"></span><br><span class="line">    for (pn = prg_hash<span class="literal">[<span class="identifier">hi</span>]</span>; pn; pn = pn-&gt;next)</span><br><span class="line">	<span class="keyword">if</span> (pn-&gt;inode<span class="operator"> == </span>inode)</span><br><span class="line">	    return (pn-&gt;scon);</span><br><span class="line">    return (<span class="string">"-"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void prg<span class="constructor">_cache_clear(<span class="params">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> prg_node **pnp,*pn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prg_cache_loaded<span class="operator"> == </span><span class="number">2</span>)</span><br><span class="line">	for (pnp = prg_hash; pnp &lt; prg_hash + PRG_HASH_SIZE; pnp++)</span><br><span class="line">	    <span class="keyword">while</span> ((pn = *pnp)) &#123;</span><br><span class="line">		*pnp = pn-&gt;next;</span><br><span class="line">		free(pn);</span><br><span class="line">	    &#125;</span><br><span class="line">    prg_cache_loaded = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>tcp_info</strong></p>
<p>Prg_load之后正式进入解析流程，首先依旧是判断socket协议族类型，不同协议族进入不同分支进行处理，这边主要关注<code>HAVE_AFINET</code>协议，HAVE_AFINET协议族内部又包含不同socket类型，具体包括tcp、udp、raw_info等，此处主要分析tcp，因为流程都类似。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">if</span> <span class="string">HAVE_AFINET</span></span><br><span class="line">	<span class="attr">if</span> <span class="string">(!flag_arg || flag_tcp) &#123;</span></span><br><span class="line">	    <span class="attr">i</span> = <span class="string">tcp_info();</span></span><br><span class="line">	    <span class="attr">if</span> <span class="string">(i)</span></span><br><span class="line">		<span class="attr">return</span> <span class="string">(i);</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">if</span> <span class="string">(!flag_arg || flag_sctp) &#123;</span></span><br><span class="line">	    <span class="attr">i</span> = <span class="string">sctp_info();</span></span><br><span class="line">	    <span class="attr">if</span> <span class="string">(i)</span></span><br><span class="line">		<span class="attr">return</span> <span class="string">(i);</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">if</span> <span class="string">(!flag_arg || flag_udp) &#123;</span></span><br><span class="line">	    <span class="attr">i</span> = <span class="string">udp_info();</span></span><br><span class="line">	    <span class="attr">if</span> <span class="string">(i)</span></span><br><span class="line">		<span class="attr">return</span> <span class="string">(i);</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">if</span> <span class="string">(!flag_arg || flag_udplite) &#123;</span></span><br><span class="line">	    <span class="attr">i</span> = <span class="string">udplite_info();</span></span><br><span class="line">	    <span class="attr">if</span> <span class="string">(i)</span></span><br><span class="line">		<span class="attr">return</span> <span class="string">(i);</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="attr">if</span> <span class="string">(!flag_arg || flag_raw) &#123;</span></span><br><span class="line">	    <span class="attr">i</span> = <span class="string">raw_info();</span></span><br><span class="line">	    <span class="attr">if</span> <span class="string">(i)</span></span><br><span class="line">		<span class="attr">return</span> <span class="string">(i);</span></span><br><span class="line">	<span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    INFO_GUTS6(_PATH_PROCNET_TCP, _PATH_PROCNET_TCP6, <span class="string">"AF INET (tcp)"</span>,</span><br><span class="line">	       tcp_do_one, <span class="string">"tcp"</span>, <span class="string">"tcp6"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tcp_info调用了<code>INFO_GUTS6</code>，INFO_GUTS6有六个参数，前两个是lib/pathnames.h中定义的宏，分表vfs下的tcp4/6存储文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _PATH_PROCNET_TCP		<span class="meta-string">"/proc/net/tcp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _PATH_PROCNET_TCP6		<span class="meta-string">"/proc/net/tcp6"</span></span></span><br></pre></td></tr></table></figure>

<p>剩下的tcp_do_one看上去像函数指针，猜测是在INFO_GUTS6中进行了调用，跟进<code>INFO_GUTS6</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define <span class="constructor">INFO_GUTS6(<span class="params">file</span>,<span class="params">file6</span>,<span class="params">name</span>,<span class="params">proc</span>,<span class="params">prot4</span>,<span class="params">prot6</span>)</span>	\</span><br><span class="line"> <span class="built_in">char</span> buffer<span class="literal">[<span class="number">8192</span>]</span>;					\</span><br><span class="line"> <span class="built_in">int</span> rc = <span class="number">0</span>;						\</span><br><span class="line"> <span class="built_in">int</span> lnr = <span class="number">0</span>;						\</span><br><span class="line"> <span class="keyword">if</span> (!flag_arg<span class="operator"> || </span>flag_inet) &#123;				\</span><br><span class="line">    <span class="constructor">INFO_GUTS1(<span class="params">file</span>,<span class="params">name</span>,<span class="params">proc</span>,<span class="params">prot4</span>)</span>			\</span><br><span class="line"> &#125;							\</span><br><span class="line"> <span class="keyword">if</span> (!flag_arg<span class="operator"> || </span>flag_inet6) &#123;				\</span><br><span class="line">    <span class="constructor">INFO_GUTS2(<span class="params">file6</span>,<span class="params">proc</span>,<span class="params">prot6</span>)</span>			\</span><br><span class="line"> &#125;							\</span><br><span class="line"> INFO_GUTS3</span><br></pre></td></tr></table></figure>

<p>这边是用的宏去定义函数，可以看到其根据数据包ipv4/ipv6协议类型分设了两条分支，这边只看ipv4，进入INFO_GUTS1：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define INFO_GUTS1(file,name,proc,prot)			\</span></span><br><span class="line">  procinfo = proc_fopen((file));			<span class="string">\</span></span><br><span class="line">  <span class="keyword">if</span> (procinfo == NULL) &#123;				<span class="string">\</span></span><br><span class="line">    <span class="keyword">if</span> (errno != ENOENT &amp;&amp; errno != EACCES) &#123;		<span class="string">\</span></span><br><span class="line">      perror((file));					<span class="string">\</span></span><br><span class="line">      <span class="keyword">return</span> -<span class="number">1</span>;					<span class="string">\</span></span><br><span class="line">    &#125;							<span class="string">\</span></span><br><span class="line">    <span class="keyword">if</span> (!flag_noprot &amp;&amp; (flag_arg || flag_ver))		<span class="string">\</span></span><br><span class="line">      ESYSNOT(<span class="string">"netstat"</span>, (name));			<span class="string">\</span></span><br><span class="line">    <span class="keyword">if</span> (!flag_noprot &amp;&amp; flag_arg)			<span class="string">\</span></span><br><span class="line">      rc = <span class="number">1</span>;						<span class="string">\</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;						<span class="string">\</span></span><br><span class="line">    <span class="keyword">do</span> &#123;						<span class="string">\</span></span><br><span class="line">      <span class="keyword">if</span> (fgets(buffer, sizeof(buffer), procinfo))	<span class="string">\</span></span><br><span class="line">        (proc)(lnr++, buffer,prot);			<span class="string">\</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!feof(procinfo));				<span class="string">\</span></span><br><span class="line">    fclose(procinfo);					<span class="string">\</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>同样是一个宏，首先利用proc_fopn获取/proc/net/tcp文件句柄，然后fgets读取文件中的每一行到8192字节的buffer中，<code>(proc)(lnr++, buffer,prot);</code>调用了INFO_GUTS6传入的tcp_do_one函数指针，将/proc/net/tcp中的每一行传入作为tcp_do_one的参数进行循环处理，猜测是对buffer进行内容进行解析。</p>
<p><strong>tcp_do_one</strong></p>
<p>首先贴下代码：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tcp_do_one</span><span class="params">(<span class="keyword">int</span> lnr, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">line</span>, <span class="keyword">const</span> <span class="keyword">char</span> *prot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rxq, txq, time_len, retr, inode;</span><br><span class="line">    <span class="keyword">int</span> num, local_port, rem_port, d, state, uid, timer_run, timeout;</span><br><span class="line">    <span class="keyword">char</span> rem_addr[<span class="number">128</span>], local_addr[<span class="number">128</span>], timers[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">aftype</span> *<span class="title">ap</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">localsas</span>, <span class="title">remsas</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">localaddr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)&amp;<span class="title">localsas</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">remaddr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)&amp;<span class="title">remsas</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_AFINET6</span></span><br><span class="line">    <span class="keyword">char</span> addr6[INET6_ADDRSTRLEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">in6</span>;</span></span><br><span class="line">    <span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">aftype</span> <span class="title">inet6_aftype</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">long</span> clk_tck = ticks_per_second();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lnr == <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    num = <span class="built_in">sscanf</span>(<span class="built_in">line</span>,</span><br><span class="line">    <span class="string">"%d: %64[0-9A-Fa-f]:%X %64[0-9A-Fa-f]:%X %X %lX:%lX %X:%lX %lX %d %d %lu %*s\n"</span>,</span><br><span class="line">		 &amp;d, local_addr, &amp;local_port, rem_addr, &amp;rem_port, &amp;state,</span><br><span class="line">		 &amp;txq, &amp;rxq, &amp;timer_run, &amp;time_len, &amp;retr, &amp;uid, &amp;timeout, &amp;inode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num &lt; <span class="number">11</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, _(<span class="string">"warning, got bogus tcp line.\n"</span>));</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!flag_all &amp;&amp; ((flag_lst &amp;&amp; rem_port) || (!flag_lst &amp;&amp; !rem_port)))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(local_addr) &gt; <span class="number">8</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_AFINET6</span></span><br><span class="line">	<span class="comment">/* Demangle what the kernel gives us */</span></span><br><span class="line">	<span class="built_in">sscanf</span>(local_addr, <span class="string">"%08X%08X%08X%08X"</span>,</span><br><span class="line">	       &amp;in6.s6_addr32[<span class="number">0</span>], &amp;in6.s6_addr32[<span class="number">1</span>],</span><br><span class="line">           &amp;in6.s6_addr32[<span class="number">2</span>], &amp;in6.s6_addr32[<span class="number">3</span>]);</span><br><span class="line">	inet_ntop(AF_INET6, &amp;in6, addr6, <span class="keyword">sizeof</span>(addr6));</span><br><span class="line">	inet6_aftype.input(<span class="number">1</span>, addr6, &amp;localsas);</span><br><span class="line">	<span class="built_in">sscanf</span>(rem_addr, <span class="string">"%08X%08X%08X%08X"</span>,</span><br><span class="line">	       &amp;in6.s6_addr32[<span class="number">0</span>], &amp;in6.s6_addr32[<span class="number">1</span>],</span><br><span class="line">	       &amp;in6.s6_addr32[<span class="number">2</span>], &amp;in6.s6_addr32[<span class="number">3</span>]);</span><br><span class="line">	inet_ntop(AF_INET6, &amp;in6, addr6, <span class="keyword">sizeof</span>(addr6));</span><br><span class="line">	inet6_aftype.input(<span class="number">1</span>, addr6, &amp;remsas);</span><br><span class="line">	localsas.ss_family = AF_INET6;</span><br><span class="line">	remsas.ss_family = AF_INET6;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="built_in">sscanf</span>(local_addr, <span class="string">"%X"</span>, &amp;localaddr-&gt;sin_addr.s_addr);</span><br><span class="line">	<span class="built_in">sscanf</span>(rem_addr, <span class="string">"%X"</span>, &amp;remaddr-&gt;sin_addr.s_addr);</span><br><span class="line">	localsas.ss_family = AF_INET;</span><br><span class="line">	remsas.ss_family = AF_INET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ap = get_afntype(localsas.ss_family)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, _(<span class="string">"netstat: unsupported address family %d !\n"</span>),</span><br><span class="line">		localsas.ss_family);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	addr_do_one(local_addr, <span class="keyword">sizeof</span>(local_addr), <span class="number">22</span>, ap, &amp;localsas, local_port, <span class="string">"tcp"</span>);</span><br><span class="line">	addr_do_one(rem_addr, <span class="keyword">sizeof</span>(rem_addr), <span class="number">22</span>, ap, &amp;remsas, rem_port, <span class="string">"tcp"</span>);</span><br><span class="line"></span><br><span class="line">	timers[<span class="number">0</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	<span class="keyword">if</span> (flag_opt)</span><br><span class="line">	    <span class="keyword">switch</span> (timer_run) &#123;</span><br><span class="line">	    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"off (0.00/%ld/%d)"</span>), retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"on (%2.2f/%ld/%d)"</span>),</span><br><span class="line">			 (<span class="keyword">double</span>) time_len / clk_tck, retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"keepalive (%2.2f/%ld/%d)"</span>),</span><br><span class="line">			 (<span class="keyword">double</span>) time_len / clk_tck, retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"timewait (%2.2f/%ld/%d)"</span>),</span><br><span class="line">			 (<span class="keyword">double</span>) time_len / clk_tck, retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"probe (%2.2f/%ld/%d)"</span>),</span><br><span class="line">			 (<span class="keyword">double</span>) time_len / clk_tck, retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">snprintf</span>(timers, <span class="keyword">sizeof</span>(timers), _(<span class="string">"unkn-%d (%2.2f/%ld/%d)"</span>),</span><br><span class="line">			 timer_run, (<span class="keyword">double</span>) time_len / clk_tck, retr, timeout);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%-4s  %6ld %6ld %-*s %-*s %-11s"</span>,</span><br><span class="line">	       prot, rxq, txq, (<span class="keyword">int</span>)netmax(<span class="number">23</span>,<span class="built_in">strlen</span>(local_addr)), local_addr, (<span class="keyword">int</span>)netmax(<span class="number">23</span>,<span class="built_in">strlen</span>(rem_addr)), rem_addr, _(tcp_state[state]));</span><br><span class="line"></span><br><span class="line">	finish_this_one(uid,inode,timers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>几个点，首先解析/proc/net/tcp文件中的每一行数据，将每个字段的数据赋值到不同变量：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num = sscanf(line,<span class="string">"%d: %64[0-9A-Fa-f]:%X %64[0-9A-Fa-f]:%X %X %lX:%lX %X:%lX %lX %d %d %lu %*s\n"</span>,</span><br><span class="line">&amp;d, local_addr, &amp;local_port, rem_addr, &amp;rem_port, &amp;<span class="keyword">state</span>,</span><br><span class="line">&amp;txq, &amp;rxq, &amp;timer_run, &amp;time_len, &amp;retr, &amp;uid, &amp;timeout, &amp;inode);</span><br></pre></td></tr></table></figure>

<p>其次针对local/remote address进行解析，将解析出的字符数组转为hex整形数据：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sscanf(<span class="name">local_addr</span>, <span class="string">"%X"</span>, <span class="symbol">&amp;localaddr-&gt;sin_addr</span>.s_addr)<span class="comment">;</span></span><br><span class="line">sscanf(<span class="name">rem_addr</span>, <span class="string">"%X"</span>, <span class="symbol">&amp;remaddr-&gt;sin_addr</span>.s_addr)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>再之后，adore_do_one函数，对addr及port进行操作：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">addr_do_one(<span class="name">local_addr</span>, sizeof(<span class="name">local_addr</span>), <span class="number">22</span>, ap, <span class="symbol">&amp;localsas</span>, local_port, <span class="string">"tcp"</span>)<span class="comment">;</span></span><br><span class="line">addr_do_one(<span class="name">rem_addr</span>, sizeof(<span class="name">rem_addr</span>), <span class="number">22</span>, ap, <span class="symbol">&amp;remsas</span>, rem_port, <span class="string">"tcp"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>跟进：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">static</span> void <span class="keyword">addr_do_one(char </span>*<span class="keyword">buf, </span>size_t <span class="keyword">buf_len, </span>size_t short_len, const <span class="keyword">struct </span>aftype *ap,</span><br><span class="line">			const <span class="keyword">struct </span>sockaddr_storage *<span class="keyword">addr,</span></span><br><span class="line"><span class="keyword">	</span>		int port, const char *proto</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    const char *sport, *<span class="keyword">saddr;</span></span><br><span class="line"><span class="keyword"> </span>   size_t port_len, <span class="keyword">addr_len;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">saddr </span>= ap-&gt;sprint(<span class="keyword">addr, </span>flag_not &amp; FLAG_NUM_HOST)<span class="comment">;</span></span><br><span class="line">    sport = get_sname(htons(port), proto, flag_not &amp; FLAG_NUM_PORT)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">addr_len </span>= <span class="keyword">strlen(saddr);</span></span><br><span class="line"><span class="keyword"> </span>   port_len = <span class="keyword">strlen(sport);</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">if</span> (!flag_wide &amp;&amp; (<span class="keyword">addr_len </span>+ port_len &gt; short_len)) &#123;</span><br><span class="line">	<span class="comment">/* Assume port name is short */</span></span><br><span class="line">	port_len = netmin(port_len, short_len - <span class="number">4</span>)<span class="comment">;</span></span><br><span class="line">	<span class="keyword">addr_len </span>= short_len - port_len<span class="comment">;</span></span><br><span class="line">	<span class="keyword">strncpy(buf, </span><span class="keyword">saddr, </span><span class="keyword">addr_len);</span></span><br><span class="line"><span class="keyword">	</span><span class="keyword">buf[addr_len] </span>= <span class="string">'\0'</span><span class="comment">;</span></span><br><span class="line">	<span class="keyword">strcat(buf, </span><span class="string">":"</span>)<span class="comment">;</span></span><br><span class="line">	<span class="keyword">strncat(buf, </span>sport, port_len)<span class="comment">;</span></span><br><span class="line">    &#125; <span class="meta">else</span></span><br><span class="line">	snprintf(<span class="keyword">buf, </span><span class="keyword">buf_len, </span><span class="string">"%s:%s"</span>, <span class="keyword">saddr, </span>sport)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现其addr和port进行拼接，比较有意思的一点是利用short_len对addr和port拼接后的长度进行限制，若长度超过23，且-W参数对应变量置位，则对addr进行截断显示。</p>
<p>最后对addr:port拼接后的数据及前面在/proc/net/tcp中解析出的字段进行输出：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(<span class="string">"%-4s  %6ld %6ld %-*s %-*s %-11s"</span>,prot, rxq, txq, (<span class="name">int</span>)netmax(<span class="number">23</span>,strlen(<span class="name">local_addr</span>)), local_addr, (<span class="name">int</span>)netmax(<span class="number">23</span>,strlen(<span class="name">rem_addr</span>)), rem_addr, _(<span class="name">tcp_state</span>[state]))<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>剩下的最后一个 <code>finish_this_one</code>函数，跟进分析后发现其主要是在以上的基础输出外检测变量是否置位，即参数使用情况来输出指定类型的数据栏目：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static void finish_this_one(<span class="name">int</span> uid, unsigned long inode, const char *timers)</span><br><span class="line">&#123;</span><br><span class="line">    struct passwd *pw<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    if (<span class="name">flag_exp</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">	if (!(<span class="name">flag_not</span> &amp; FLAG_NUM_USER) <span class="symbol">&amp;&amp;</span> ((<span class="name">pw</span> = getpwuid(<span class="name">uid</span>)) != NULL))</span><br><span class="line">	    printf(<span class="string">" %-10s "</span>, pw-&gt;pw_name)<span class="comment">;</span></span><br><span class="line">	else</span><br><span class="line">	    printf(<span class="string">" %-10d "</span>, uid)<span class="comment">;</span></span><br><span class="line">	printf(<span class="string">"%-10lu"</span>,inode)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    if (<span class="name">flag_prg</span>)</span><br><span class="line">	printf(<span class="string">" %-"</span> PROGNAME_WIDTHs <span class="string">"s"</span>,prg_cache_get(<span class="name">inode</span>))<span class="comment">;</span></span><br><span class="line">    if (<span class="name">flag_selinux</span>)</span><br><span class="line">	printf(<span class="string">" %-"</span> SELINUX_WIDTHs <span class="string">"s"</span>,prg_cache_get_con(<span class="name">inode</span>))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    if (<span class="name">flag_opt</span>)</span><br><span class="line">	printf(<span class="string">" %s"</span>, timers)<span class="comment">;</span></span><br><span class="line">    putchar('\n')<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中flag_exp、flag_prg、flag_selinux、flag_opt分别对应-e、-p、-Z、-o：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">	case <span class="string">'A'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(optarg))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'M'</span>:</span><br><span class="line">	    flag_mas++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'a'</span>:</span><br><span class="line">	    flag_all++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'l'</span>:</span><br><span class="line">	    flag_lst++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'c'</span>:</span><br><span class="line">	    flag_cnt++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	case <span class="string">'d'</span>:</span><br><span class="line">	    flag_deb++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'g'</span>:</span><br><span class="line">	    flag_igmp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'e'</span>:</span><br><span class="line">	    flag_exp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'p'</span>:</span><br><span class="line">	    flag_prg++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'i'</span>:</span><br><span class="line">	    flag_int++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'W'</span>:</span><br><span class="line">	    flag_wide++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'n'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'!'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_HOST;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'@'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_PORT;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'#'</span>:</span><br><span class="line">	    flag_not |= FLAG_NUM_USER;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'N'</span>:</span><br><span class="line">	    flag_not |= FLAG_SYM;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'C'</span>:</span><br><span class="line">	    flag_cf |= FLAG_CACHE;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'F'</span>:</span><br><span class="line">	    flag_cf |= FLAG_FIB;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'o'</span>:</span><br><span class="line">	    flag_opt++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'6'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"inet6"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'4'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"inet"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'V'</span>:</span><br><span class="line">	    version();</span><br><span class="line">	    <span class="regexp">/*NOTREACHED */</span></span><br><span class="line">	case <span class="string">'v'</span>:</span><br><span class="line">	    flag_ver |= FLAG_VERBOSE;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'r'</span>:</span><br><span class="line">	    flag_rou++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'t'</span>:</span><br><span class="line">	    flag_tcp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'S'</span>:</span><br><span class="line">	    flag_sctp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'u'</span>:</span><br><span class="line">	    flag_udp++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'U'</span>:</span><br><span class="line">	    flag_udplite++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'w'</span>:</span><br><span class="line">	    flag_raw++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'2'</span>:</span><br><span class="line">	    flag_l2cap++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'f'</span>:</span><br><span class="line">	    flag_rfcomm++;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'x'</span>:</span><br><span class="line">	    <span class="keyword">if</span> (aftrans_opt(<span class="string">"unix"</span>))</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	case <span class="string">'Z'</span>:</span><br><span class="line"><span class="comment">#if HAVE_SELINUX</span></span><br><span class="line">	    <span class="keyword">if</span> (is_selinux_enabled() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		fprintf(stderr, _(<span class="string">"SELinux is not enabled on this machine.\n"</span>));</span><br><span class="line">		<span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    flag_prg++;</span><br><span class="line">	    flag_selinux++;</span><br></pre></td></tr></table></figure>

<p>具体参数对应含义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">int</span> rc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp = rc ? <span class="built_in">stderr</span> : <span class="built_in">stdout</span>;</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"usage: netstat [-vWeenNcCF] [&lt;Af&gt;] -r         netstat &#123;-V|--version|-h|--help&#125;\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"       netstat [-vWnNcaeol] [&lt;Socket&gt; ...]\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"       netstat &#123; [-vWeenNac] -i | [-cnNe] -M | -s [-6tuw] &#125;\n\n"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -r, --route              display routing table\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -i, --interfaces         display interface table\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -g, --groups             display multicast group memberships\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -s, --statistics         display networking statistics (like SNMP)\n"</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_FW_MASQUERADE</span></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -M, --masquerade         display masqueraded connections\n\n"</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -v, --verbose            be verbose\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -W, --wide               don't truncate IP addresses\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -n, --numeric            don't resolve names\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        --numeric-hosts          don't resolve host names\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        --numeric-ports          don't resolve port names\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        --numeric-users          don't resolve user names\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -N, --symbolic           resolve hardware names\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -e, --extend             display other/more information\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -p, --programs           display PID/Program name for sockets\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -o, --timers             display timers\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -c, --continuous         continuous listing\n\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -l, --listening          display listening server sockets\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -a, --all                display all sockets (default: connected)\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -F, --fib                display Forwarding Information Base (default)\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -C, --cache              display routing cache instead of FIB\n"</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_SELINUX</span></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"        -Z, --context            display SELinux security context for sockets\n"</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"\n  &lt;Socket&gt;=&#123;-t|--tcp&#125; &#123;-u|--udp&#125; &#123;-U|--udplite&#125; &#123;-S|--sctp&#125; &#123;-w|--raw&#125;\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"           &#123;-x|--unix&#125; --ax25 --ipx --netrom\n"</span>));</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"  &lt;AF&gt;=Use '-6|-4' or '-A &lt;af&gt;' or '--&lt;af&gt;'; default: %s\n"</span>), DFLT_AF);</span><br><span class="line">    <span class="built_in">fprintf</span>(fp, _(<span class="string">"  List of possible address families (which support routing):\n"</span>));</span><br><span class="line">    print_aflist(<span class="number">1</span>); <span class="comment">/* 1 = routeable */</span></span><br><span class="line">    <span class="built_in">exit</span>(rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>else</strong></p>
<p>剩下的就是af_inet协议族下其它类型的socket解析及输出以及其它协议族的解析输出，类似tcp_info，尾部使用prg_cache_clear清理缓存链表，不再赘述。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    代码逻辑是非常清晰的，但是调试过程中发现mac下的ide的debug功能实在不是太友好，无法查看/修改整块的内存，数据的显示也和其本身格式不一致，以及单步过程中遇到了可视化界面中的光标位置和真实elf执行流程不匹配的问题，总体下来，感觉不是很灵活的样子，不止是vscode，clion也有这种问题；</p>
<p>​    正如spoock师傅所说的，netstat工具在网络进程频繁开关socket通道的环境中性能压力是很大的，联想到之前写的网络日志采集demo中有模块是复用了部分netstat源码，但是总体效果不是非常好，原因无他，遍历proc这块的io性能压力比较大，若放到实际业务环境中，如openstack这种大流量和进程频繁操作的云环境，业务影响之大可想而知；</p>
<p>​    </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># 源码分析</a>
              <a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" rel="tag"># 二进制</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/08/09/rootkit-sys-call-table-hook-learning/" rel="prev" title="rootkit sys_call_table hook learning">
                  <i class="fa fa-chevron-left"></i> rootkit sys_call_table hook learning
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/09/09/Rootkit-principle-analysis-and-behavior-detection/" rel="next" title="Rootkit principle analysis and behavior detection">
                  Rootkit principle analysis and behavior detection <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XDW</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>



    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  

</body>
</html>
