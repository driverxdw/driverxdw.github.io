<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic|Lobster+Two:300,300italic,400,400italic,700,700italic|EB+Garamond:300,300italic,400,400italic,700,700italic|Roboto+Slab:300,300italic,400,400italic,700,700italic|Source+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"driverxdw.github.io","root":"/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="一、起源yulong-hids可以说是国内第一个比较成熟的开源hids项目，虽说项目已经发布很久，但直到几个月前才想着去学习一下其技术原理，主要是之前这块的研究需求不是很高，而且环境搭建过程较为复杂，没有一键化的脚本，自己手搭受挫了几次随即没了兴致（捂脸），最近心血来潮又来玩了一遍终于搭成功了（捂脸），果然还是成长了吗（&#x2F;&#x2F;雾）">
<meta property="og:type" content="article">
<meta property="og:title" content="Yulong-Hids架构设计与功能原理分析">
<meta property="og:url" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="in0va&#39;S Blog  JustLearnM0re">
<meta property="og:description" content="一、起源yulong-hids可以说是国内第一个比较成熟的开源hids项目，虽说项目已经发布很久，但直到几个月前才想着去学习一下其技术原理，主要是之前这块的研究需求不是很高，而且环境搭建过程较为复杂，没有一键化的脚本，自己手搭受挫了几次随即没了兴致（捂脸），最近心血来潮又来玩了一遍终于搭成功了（捂脸），果然还是成长了吗（&#x2F;&#x2F;雾）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020221739747.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020223936155.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020224837799.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020225211462.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020230009865.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020230244071.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/jg.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021105112153.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021112728528.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021174332979.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021174837323.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021175031736.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021175143860.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021175514821.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021175932368.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021190200612.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021190248527.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021191240242.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021191457781.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022101107922.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021192848216.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021193030185.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021193119756.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201021193203519.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022120401573.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022120423447.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022120739280.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022121056325.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201022121152354.png">
<meta property="article:published_time" content="2020-10-20T12:54:32.000Z">
<meta property="article:modified_time" content="2020-10-22T06:25:18.756Z">
<meta property="article:author" content="XDW">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="二进制">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/image-20201020221739747.png">


<link rel="canonical" href="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Yulong-Hids架构设计与功能原理分析 | in0va'S Blog  JustLearnM0re</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">in0va'S Blog  JustLearnM0re</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">犯二</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">63</span></a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、起源"><span class="nav-number">1.</span> <span class="nav-text">一、起源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、功能"><span class="nav-number">2.</span> <span class="nav-text">二、功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、架构"><span class="nav-number">3.</span> <span class="nav-text">三、架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Agent"><span class="nav-number">3.1.</span> <span class="nav-text">Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Daemon"><span class="nav-number">3.2.</span> <span class="nav-text">Daemon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Server"><span class="nav-number">3.3.</span> <span class="nav-text">Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database"><span class="nav-number">3.4.</span> <span class="nav-text">Database</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Web"><span class="nav-number">3.5.</span> <span class="nav-text">Web</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、实现"><span class="nav-number">4.</span> <span class="nav-text">四、实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码结构"><span class="nav-number">4.1.</span> <span class="nav-text">源码结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Agent-1"><span class="nav-number">4.2.</span> <span class="nav-text">Agent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main"><span class="nav-number">4.2.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#client"><span class="nav-number">4.2.2.</span> <span class="nav-text">client</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor"><span class="nav-number">4.2.3.</span> <span class="nav-text">monitor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#collect"><span class="nav-number">4.2.4.</span> <span class="nav-text">collect</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Daemon-1"><span class="nav-number">4.3.</span> <span class="nav-text">Daemon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main-1"><span class="nav-number">4.3.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#task"><span class="nav-number">4.3.2.</span> <span class="nav-text">task</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Server-1"><span class="nav-number">4.4.</span> <span class="nav-text">Server</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main-2"><span class="nav-number">4.4.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#models"><span class="nav-number">4.4.2.</span> <span class="nav-text">models</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#action"><span class="nav-number">4.4.3.</span> <span class="nav-text">action</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#safecheck"><span class="nav-number">4.4.4.</span> <span class="nav-text">safecheck</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Database-1"><span class="nav-number">4.5.</span> <span class="nav-text">Database</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mongodb"><span class="nav-number">4.5.1.</span> <span class="nav-text">mongodb</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#es"><span class="nav-number">4.5.2.</span> <span class="nav-text">es</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Web-1"><span class="nav-number">4.6.</span> <span class="nav-text">Web</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、问题"><span class="nav-number">5.</span> <span class="nav-text">五、问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、总结"><span class="nav-number">6.</span> <span class="nav-text">六、总结</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XDW"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">XDW</p>
  <div class="site-description" itemprop="description">一枚很菜但是仍在学习的二进制菜逼</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.ixuchao.cn/" title="https:&#x2F;&#x2F;blog.ixuchao.cn&#x2F;" rel="noopener" target="_blank">Archerx's Blog</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://driverxdw.github.io/2020/10/20/Yulong-Hids%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%8A%9F%E8%83%BD%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="XDW">
      <meta itemprop="description" content="一枚很菜但是仍在学习的二进制菜逼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="in0va'S Blog  JustLearnM0re">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Yulong-Hids架构设计与功能原理分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-20 20:54:32" itemprop="dateCreated datePublished" datetime="2020-10-20T20:54:32+08:00">2020-10-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-10-22 14:25:18" itemprop="dateModified" datetime="2020-10-22T14:25:18+08:00">2020-10-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="一、起源"><a href="#一、起源" class="headerlink" title="一、起源"></a>一、起源</h2><p>yulong-hids可以说是国内第一个比较成熟的开源hids项目，虽说项目已经发布很久，但直到几个月前才想着去学习一下其技术原理，主要是之前这块的研究需求不是很高，而且环境搭建过程较为复杂，没有一键化的脚本，自己手搭受挫了几次随即没了兴致（捂脸），最近心血来潮又来玩了一遍终于搭成功了（捂脸），果然还是成长了吗（//雾）</p>
<a id="more"></a>

<h2 id="二、功能"><a href="#二、功能" class="headerlink" title="二、功能"></a>二、功能</h2><p>yulong-hids拥有的主要功能模块如下：</p>
<p>1、统计信息</p>
<p><img src="./image-20201020221739747.png" alt="image-20201020221739747"></p>
<p>此模块为产品的展示面板模块，首先包括主机数（agent）、告警数、任务数、服务器数（server）、数据总数（信息/行为）这些重要项的数量展示，其次是告警的图表展示，包括告警日期分布折线图、告警类型分布统计饼状图（告警类型为规则名）、告警数量时间分布柱状图及告警信息展示top8（按次序排列）</p>
<p>2、主机列表</p>
<p><img src="./image-20201020223936155.png" alt="image-20201020223936155"></p>
<p>此模块为agent管理模块，方便用户监控安装agent的主机行为（进程、文件、网络等）并支持agent下载安装</p>
<p>3、数据分析</p>
<p><img src="./image-20201020224837799.png" alt="image-20201020224837799"></p>
<p>此模块为溯源模块，可以从es中快速查询关键词显示，支持简单的搜索语法</p>
<p>4、告警</p>
<p><img src="./image-20201020225211462.png" alt="image-20201020225211462"></p>
<p>显示全量告警，支持自动溯源和处置响应（进程、文件、网络），允许手动变更事件状态（未处理、已处理、忽略）并支持加白/加黑处理</p>
<p>5、任务</p>
<p><img src="./image-20201020230009865.png" alt="image-20201020230009865"></p>
<p>允许用户在server端自定义一些任务下发给agent，任务指令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kill</span>: 结束进程(传入进程名)</span><br><span class="line"><span class="keyword">uninstall</span>: 卸载自身</span><br><span class="line"><span class="keyword">update</span>: <span class="keyword">Agent</span>更新</span><br><span class="line"><span class="keyword">delete</span>: 文件删除(传入文件路径)</span><br><span class="line">exec: 自定义命令 (发布的<span class="keyword">release</span>不支持这个功能，如需这个功能，请去掉注释，自行编译<span class="keyword">agent</span>)</span><br><span class="line">reload: 重启<span class="keyword">Agent</span></span><br><span class="line">quit: 结束自身</span><br></pre></td></tr></table></figure>



<p>6、规则引擎</p>
<p><img src="./image-20201020230244071.png" alt="image-20201020230244071"></p>
<p>此模块自己实现了一套简单的规则引擎对事件进行过滤和匹配规则，支持server控制台编写、导出、修改（编辑）规则，支持已有规则的细粒度控制（开/关）</p>
<p>7、设置</p>
<p>此模块可通过修改配置影响agent及server处理</p>
<h2 id="三、架构"><a href="#三、架构" class="headerlink" title="三、架构"></a>三、架构</h2><p><img src="./jg.png" alt="jg"></p>
<p>以上为yulong的整体架构图，具体说明如下：</p>
<h3 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h3><p>agent为主机端探针，主要负责行为监控、信息收集、数据处理、事件上传功能，具体说明如下：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">信息收集：收集主机开启启动项、计划任务、监听端口、服务、登陆日志、用户列表等静态文件</span><br><span class="line">行为监控：收集主机行为数据，包括进程行为、文件行为、网络行为，三种信息收集方式分别为</span><br><span class="line">	进程监控：lkm hook（execve）（agent监控本地udp65530接收进程信息）</span><br><span class="line">	文件监控：inotify</span><br><span class="line">	网络监控：libpcap</span><br><span class="line">数据处理：对收集的信息在格式化前进行简单的过滤和筛选处理</span><br><span class="line">事件上传：将处理后的数据组成特定格式以事件形式通过rpc服务上传给<span class="keyword">server</span>，由<span class="keyword">server</span>进行规则解析和处理</span><br></pre></td></tr></table></figure>

<h3 id="Daemon"><a href="#Daemon" class="headerlink" title="Daemon"></a>Daemon</h3><p>daemon为agent的守护进程，负责agent热更新、进程守护、静默部署、服务指令接收等功能，具体说明如下：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">热更新：支持部署hids的主机自动从<span class="keyword">server</span>下载更新agent</span><br><span class="line">进程守护：注册daemon为服务，agent线程退出后daemon负责重启</span><br><span class="line">静默部署：后台静默安装</span><br><span class="line">服务指令接收：开放<span class="number">65512</span>端口用于接收<span class="keyword">server</span>端下发的指令任务</span><br></pre></td></tr></table></figure>

<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>server主要用于agent数据接收、数据分析、安全检测、任务下发及结果保存，具体说明如下：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">数据接收：<span class="keyword">server</span>在<span class="number">33433</span>端口部署rpc服务来接收所有agent上传的监控事件并回传agent获取配置请求结果（getinfo、putinfo）</span><br><span class="line">数据分析：自动化溯源功能，<span class="keyword">server</span>根据控制台规则去es索引数据并在web渲染显示</span><br><span class="line">安全检测：利用自实现规则引擎对接收到的agent事件进行规则匹配，匹配结果入库（mongodb）</span><br><span class="line">结果保存：安全检测结果入库（mongodb），全量行为事件（file、process、loginlog、<span class="keyword">connection</span>）入es</span><br><span class="line">任务下发：web控制台上新建任务会由web后端响应并通过<span class="number">65512</span>端口将任务以特定数据格式下发给daemon并接收执行返回结果信息</span><br></pre></td></tr></table></figure>

<h3 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h3><p>yulong这块的database主要包含es、mongodb两个平台，es主要为溯源使用，mongodb则保存一些配置及具体任务、规则等静态信息，具体说明如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">es：</span><br><span class="line"><span class="number">1</span>、保存agent监控到的全量主机行为事件（file、process、loginlog、connection）</span><br><span class="line"><span class="number">2</span>、server的数据分析功能会从es中拉数据</span><br><span class="line">mongodb：</span><br><span class="line"><span class="number">1</span>、web端的任务新建、规则修改等动作会由web后端响应并修改mongodb相关库表（增删改查）</span><br><span class="line"><span class="number">2</span>、web前端的动作生效后，server可以从mongodb中获取变更的配置、任务、规则等</span><br><span class="line"><span class="number">3</span>、agent通过rpc调用利用server读写mongo</span><br><span class="line"><span class="number">4</span>、server根据数据分析结果增删改查mongo</span><br></pre></td></tr></table></figure>

<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><p>web主要负责集中管理、安全分析、警报处理、配置等项，功能基本可以在web前端看到，不再赘述；后端等后续填坑</p>
<h2 id="四、实现"><a href="#四、实现" class="headerlink" title="四、实现"></a>四、实现</h2><h3 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">├─agent <span class="comment">// Agent工程</span></span><br><span class="line">│  ├─<span class="keyword">client</span> <span class="comment">// RPC client 传输模块</span></span><br><span class="line">│  ├─<span class="keyword">common</span></span><br><span class="line">│  ├─collect <span class="comment">// 信息收集（开机启动项、计划任务、监听端口、服务、登录日志、用户列表）</span></span><br><span class="line">│  └─monitor <span class="comment">// 行为监控（文件操作、网络连接、执行命令）</span></span><br><span class="line">├─bin</span><br><span class="line">│  ├─linux<span class="number">-64</span> <span class="comment">// Linux 64位的依赖包</span></span><br><span class="line">│  ├─win<span class="number">-32</span> <span class="comment">// Windows 32位的依赖包</span></span><br><span class="line">│  └─win<span class="number">-64</span> <span class="comment">// Windows 64位的依赖包</span></span><br><span class="line">├─daemon <span class="comment">// Daemon工程</span></span><br><span class="line">│  ├─<span class="keyword">common</span></span><br><span class="line">│  ├─install <span class="comment">// 安装Agent和相关依赖</span></span><br><span class="line">│  └─task <span class="comment">// 任务接收</span></span><br><span class="line">├─docs <span class="comment">// 说明文档</span></span><br><span class="line">├─driver <span class="comment">// Windows 命令监控驱动</span></span><br><span class="line">├─<span class="keyword">server</span> <span class="comment">// Server节点工程</span></span><br><span class="line">│  ├─action <span class="comment">// Server基本功能</span></span><br><span class="line">│  ├─models <span class="comment">// 数据库相关</span></span><br><span class="line">│  └─safecheck <span class="comment">// 安全检测模块（黑白名单，规则解析引擎）</span></span><br><span class="line">├─syscall_hook <span class="meta"># 监控执行命令的Linux内核代码</span></span><br><span class="line">│  └─test_bench <span class="comment">// 方便调试的</span></span><br><span class="line">└─web <span class="comment">// Web控制台项目</span></span><br><span class="line">    ├─conf <span class="comment">// web端配置文件</span></span><br><span class="line">    ├─controllers <span class="comment">// 控制器，负责转发请求，对请求进行处理</span></span><br><span class="line">    ├─httpscert <span class="comment">// https证书和RSA私钥，内置的会在向导过程中自动更新</span></span><br><span class="line">    ├─models <span class="comment">// 模型，数据管理和数据库设计</span></span><br><span class="line">    ├─routers <span class="comment">// 路由</span></span><br><span class="line">    ├─settings <span class="comment">// 部分全局变量</span></span><br><span class="line">    ├─<span class="keyword">static</span> <span class="comment">// 静态文件</span></span><br><span class="line">    ├─upload_files <span class="comment">// agent、daemon、依赖包文件</span></span><br><span class="line">    ├─utils <span class="comment">// 功能模块</span></span><br><span class="line">    └─views <span class="comment">// 视图层，前端模板</span></span><br></pre></td></tr></table></figure>

<h3 id="Agent-1"><a href="#Agent-1" class="headerlink" title="Agent"></a>Agent</h3><h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p>从agent.go中的main开始看起：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">func ma<span class="meta">in(</span>) &#123;</span><br><span class="line">	<span class="meta">if</span> l<span class="meta">en(</span>os.Args) &lt;= 1 &#123;</span><br><span class="line">		fmt.Print<span class="meta">ln(</span><span class="string">"Usage: agent[.exe] ServerIP [debug]"</span>)</span><br><span class="line">		fmt.Print<span class="meta">ln(</span><span class="string">"Example: agent 8.8.8.8 debug"</span>)</span><br><span class="line">		<span class="meta">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">if</span> runtime.GOOS == <span class="string">"linux"</span> &#123;</span><br><span class="line">		<span class="meta">out</span>, _ := common.CmdExec(fmt.Sprintf(<span class="string">"lsmod|grep syshook_execve"</span>))</span><br><span class="line">		<span class="meta">if</span> <span class="meta">out</span> == <span class="string">""</span> &#123;</span><br><span class="line">			common.CmdExec(fmt.Sprintf(<span class="string">"insmod %s/syshook_execve.ko"</span>, common.InstallPath))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	var agent client.Agent</span><br><span class="line">	agent.ServerNetLoc = os.Args[1]</span><br><span class="line">	<span class="meta">if</span> l<span class="meta">en(</span>os.Args) == 3 <span class="variable">&amp;&amp;</span> os.Args[2] == <span class="string">"debug"</span> &#123;</span><br><span class="line">		log.Print<span class="meta">ln(</span><span class="string">"DEBUG MODE"</span>)</span><br><span class="line">		agent.IsDebug = true</span><br><span class="line">	&#125;</span><br><span class="line">	agent.R<span class="meta">un(</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先检测参数数量，要求参数至少有两个，逻辑上要求参数之一必须是server所在ip，但这边有个bug，没有校验os.Args[1]的格式，导致如果第一个参数为debug，agent将无法启动：</p>
<p><img src="./image-20201021105112153.png" alt="image-20201021105112153"></p>
<p>继续往下看，之后检测运行环境是否是linux，若是，调go的exec函数执行bash命令检测进程监控所用的lkm模块（syshook_execve）是否已经加载，若加载，继续后续流程，若未加载，则调insmod加载，加载的内核模块路径在daemon模块中的common.go中指定为/usr/yulong-hids，daemon会负责agent运行环境的依赖检测和内核模块的编译及放置在指定位置等，这个之后再详述；</p>
<p>检测是否开启debug模式，若是，则给全局结构体agent的IsDebug状态位置true，之后调用agent.Run()正式启动agent</p>
<h4 id="client"><a href="#client" class="headerlink" title="client"></a>client</h4><p>现在控制流到了client模块</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run 启动agent</span></span><br><span class="line"><span class="selector-tag">func</span> (a *Agent) <span class="selector-tag">Run</span>() &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// agent 初始化</span></span><br><span class="line">	<span class="comment">// 请求Web API，获取Server地址，初始化RPC客户端，获取客户端IP等</span></span><br><span class="line">	<span class="selector-tag">a</span><span class="selector-class">.init</span>()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每隔一段时间更新初始化配置</span></span><br><span class="line">	<span class="selector-tag">a</span><span class="selector-class">.configRefresh</span>()</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 开启各个监控流程 文件监控，网络监控，进程监控</span></span><br><span class="line">	<span class="selector-tag">a</span><span class="selector-class">.monitor</span>()</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 每隔一段时间获取系统信息</span></span><br><span class="line">	<span class="comment">// 监听端口，服务信息，用户信息，开机启动项，计划任务，登录信息，进程列表等</span></span><br><span class="line">	<span class="selector-tag">a</span><span class="selector-class">.getInfo</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>run函数功能划分在注释中已经说的很清楚了，分别进入每一个模块：</p>
<p><strong>init</strong></p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">func (a *Agent) init() &#123;</span><br><span class="line">	a.ServerList, <span class="built_in">err</span> = a.getServerList()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">err</span> != nil &#123;</span><br><span class="line">		a.<span class="built_in">log</span>(<span class="string">"GetServerList error:"</span>, <span class="built_in">err</span>)</span><br><span class="line">		panic(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	a.ctx = context.WithValue(context.Background(), share.ReqMetaDataKey, make(map[<span class="built_in">string</span>]<span class="built_in">string</span>))</span><br><span class="line">	a.<span class="built_in">log</span>(<span class="string">"Available server node:"</span>, a.ServerList)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(a.ServerList) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">time</span>.Sleep(<span class="built_in">time</span>.<span class="built_in">Second</span> * <span class="number">30</span>)</span><br><span class="line">		a.<span class="built_in">log</span>(<span class="string">"No server node available"</span>)</span><br><span class="line">		panic(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	a.newClient()</span><br><span class="line">	<span class="keyword">if</span> common.LocalIP == <span class="string">""</span> &#123;</span><br><span class="line">		a.<span class="built_in">log</span>(<span class="string">"Can not get local address"</span>)</span><br><span class="line">		panic(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	a.Mutex = <span class="keyword">new</span>(sync.Mutex)</span><br><span class="line">	<span class="built_in">err</span> := a.Client.<span class="keyword">Call</span>(a.ctx, <span class="string">"GetInfo"</span>, &amp;common.ServerInfo, &amp;common.Config)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">err</span> != nil &#123;</span><br><span class="line">		a.<span class="built_in">log</span>(<span class="string">"RPC Client Call Error:"</span>, <span class="built_in">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">		panic(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	a.<span class="built_in">log</span>(<span class="string">"Common Client Config:"</span>, common.Config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先寻找server地址，相关逻辑在getServerList函数中，如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a Agent)</span> <span class="title">getServerList</span><span class="params">()</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> serlist []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> url <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> TESTMODE &#123;</span><br><span class="line">		url = <span class="string">"http://"</span> + a.ServerNetLoc + SERVER_API</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		url = <span class="string">"https://"</span> + a.ServerNetLoc + SERVER_API</span><br><span class="line">	&#125;</span><br><span class="line">	a.log(<span class="string">"Web API:"</span>, url)</span><br><span class="line">	request, _ := http.NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line">	request.Close = <span class="literal">true</span></span><br><span class="line">	resp, err := httpClient.Do(request)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">	result, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	err = json.Unmarshal([]<span class="keyword">byte</span>(result), &amp;serlist)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> serlist, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a.ServerNetLoc其实就是agent启动参数中用户指定的serverip，SERVER_API在client中config.go中定义为/json/serverlist，二者拼接之后向server发送请求，返回结果为serverip:port的列表格式，此处暂时不考虑server集群的情况</p>
<p><img src="./image-20201021112728528.png" alt="image-20201021112728528"></p>
<p>对getServerList的结果进行异常处理之后进入newclient模块</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">func (<span class="name">a</span> *Agent) newClient() &#123;</span><br><span class="line">	var servers []*client.KVPair</span><br><span class="line">	for _, server <span class="symbol">:=</span> range a.ServerList &#123;</span><br><span class="line">		common.ServerIPList = append(<span class="name">common</span>.ServerIPList, strings.Split(<span class="name">server</span>, <span class="string">":"</span>)[<span class="number">0</span>])</span><br><span class="line">		s <span class="symbol">:=</span> client.KVPair&#123;Key: server&#125;</span><br><span class="line">		servers = append(<span class="name">servers</span>, <span class="symbol">&amp;s</span>)</span><br><span class="line">		if common.LocalIP == <span class="string">""</span> &#123;</span><br><span class="line">			a.setLocalIP(<span class="name">server</span>)</span><br><span class="line">			common.ServerInfo = collect.GetComInfo()</span><br><span class="line">			a.log(<span class="string">"Host Information:"</span>, common.ServerInfo)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	conf <span class="symbol">:=</span> <span class="symbol">&amp;tls</span>.Config&#123;</span><br><span class="line">		InsecureSkipVerify: true,</span><br><span class="line">	&#125;</span><br><span class="line">	option <span class="symbol">:=</span> client.DefaultOption</span><br><span class="line">	option.TLSConfig = conf</span><br><span class="line">	serverd <span class="symbol">:=</span> client.NewMultipleServersDiscovery(<span class="name">servers</span>)</span><br><span class="line">	a.Client = client.NewXClient(<span class="string">"Watcher"</span>, FAILMODE, client.RandomSelect, serverd, option)</span><br><span class="line">	a.Client.Auth(<span class="name">AUTH_TOKEN</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newclient模块主要负责获取部署agent所在主机的相关信息以及部分配置信息，获取项在agent/common/common.go中</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> ClientConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Cycle  int    <span class="comment">// 信息传输频率，单位：分钟</span></span><br><span class="line">	UDP    <span class="keyword">bool</span>   <span class="comment">// 是否记录UDP请求</span></span><br><span class="line">	LAN    <span class="keyword">bool</span>   <span class="comment">// 是否本地网络请求</span></span><br><span class="line">	Mode   <span class="keyword">string</span> <span class="comment">// 模式，考虑中</span></span><br><span class="line">	Filter <span class="keyword">struct</span> &#123;</span><br><span class="line">		File    []<span class="keyword">string</span> <span class="comment">// 文件hash、文件名</span></span><br><span class="line">		IP      []<span class="keyword">string</span> <span class="comment">// IP地址</span></span><br><span class="line">		Process []<span class="keyword">string</span> <span class="comment">// 进程名、参数</span></span><br><span class="line">	&#125; <span class="comment">// 直接过滤不回传的规则</span></span><br><span class="line">	MonitorPath []<span class="keyword">string</span> <span class="comment">// 监控目录列表</span></span><br><span class="line">	Lasttime    <span class="keyword">string</span>   <span class="comment">// 最后一条登录日志时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ComputerInfo 计算机信息结构</span></span><br><span class="line"><span class="built_in">type</span> ComputerInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">	IP       <span class="keyword">string</span>   <span class="comment">// IP地址</span></span><br><span class="line">	<span class="keyword">System</span>   <span class="keyword">string</span>   <span class="comment">// 操作系统</span></span><br><span class="line">	Hostname <span class="keyword">string</span>   <span class="comment">// 计算机名</span></span><br><span class="line">	<span class="built_in">Type</span>     <span class="keyword">string</span>   <span class="comment">// 服务器类型</span></span><br><span class="line">	Path     []<span class="keyword">string</span> <span class="comment">// WEB目录</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> (</span><br><span class="line">	<span class="comment">// Config 配置信息</span></span><br><span class="line">	Config ClientConfig</span><br><span class="line">	<span class="comment">// LocalIP 本机活跃IP</span></span><br><span class="line">	LocalIP <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// ServerInfo 主机相关信息</span></span><br><span class="line">	ServerInfo ComputerInfo</span><br><span class="line">	<span class="comment">// ServerIPList 服务端列表</span></span><br><span class="line">	ServerIPList []<span class="keyword">string</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>获取主机相关信息后调用rpc_getinfo去server初步拉配置，具体配置项在server模块中有说明：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> common<span class="selector-class">.LocalIP</span> == <span class="string">""</span> &#123;</span><br><span class="line">	<span class="selector-tag">a</span>.log(<span class="string">"Can not get local address"</span>)</span><br><span class="line">	panic(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.Mutex</span> = new(sync.Mutex)</span><br><span class="line">err := <span class="selector-tag">a</span><span class="selector-class">.Client</span>.Call(<span class="selector-tag">a</span><span class="selector-class">.ctx</span>, <span class="string">"GetInfo"</span>, &amp;common<span class="selector-class">.ServerInfo</span>, &amp;common.Config)</span><br><span class="line"><span class="keyword">if</span> err != nil &#123;</span><br><span class="line">	<span class="selector-tag">a</span>.log(<span class="string">"RPC Client Call Error:"</span>, err.Error())</span><br><span class="line">	panic(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">a</span>.log(<span class="string">"Common Client Config:"</span>, common.Config</span><br></pre></td></tr></table></figure>

<p><strong>configRefresh</strong></p>
<p>起一个线程，每60s调一次rpc_getinfo去数据库拉一次配置，保证控制台配置变更后尽快生效：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> (<span class="selector-tag">a</span> *<span class="selector-tag">Agent</span>) <span class="selector-tag">configRefresh</span>() &#123;</span><br><span class="line">	<span class="attribute">ticker </span>:= time.<span class="built_in">NewTicker</span>(time.Second * time.Duration(CONFIGR_REF_INTERVAL))</span><br><span class="line">	go <span class="built_in">func</span>() &#123;</span><br><span class="line">		for _ = range ticker.C &#123;</span><br><span class="line">			ch := <span class="built_in">make</span>(chan bool)</span><br><span class="line">			go <span class="built_in">func</span>() &#123;</span><br><span class="line">				err = a.Client.<span class="built_in">Call</span>(a.ctx, <span class="string">"GetInfo"</span>, &amp;common.ServerInfo, &amp;common.Config)</span><br><span class="line">				if err != nil &#123;</span><br><span class="line">					a.<span class="built_in">log</span>(<span class="string">"RPC Client Call:"</span>, err.Error())</span><br><span class="line">					return</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="selector-tag">ch</span> &lt;<span class="selector-tag">-</span> <span class="selector-tag">true</span></span><br><span class="line">			&#125;()</span><br></pre></td></tr></table></figure>

<p><strong>monitor</strong></p>
<p>monitor函数主要用于agent所在主机的行为监控，可以看到monitor调用agent/monitor/中的函数起了三个线程，看函数名可知分别为网络嗅探、进程监控、文件监控，跟进monitor模块分析；行为监控的结果调rpc_putinfo上传server处理：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> (<span class="selector-tag">a</span> *<span class="selector-tag">Agent</span>) <span class="selector-tag">monitor</span>() &#123;</span><br><span class="line">	<span class="attribute">resultChan </span>:= <span class="built_in">make</span>(chan map[string]string, <span class="number">16</span>)</span><br><span class="line">	go monitor.<span class="built_in">StartNetSniff</span>(resultChan)</span><br><span class="line">	go monitor.<span class="built_in">StartProcessMonitor</span>(resultChan)</span><br><span class="line">	go monitor.<span class="built_in">StartFileMonitor</span>(resultChan)</span><br><span class="line">	go <span class="built_in">func</span>(result chan map[string]string) &#123;</span><br><span class="line">		var resultdata []map[string]string</span><br><span class="line">		var data map[string]string</span><br><span class="line">		for &#123;</span><br><span class="line">			data = &lt;-result</span><br><span class="line">			data[<span class="string">"time"</span>] = fmt.<span class="built_in">Sprintf</span>(<span class="string">"%d"</span>, time.Now().<span class="built_in">Unix</span>())</span><br><span class="line">			a.<span class="built_in">log</span>(<span class="string">"Monitor data: "</span>, data)</span><br><span class="line">			source := data[<span class="string">"source"</span>]</span><br><span class="line">			<span class="built_in">delete</span>(data, <span class="string">"source"</span>)</span><br><span class="line">			a.Mutex.<span class="built_in">Lock</span>()</span><br><span class="line">			a.PutData = dataInfo&#123;common.LocalIP, source, runtime.GOOS, <span class="built_in">append</span>(resultdata, data)&#125;</span><br><span class="line">			<span class="selector-tag">a</span><span class="selector-class">.put</span>()</span><br><span class="line">			<span class="selector-tag">a</span><span class="selector-class">.Mutex</span><span class="selector-class">.Unlock</span>()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(<span class="selector-tag">resultChan</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func (<span class="selector-tag">a</span> Agent) put() &#123;</span><br><span class="line">	_, err := <span class="selector-tag">a</span><span class="selector-class">.Client</span>.Go(<span class="selector-tag">a</span><span class="selector-class">.ctx</span>, <span class="string">"PutInfo"</span>, &amp;<span class="selector-tag">a</span><span class="selector-class">.PutData</span>, &amp;<span class="selector-tag">a</span><span class="selector-class">.Reply</span>, nil)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="selector-tag">a</span>.log(<span class="string">"PutInfo error:"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h4><p><strong>StartNetSniff</strong></p>
<p>先贴下代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartNetSniff</span><span class="params">(resultChan <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> pkt *pcap.Packet</span><br><span class="line">	<span class="keyword">var</span> resultdata <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	h, err := getPcapHandle(common.LocalIP)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		pkt = h.Next()</span><br><span class="line">		<span class="keyword">if</span> pkt == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		pkt.Decode()</span><br><span class="line">		<span class="keyword">var</span> port <span class="keyword">int</span></span><br><span class="line">		<span class="keyword">var</span> ip <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">var</span> localPort <span class="keyword">int</span></span><br><span class="line">		resultdata = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">			<span class="string">"source"</span>:   <span class="string">""</span>,</span><br><span class="line">			<span class="string">"dir"</span>:      <span class="string">""</span>,</span><br><span class="line">			<span class="string">"protocol"</span>: <span class="string">""</span>,</span><br><span class="line">			<span class="string">"remote"</span>:   <span class="string">""</span>,</span><br><span class="line">			<span class="string">"local"</span>:    <span class="string">""</span>,</span><br><span class="line">			<span class="string">"pid"</span>:      <span class="string">""</span>,</span><br><span class="line">			<span class="string">"name"</span>:     <span class="string">""</span>,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//不记录跟安全中心的连接记录</span></span><br><span class="line">		<span class="keyword">if</span> pkt.IP != <span class="literal">nil</span> &amp;&amp; (common.LocalIP == pkt.IP.SrcAddr() || common.LocalIP == pkt.IP.DestAddr()) &amp;&amp;</span><br><span class="line">			!common.InArray(common.ServerIPList, pkt.IP.SrcAddr(), <span class="literal">false</span>) &amp;&amp;</span><br><span class="line">			!common.InArray(common.ServerIPList, pkt.IP.DestAddr(), <span class="literal">false</span>) &#123;</span><br><span class="line">			resultdata[<span class="string">"source"</span>] = <span class="string">"connection"</span></span><br><span class="line">			<span class="keyword">if</span> common.LocalIP == pkt.IP.SrcAddr() &#123;</span><br><span class="line">				ip = pkt.IP.DestAddr()</span><br><span class="line">				resultdata[<span class="string">"dir"</span>] = <span class="string">"out"</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				ip = pkt.IP.SrcAddr()</span><br><span class="line">				resultdata[<span class="string">"dir"</span>] = <span class="string">"in"</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> common.ServerInfo.Type == <span class="string">"web"</span> &amp;&amp; resultdata[<span class="string">"dir"</span>] == <span class="string">"in"</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//如果内网记录为关闭则进行IP判断</span></span><br><span class="line">			<span class="keyword">if</span> !common.Config.LAN &amp;&amp; isLan(ip) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//白名单</span></span><br><span class="line">			<span class="keyword">if</span> common.InArray(common.Config.Filter.IP, ip, <span class="literal">false</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> pkt.IP.Protocol == UDP &#123;</span><br><span class="line">				<span class="keyword">if</span> common.Config.UDP == <span class="literal">false</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				resultdata[<span class="string">"protocol"</span>] = <span class="string">"udp"</span></span><br><span class="line">				<span class="keyword">if</span> resultdata[<span class="string">"dir"</span>] == <span class="string">"out"</span> &#123;</span><br><span class="line">					port = <span class="keyword">int</span>(pkt.UDP.DestPort)</span><br><span class="line">					localPort = <span class="keyword">int</span>(pkt.UDP.SrcPort)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					port = <span class="keyword">int</span>(pkt.UDP.SrcPort)</span><br><span class="line">					localPort = <span class="keyword">int</span>(pkt.UDP.DestPort)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> isFilterPort(port) || isFilterPort(localPort) &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				resultdata[<span class="string">"remote"</span>] = fmt.Sprintf(<span class="string">"%s:%d"</span>, ip, port) <span class="comment">//UDP</span></span><br><span class="line">				resultdata[<span class="string">"local"</span>] = fmt.Sprintf(<span class="string">"%s:%d"</span>, common.LocalIP, localPort)</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> pkt.IP.Protocol == TCP &amp;&amp; strings.Contains(pkt.String(), <span class="string">"[syn]"</span>) &#123;</span><br><span class="line">				resultdata[<span class="string">"protocol"</span>] = <span class="string">"tcp"</span></span><br><span class="line">				<span class="keyword">if</span> resultdata[<span class="string">"dir"</span>] == <span class="string">"out"</span> &#123;</span><br><span class="line">					port = <span class="keyword">int</span>(pkt.TCP.DestPort)</span><br><span class="line">					localPort = <span class="keyword">int</span>(pkt.TCP.SrcPort)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					port = <span class="keyword">int</span>(pkt.TCP.SrcPort)</span><br><span class="line">					localPort = <span class="keyword">int</span>(pkt.TCP.DestPort)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> isFilterPort(port) || isFilterPort(localPort) &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				resultdata[<span class="string">"remote"</span>] = fmt.Sprintf(<span class="string">"%s:%d"</span>, ip, port) <span class="comment">//TCP</span></span><br><span class="line">				conName := C.GoString(C.filter(C.CString(ip), C.<span class="keyword">int</span>(port)))</span><br><span class="line">				<span class="keyword">if</span> conName != <span class="string">""</span> &#123;</span><br><span class="line">					resultdata[<span class="string">"pid"</span>] = strings.SplitN(conName, <span class="string">"/"</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">					resultdata[<span class="string">"name"</span>] = strings.SplitN(conName, <span class="string">"/"</span>, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line">				&#125;</span><br><span class="line">				resultdata[<span class="string">"local"</span>] = fmt.Sprintf(<span class="string">"%s:%d"</span>, common.LocalIP, localPort)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			resultChan &lt;- resultdata</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用gopcap库调libpcap api实时捕获流量包，保存在pkt数据报结构里，并调用pkt.Decode进行raw data的字段解析；</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pkt *pcap.Packet</span><br><span class="line">	<span class="keyword">var</span> resultdata <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	h, err := getPcapHandle(common.LocalIP)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		pkt = h.Next()</span><br><span class="line">		<span class="keyword">if</span> pkt == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		pkt.Decode()</span><br></pre></td></tr></table></figure>

<p>定义好结果数据格式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resultdata = <span class="built_in">map</span>[<span class="built_in">string</span>]<span class="built_in">string</span>&#123;</span><br><span class="line">	<span class="string">"source"</span>:   <span class="string">""</span>,</span><br><span class="line">	<span class="string">"dir"</span>:      <span class="string">""</span>,</span><br><span class="line">	<span class="string">"protocol"</span>: <span class="string">""</span>,</span><br><span class="line">	<span class="string">"remote"</span>:   <span class="string">""</span>,</span><br><span class="line">	<span class="string">"local"</span>:    <span class="string">""</span>,</span><br><span class="line">	<span class="string">"pid"</span>:      <span class="string">""</span>,</span><br><span class="line">	<span class="string">"name"</span>:     <span class="string">""</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先过滤掉srcAddr和DstAddr都是自己的数据包，确保捕获的都是外联的流量事件，其次过滤掉srcAddr和DstAddr为serverip的流量，保证捕获的流量是除与Serverip通信之外的流量</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if pkt<span class="number">.</span><span class="built_in">IP</span> != nil &amp;&amp; (<span class="meta">common</span><span class="number">.</span>LocalIP == pkt<span class="number">.</span><span class="built_in">IP</span><span class="number">.</span>SrcAddr() || <span class="meta">common</span><span class="number">.</span>LocalIP == pkt<span class="number">.</span><span class="built_in">IP</span><span class="number">.</span>DestAddr()) &amp;&amp;</span><br><span class="line">			!<span class="meta">common</span><span class="number">.</span>InArray(<span class="meta">common</span><span class="number">.</span>ServerIPList, pkt<span class="number">.</span><span class="built_in">IP</span><span class="number">.</span>SrcAddr(), false) &amp;&amp;</span><br><span class="line">			!<span class="meta">common</span><span class="number">.</span>InArray(<span class="meta">common</span><span class="number">.</span>ServerIPList, pkt<span class="number">.</span><span class="built_in">IP</span><span class="number">.</span>DestAddr(), false) &#123;</span><br></pre></td></tr></table></figure>

<p>resultdata中的source标明事件类型：connection，通过将流量srcAddr与agentLocalIp比较来判断流量流向；判断主机是否是web类型服务器，如果是，则一切流入的流量都过滤</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resultdata[<span class="string">"source"</span>] = <span class="string">"connection"</span></span><br><span class="line"><span class="keyword">if</span> common.LocalIP == pkt.IP.SrcAddr() &#123;</span><br><span class="line"><span class="built_in">	ip </span>= pkt.IP.DestAddr()</span><br><span class="line">	resultdata[<span class="string">"dir"</span>] = <span class="string">"out"</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">	ip </span>= pkt.IP.SrcAddr()</span><br><span class="line">	resultdata[<span class="string">"dir"</span>] = <span class="string">"in"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> common.ServerInfo.Type == <span class="string">"web"</span> &amp;&amp; resultdata[<span class="string">"dir"</span>] == <span class="string">"in"</span> &#123;</span><br><span class="line">	continue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断是否打开记录内网流量事件的配置同时判断流量ip是否是内网，若是，且内网记录配置未开启，则过滤；判断流量ip是否在ip白名单中，若是，则过滤</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> !<span class="keyword">common</span>.Config.LAN &amp;&amp; isLan(ip) &#123;</span><br><span class="line">	<span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">common</span>.InArray(<span class="keyword">common</span>.Config.Filter.IP, ip, <span class="keyword">false</span>) &#123;</span><br><span class="line">	<span class="keyword">continue</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断ip数据报协议类型是否为udp，若是，继续判断控制台记录udp选项是否开启，若未开启，则过滤；若开启，则继续判断流向，并根据流向将解析后的数据包中的源/目的地址分别赋值给port及locaport；之后判断流量所在端口是否在硬编码的白名单端口中，若是，则过滤；最终，将ip、port与localip、localport分别拼接保存在remote、local两个变量中</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> pkt.IP.Protocol<span class="operator"> == </span>UDP &#123;</span><br><span class="line">				<span class="keyword">if</span> common.Config.UDP<span class="operator"> == </span><span class="literal">false</span> &#123;</span><br><span class="line">					continue</span><br><span class="line">				&#125;</span><br><span class="line">				resultdata<span class="literal">["<span class="identifier">protocol</span>"]</span> = <span class="string">"udp"</span></span><br><span class="line">				<span class="keyword">if</span> resultdata<span class="literal">["<span class="identifier">dir</span>"]</span><span class="operator"> == </span><span class="string">"out"</span> &#123;</span><br><span class="line">					port = <span class="built_in">int</span>(pkt.UDP.DestPort)</span><br><span class="line">					localPort = <span class="built_in">int</span>(pkt.UDP.SrcPort)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					port = <span class="built_in">int</span>(pkt.UDP.SrcPort)</span><br><span class="line">					localPort = <span class="built_in">int</span>(pkt.UDP.DestPort)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> is<span class="constructor">FilterPort(<span class="params">port</span>)</span><span class="operator"> || </span>is<span class="constructor">FilterPort(<span class="params">localPort</span>)</span> &#123;</span><br><span class="line">					continue</span><br><span class="line">				&#125;</span><br><span class="line">				resultdata<span class="literal">["<span class="identifier">remote</span>"]</span> = fmt.<span class="constructor">Sprintf(<span class="string">"%s:%d"</span>, <span class="params">ip</span>, <span class="params">port</span>)</span> <span class="comment">//UDP</span></span><br><span class="line">				resultdata<span class="literal">["<span class="identifier">local</span>"]</span> = fmt.<span class="constructor">Sprintf(<span class="string">"%s:%d"</span>, <span class="params">common</span>.LocalIP, <span class="params">localPort</span>)</span></span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func isFilterPort(port int) bool &#123;</span><br><span class="line">	<span class="keyword">for</span> _, v := range filter.Port &#123;</span><br><span class="line">		<span class="keyword">if</span> v ==<span class="built_in"> port </span>&#123;</span><br><span class="line">			return <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 硬编码白名单</span></span><br><span class="line">	filter.Port = []<span class="keyword">int</span>&#123;<span class="number">137</span>, <span class="number">139</span>, <span class="number">445</span>&#125;</span><br><span class="line">	filter.File = []<span class="keyword">string</span>&#123;<span class="string">`c:\windows\temp`</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tcp和udp逻辑类似，不同之处在于tcp流量记录是默认开启的（没有配置），且只判断握手包中的syn包，其它基本一致</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> pkt.IP.Protocol<span class="operator"> == </span>TCP<span class="operator"> &amp;&amp; </span>strings.<span class="constructor">Contains(<span class="params">pkt</span>.String()</span>, <span class="string">"[syn]"</span>) &#123;</span><br><span class="line">			resultdata<span class="literal">["<span class="identifier">protocol</span>"]</span> = <span class="string">"tcp"</span></span><br><span class="line">			<span class="keyword">if</span> resultdata<span class="literal">["<span class="identifier">dir</span>"]</span><span class="operator"> == </span><span class="string">"out"</span> &#123;</span><br><span class="line">				port = <span class="built_in">int</span>(pkt.TCP.DestPort)</span><br><span class="line">				localPort = <span class="built_in">int</span>(pkt.TCP.SrcPort)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				port = <span class="built_in">int</span>(pkt.TCP.SrcPort)</span><br><span class="line">				localPort = <span class="built_in">int</span>(pkt.TCP.DestPort)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> is<span class="constructor">FilterPort(<span class="params">port</span>)</span><span class="operator"> || </span>is<span class="constructor">FilterPort(<span class="params">localPort</span>)</span> &#123;</span><br><span class="line">				continue</span><br><span class="line">			&#125;</span><br><span class="line">			resultdata<span class="literal">["<span class="identifier">remote</span>"]</span> = fmt.<span class="constructor">Sprintf(<span class="string">"%s:%d"</span>, <span class="params">ip</span>, <span class="params">port</span>)</span> <span class="comment">//TCP</span></span><br></pre></td></tr></table></figure>

<p>将流量关联到进程；go调c代码中的filter函数，将remote ip和remote port作为参数，返回包含pid和cmdline的字符串，调用层对其进行分割，保存到map中</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conName := <span class="symbol">C</span>.<span class="symbol">GoString</span>(<span class="symbol">C</span>.filter(<span class="symbol">C</span>.<span class="symbol">CString</span>(ip), <span class="symbol">C</span>.int(port)))</span><br><span class="line">if conName != <span class="string">""</span> &#123;</span><br><span class="line">	resultdata[<span class="string">"pid"</span>] = strings.<span class="symbol">SplitN</span>(conName, <span class="string">"/"</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">	resultdata[<span class="string">"name"</span>] = strings.<span class="symbol">SplitN</span>(conName, <span class="string">"/"</span>, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line">&#125;</span><br><span class="line">resultdata[<span class="string">"local"</span>] = fmt.<span class="symbol">Sprintf</span>(<span class="string">"%s:%d"</span>, common.<span class="symbol">LocalIP</span>, localPort)</span><br></pre></td></tr></table></figure>

<p>具体关联方式需要参考项目中的c代码，先贴下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"><span class="comment">#include &lt;arpa/inet.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;ctype.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;fcntl.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;pwd.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;errno.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;dirent.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/socket.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"></span><br><span class="line">typedef union iaddr iaddr;</span><br><span class="line"></span><br><span class="line">union iaddr &#123;</span><br><span class="line">    unsigned u;</span><br><span class="line">    unsigned char b[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">#define PRG_LOCAL_ADDRESS "local_address"</span></span><br><span class="line"><span class="comment">#define PRG_INODE	 "inode"</span></span><br><span class="line"><span class="comment">#define PRG_SOCKET_PFX    "socket:["</span></span><br><span class="line"><span class="comment">#define PRG_SOCKET_PFXl (strlen(PRG_SOCKET_PFX))</span></span><br><span class="line"><span class="comment">#define PRG_SOCKET_PFX2   "[0000]:"</span></span><br><span class="line"><span class="comment">#define PRG_SOCKET_PFX2l  (strlen(PRG_SOCKET_PFX2))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ifndef LINE_MAX</span></span><br><span class="line"><span class="comment">#define LINE_MAX 4096</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define PATH_PROC	   "/proc"</span></span><br><span class="line"><span class="comment">#define PATH_FD_SUFF	"fd"</span></span><br><span class="line"><span class="comment">#define PATH_FD_SUFFl       strlen(PATH_FD_SUFF)</span></span><br><span class="line"><span class="comment">#define PATH_PROC_X_FD      PATH_PROC "/%s/" PATH_FD_SUFF</span></span><br><span class="line"><span class="comment">#define PATH_CMDLINE	"cmdline"</span></span><br><span class="line"><span class="comment">#define PATH_CMDLINEl       strlen(PATH_CMDLINE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#undef  DIRENT_HAVE_D_TYPE_WORKS</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#define ADDR_LEN INET6_ADDRSTRLEN + 1 + 5 + 1</span></span><br><span class="line"></span><br><span class="line">static void addr2str(<span class="keyword">int</span> af, const void *addr, unsigned port, char *buf)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (inet_ntop(af, addr, buf, ADDR_LEN) == NULL) &#123;</span><br><span class="line">        *buf = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#define PROGNAME_WIDTH 20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define PRG_HASH_SIZE 211</span></span><br><span class="line"><span class="comment">#define PRG_HASHIT(x) ((x) % PRG_HASH_SIZE)</span></span><br><span class="line"></span><br><span class="line">static char finbuf[PROGNAME_WIDTH];</span><br><span class="line"></span><br><span class="line">static void extract_type_1_socket_inode(const char lname[], long * inode_p) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lname[strlen(lname) - <span class="number">1</span>] != <span class="string">']'</span>) *inode_p = -<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		char inode_str[strlen(lname + <span class="number">1</span>)];</span><br><span class="line">		const <span class="keyword">int</span> inode_str_len = strlen(lname) - PRG_SOCKET_PFXl - <span class="number">1</span>;</span><br><span class="line">		char *serr;</span><br><span class="line"></span><br><span class="line">		strncpy(inode_str, lname + PRG_SOCKET_PFXl, inode_str_len);</span><br><span class="line">		inode_str[inode_str_len] = <span class="string">'\0'</span>;</span><br><span class="line">		*inode_p = strtol(inode_str, &amp;serr, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (!serr || *serr || *inode_p &lt; <span class="number">0</span> || *inode_p &gt;= <span class="number">2147483647</span>)</span><br><span class="line">			*inode_p = -<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static char * pget(unsigned uid,long inode) &#123;</span><br><span class="line">    DIR *d = <span class="keyword">opendir</span>(<span class="string">"/proc"</span>);</span><br><span class="line">    <span class="keyword">if</span>(NULL == d) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">	long inode_p;</span><br><span class="line">    char statline[<span class="number">1024</span>];</span><br><span class="line">    char cmdline[<span class="number">1024</span>];</span><br><span class="line">    struct dirent *de;</span><br><span class="line">    struct <span class="keyword">stat</span> stats;</span><br><span class="line">    struct passwd *pw;</span><br><span class="line">	<span class="keyword">int</span> fd, i = <span class="number">0</span>; <span class="keyword">int</span> procfdlen, fd_last, cmdllen, lnamelen;</span><br><span class="line">	char line[LINE_MAX], eacces = <span class="number">0</span>;</span><br><span class="line">	char lname[<span class="number">30</span>], cmdlbuf[<span class="number">512</span>];</span><br><span class="line">	DIR *dirproc = NULL, *dirfd = NULL;</span><br><span class="line">	struct dirent *direproc, *direfd;</span><br><span class="line">	cmdlbuf[sizeof(cmdlbuf)-<span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	const char *cs, *cmdlp;</span><br><span class="line">	<span class="keyword">if</span> (!(dirproc = <span class="keyword">opendir</span>(PATH_PROC)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">printf</span>(<span class="string">"error"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (direproc = <span class="keyword">readdir</span>(dirproc)) &#123;</span><br><span class="line">		<span class="keyword">for</span> (cs = direproc-&gt;d_name; *cs; cs++)</span><br><span class="line">		<span class="keyword">if</span> (!isdigit(*cs))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*cs)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		procfdlen = snprintf(line, sizeof(line), PATH_PROC_X_FD, direproc-&gt;d_name);</span><br><span class="line">		<span class="keyword">if</span> (procfdlen &lt;= <span class="number">0</span> || procfdlen &gt;= sizeof(line)-<span class="number">5</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		errno = <span class="number">0</span>;</span><br><span class="line">		dirfd = <span class="keyword">opendir</span>(line);</span><br><span class="line">		<span class="keyword">if</span> (!dirfd) &#123;</span><br><span class="line">			<span class="keyword">if</span> (errno ==<span class="number">1</span> )</span><br><span class="line">				eacces = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		line[procfdlen] = <span class="string">'/'</span>;</span><br><span class="line">		cmdlp = NULL;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> ((direfd = <span class="keyword">readdir</span>(dirfd))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (procfdlen + <span class="number">1</span> + strlen(direfd-&gt;d_name) + <span class="number">1</span>&gt;sizeof(line))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			memcpy(line + procfdlen - PATH_FD_SUFFl, PATH_FD_SUFF <span class="string">"/"</span>,</span><br><span class="line">				PATH_FD_SUFFl + <span class="number">1</span>);</span><br><span class="line">			strcpy(line + procfdlen + <span class="number">1</span>, direfd-&gt;d_name);</span><br><span class="line">			lnamelen = <span class="keyword">readlink</span>(line, lname, sizeof(lname)-<span class="number">1</span>);</span><br><span class="line">			lname[lnamelen] = <span class="string">'\0'</span>;</span><br><span class="line">			extract_type_1_socket_inode(lname, &amp;inode_p);</span><br><span class="line">			<span class="keyword">if</span> (inode_p == inode)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (!cmdlp) &#123;</span><br><span class="line">					<span class="keyword">if</span> (procfdlen - PATH_FD_SUFFl + PATH_CMDLINEl &gt;=</span><br><span class="line">						sizeof(line)-<span class="number">5</span>)</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					strcpy(line + procfdlen - PATH_FD_SUFFl, PATH_CMDLINE);</span><br><span class="line">					fd = <span class="keyword">open</span>(line, O_RDONLY);</span><br><span class="line">					<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					cmdllen = <span class="keyword">read</span>(fd, cmdlbuf, sizeof(cmdlbuf)-<span class="number">1</span>);</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">close</span>(fd))</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					<span class="keyword">if</span> (cmdllen == -<span class="number">1</span>)</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					<span class="keyword">if</span> (cmdllen &lt; sizeof(cmdlbuf)-<span class="number">1</span>)</span><br><span class="line">						cmdlbuf[cmdllen] = <span class="string">'\0'</span>;</span><br><span class="line">					<span class="keyword">if</span> ((cmdlp = strrchr(cmdlbuf, <span class="string">'/'</span>)))</span><br><span class="line">						cmdlp++;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">						cmdlp = cmdlbuf;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				snprintf(finbuf, sizeof(finbuf), <span class="string">"%s/%s"</span>, direproc-&gt;d_name, cmdlp);</span><br><span class="line">				<span class="keyword">return</span> finbuf;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line">char *<span class="keyword">s</span>;</span><br><span class="line">static char * filter(char *host, <span class="keyword">int</span> port) &#123;</span><br><span class="line">	char *filename = <span class="string">"/proc/net/tcp"</span>;</span><br><span class="line">	char *label = <span class="string">"tcp"</span>;</span><br><span class="line">    memset(finbuf,<span class="number">0</span>,PROGNAME_WIDTH);</span><br><span class="line">    FILE *fp = fopen(filename, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == NULL) <span class="keyword">return</span>;</span><br><span class="line">	long inode;</span><br><span class="line">    char buf[BUFSIZ];</span><br><span class="line">    fgets(buf, BUFSIZ, fp);</span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, BUFSIZ, fp))&#123;</span><br><span class="line">        char lip[ADDR_LEN];</span><br><span class="line">        char rip[ADDR_LEN];</span><br><span class="line">		char more[<span class="number">512</span>];</span><br><span class="line">        iaddr laddr, raddr;</span><br><span class="line">        unsigned lport, rport, <span class="keyword">state</span>, txq, rxq, num, <span class="keyword">tr</span>, tm_when, retrnsmt, uid;</span><br><span class="line">		<span class="keyword">int</span> timeout;</span><br><span class="line">        <span class="keyword">int</span> n = sscanf(buf, <span class="string">" %d: %x:%x %x:%x %x %x:%x %x:%x %x %d %d %ld %512s"</span>,</span><br><span class="line">                       &amp;num, &amp;laddr.u, &amp;lport, &amp;raddr.u, &amp;rport,</span><br><span class="line">					   &amp;<span class="keyword">state</span>, &amp;txq, &amp;rxq, &amp;<span class="keyword">tr</span>, &amp;tm_when, &amp;retrnsmt, &amp;uid, &amp;timeout, &amp;inode, more);</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">15</span>) &#123;</span><br><span class="line">            addr2str(AF_INET, &amp;laddr, lport, lip);</span><br><span class="line">            addr2str(AF_INET, &amp;raddr, rport, rip);</span><br><span class="line">			<span class="keyword">if</span> ( (<span class="keyword">int</span>)rport == port)</span><br><span class="line">			&#123;</span><br><span class="line">				pget(uid, inode);</span><br><span class="line">				fclose(fp);</span><br><span class="line">				<span class="keyword">return</span> finbuf;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line">*<span class="regexp">/</span></span><br></pre></td></tr></table></figure>

<p>代码比较简单，大致说下，利用传递进filter函数的remote ip、port的参数去/proc/net/tcp下筛出连接对应的inode1，在pget函数利用readdir遍历/proc下全量pid子目录，获取/proc/pid/fd/下对应文件描述符指向的inode2，拿此inode2与inode1进行对比，若相等，取出对应pid下的cmdline并和pid拼接，最终返回拼接后的字符串给调用方的conName，调用层再进行进一步拆解赋值组合成指定格式的网络事件，网络行为监控这块基本如上所示</p>
<p><strong>StartProcessMonitor</strong></p>
<p>这边的进程监控稍微有一点复杂，放到另外一章去记录</p>
<p><strong>StartFileMonitor</strong></p>
<p>文件监控用的fsnotify库，封装了inotify api，进程读写动作会触发回调生成文件事件；拿到文件操作事件后模块里还有一个自定义的获取hash操作并归并到文件事件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartFileMonitor</span><span class="params">(resultChan <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"StartFileMonitor"</span>)</span><br><span class="line">	<span class="keyword">var</span> pathList []<span class="keyword">string</span></span><br><span class="line">	watcher, err := fsnotify.NewWatcher()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> watcher.Close()</span><br><span class="line">	<span class="keyword">for</span> _, path := <span class="keyword">range</span> common.Config.MonitorPath &#123;</span><br><span class="line">		<span class="keyword">if</span> path == <span class="string">"%web%"</span> &#123;</span><br><span class="line">			iterationWatcher(common.ServerInfo.Path, watcher, pathList)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> strings.HasPrefix(path, <span class="string">"/"</span>) &#123;</span><br><span class="line">			pathList = <span class="built_in">append</span>(pathList, path)</span><br><span class="line">			<span class="keyword">if</span> strings.HasSuffix(path, <span class="string">"*"</span>) &#123;</span><br><span class="line">				iterationWatcher([]<span class="keyword">string</span>&#123;strings.Replace(path, <span class="string">"*"</span>, <span class="string">""</span>, <span class="number">1</span>)&#125;, watcher, pathList)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				watcher.Add(path)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> resultdata <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> event := &lt;-watcher.Events:</span><br><span class="line">			resultdata = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">			<span class="keyword">if</span> common.InArray(filter.File, strings.ToLower(event.Name), <span class="literal">false</span>) ||</span><br><span class="line">				common.InArray(pathList, strings.ToLower(event.Name), <span class="literal">false</span>) ||</span><br><span class="line">				common.InArray(common.Config.Filter.File, strings.ToLower(event.Name), <span class="literal">true</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(event.Name) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			resultdata[<span class="string">"source"</span>] = <span class="string">"file"</span></span><br><span class="line">			resultdata[<span class="string">"action"</span>] = event.Op.String()</span><br><span class="line">			resultdata[<span class="string">"path"</span>] = event.Name</span><br><span class="line">			resultdata[<span class="string">"hash"</span>] = <span class="string">""</span></span><br><span class="line">			resultdata[<span class="string">"user"</span>] = <span class="string">""</span></span><br><span class="line">			f, err := os.Stat(event.Name)</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; !f.IsDir() &#123;</span><br><span class="line">				<span class="keyword">if</span> f.Size() &lt;= fileSize &#123;</span><br><span class="line">					<span class="keyword">if</span> hash, err := getFileMD5(event.Name); err == <span class="literal">nil</span> &#123;</span><br><span class="line">						resultdata[<span class="string">"hash"</span>] = hash</span><br><span class="line">						<span class="keyword">if</span> common.InArray(common.Config.Filter.File, strings.ToLower(hash), <span class="literal">false</span>) &#123;</span><br><span class="line">							<span class="keyword">continue</span></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> user, err := getFileUser(event.Name); err == <span class="literal">nil</span> &#123;</span><br><span class="line">					resultdata[<span class="string">"user"</span>] = user</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> isFileWhite(resultdata) &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			resultChan &lt;- resultdata</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-watcher.Errors:</span><br><span class="line">			log.Println(<span class="string">"error:"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h4><p><strong>getInfo</strong></p>
<p>collect主要是信息收集相关的模块，与进程、文件、网络这些行为监控不同的是，为了性能和其它一些情况考虑，这块一般不是实时的；yulong这块是在控制台配置了收集型信息的回传间隔放到数据库里并提供rpc api，agent调configRefresh去拉配置并根据配置好的间隔时间（单位：min）进行sleep，确保回传不会太频繁；getinfo调用getallinfo，在其内部调用collect的具体收集子模块；返回信息存放在alldata中，数据处理后rpc调用远端的putinfo方法上传事件：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">func (a *Agent) getInfo() &#123;</span><br><span class="line">	<span class="attribute">historyCache</span> := make(map[string][]map[string]string)</span><br><span class="line">	for &#123;</span><br><span class="line">		if len(common<span class="variable">.Config</span><span class="variable">.MonitorPath</span>) == 0 &#123;</span><br><span class="line">			time<span class="variable">.Sleep</span>(time<span class="variable">.Second</span>)</span><br><span class="line">			a<span class="variable">.log</span>("Failed to get the configuration information")</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		allData := collect<span class="variable">.GetAllInfo</span>()</span><br><span class="line">		for k, v := range allData &#123;</span><br><span class="line">			if len(v) == 0 || a<span class="variable">.mapComparison</span>(v, historyCache[k]) &#123;</span><br><span class="line">				a<span class="variable">.log</span>("GetInfo Data:", k, "No change")</span><br><span class="line">				continue</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				a<span class="variable">.Mutex</span><span class="variable">.Lock</span>()</span><br><span class="line">				a<span class="variable">.PutData</span> = dataInfo&#123;common<span class="variable">.LocalIP</span>, k, runtime<span class="variable">.GOOS</span>, v&#125;</span><br><span class="line">				a<span class="variable">.put</span>()</span><br><span class="line">				a<span class="variable">.Mutex</span><span class="variable">.Unlock</span>()</span><br><span class="line">				if k != "service" &#123;</span><br><span class="line">					a<span class="variable">.log</span>("Data details:", k, a<span class="variable">.PutData</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				historyCache[k] = v</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if common<span class="variable">.Config</span><span class="variable">.Cycle</span> == 0 &#123;</span><br><span class="line">			common<span class="variable">.Config</span><span class="variable">.Cycle</span> = 1</span><br><span class="line">		&#125;</span><br><span class="line">		time<span class="variable">.Sleep</span>(time<span class="variable">.Second</span> * time<span class="variable">.Duration</span>(common<span class="variable">.Config</span><span class="variable">.Cycle</span>) * 60)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (a Agent) put() &#123;</span><br><span class="line">	_, err := a<span class="variable">.Client</span><span class="variable">.Go</span>(a<span class="variable">.ctx</span>, "PutInfo", &amp;a<span class="variable">.PutData</span>, &amp;a<span class="variable">.Reply</span>, nil)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		a<span class="variable">.log</span>("PutInfo error:", err<span class="variable">.Error</span>())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func <span class="symbol">GetAllInfo</span>() map[string][]map[string]string &#123;</span><br><span class="line">	allInfo[<span class="string">"listening"</span>] = <span class="symbol">GetListening</span>()</span><br><span class="line">	allInfo[<span class="string">"service"</span>] = <span class="symbol">GetServiceInfo</span>()</span><br><span class="line">	allInfo[<span class="string">"userlist"</span>] = <span class="symbol">GetUser</span>()</span><br><span class="line">	allInfo[<span class="string">"startup"</span>] = <span class="symbol">GetStartup</span>()</span><br><span class="line">	allInfo[<span class="string">"crontab"</span>] = <span class="symbol">GetCrontab</span>()</span><br><span class="line">	allInfo[<span class="string">"loginlog"</span>] = <span class="symbol">GetLoginLog</span>()</span><br><span class="line">	allInfo[<span class="string">"processlist"</span>] = <span class="symbol">GetProcessList</span>()</span><br><span class="line">	return allInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>各子模块功能如下：</p>
<p><strong>Computerinfo_linux</strong></p>
<p>获取agent部署主机的内核版本、架构等计算机信息存放到info结构体内；并在最后调用discern函数获取web服务路径，这个在init.go函数中有说明：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">func</span> GetComInfo() (<span class="meta">info</span> <span class="meta">common</span>.ComputerInfo) &#123;</span><br><span class="line">	<span class="meta">info</span>.IP = <span class="meta">common</span>.LocalIP</span><br><span class="line">	<span class="meta">info</span>.Hostname, _ = os.Hostname()</span><br><span class="line">	out := <span class="meta">common</span>.Cmdexec(<span class="string">"uname -r"</span>)</span><br><span class="line">	dat, err := ioutil.ReadFile(<span class="string">"/etc/redhat-release"</span>)</span><br><span class="line">	<span class="meta">if</span> err != nil &#123;</span><br><span class="line">		dat, _ = ioutil.ReadFile(<span class="string">"/etc/issue"</span>)</span><br><span class="line">		issue := <span class="keyword">strings.SplitN(string(dat), </span><span class="string">"\n"</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">		out2 := <span class="meta">common</span>.Cmdexec(<span class="string">"uname -m"</span>)</span><br><span class="line">		<span class="meta">info</span>.System = issue + <span class="string">" "</span> + out + out2</span><br><span class="line">	&#125; <span class="meta">else</span> &#123;</span><br><span class="line">		<span class="meta">info</span>.System = <span class="keyword">string(dat) </span>+ <span class="string">" "</span> + out</span><br><span class="line">	&#125;</span><br><span class="line">	discern(&amp;<span class="meta">info</span>)</span><br><span class="line">	return <span class="meta">info</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>crontab_linux</strong></p>
<p>获取agent所在主机的系统及用户计划任务，并分字段解析</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCrontab</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//系统计划任务</span></span><br><span class="line">	dat, err := ioutil.ReadFile(<span class="string">"/etc/crontab"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> resultData</span><br><span class="line">	&#125;</span><br><span class="line">	cronList := strings.Split(<span class="keyword">string</span>(dat), <span class="string">"\n"</span>)</span><br><span class="line">	<span class="keyword">for</span> _, info := <span class="keyword">range</span> cronList &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.HasPrefix(info, <span class="string">"#"</span>) || strings.Count(info, <span class="string">" "</span>) &lt; <span class="number">6</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		s := strings.SplitN(info, <span class="string">" "</span>, <span class="number">7</span>)</span><br><span class="line">		rule := strings.Split(info, <span class="string">" "</span>+s[<span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">		m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"command"</span>: s[<span class="number">6</span>], <span class="string">"user"</span>: s[<span class="number">5</span>], <span class="string">"rule"</span>: rule&#125;</span><br><span class="line">		resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//用户计划任务</span></span><br><span class="line">	dir, err := ioutil.ReadDir(<span class="string">"/var/spool/cron/"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> resultData</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> dir &#123;</span><br><span class="line">		<span class="keyword">if</span> f.IsDir() &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		dat, err = ioutil.ReadFile(<span class="string">"/var/spool/cron/"</span> + f.Name())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		cronList = strings.Split(<span class="keyword">string</span>(dat), <span class="string">"\n"</span>)</span><br><span class="line">		<span class="keyword">for</span> _, info := <span class="keyword">range</span> cronList &#123;</span><br><span class="line">			<span class="keyword">if</span> strings.HasPrefix(info, <span class="string">"#"</span>) || strings.Count(info, <span class="string">" "</span>) &lt; <span class="number">5</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			s := strings.SplitN(info, <span class="string">" "</span>, <span class="number">6</span>)</span><br><span class="line">			rule := strings.Split(info, <span class="string">" "</span>+s[<span class="number">5</span>])[<span class="number">0</span>]</span><br><span class="line">			m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"command"</span>: s[<span class="number">5</span>], <span class="string">"user"</span>: f.Name(), <span class="string">"rule"</span>: rule&#125;</span><br><span class="line">			resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resultData</span><br></pre></td></tr></table></figure>

<p><strong>Listen_linux</strong></p>
<p>调ss -nltp获取当前主机监听的所有tcp连接，过滤掉127.0.0.1，检测local address：port字段中是否存在::或*特殊字符，若有，换成0.0.0.0，其它过滤等等，最终将address、pid、pname放到map中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetListening</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	listeningStr := common.Cmdexec(<span class="string">"ss -nltp"</span>)</span><br><span class="line">	listeningList := strings.Split(listeningStr, <span class="string">"\n"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(listeningList) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, info := <span class="keyword">range</span> listeningList[<span class="number">1</span> : <span class="built_in">len</span>(listeningList)<span class="number">-1</span>] &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(info, <span class="string">"127.0.0.1"</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">		reg := regexp.MustCompile(<span class="string">"\\s+"</span>)</span><br><span class="line">		info = reg.ReplaceAllString(strings.TrimSpace(info), <span class="string">" "</span>)</span><br><span class="line">		s := strings.Split(info, <span class="string">" "</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">6</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		m[<span class="string">"proto"</span>] = <span class="string">"TCP"</span></span><br><span class="line">		<span class="keyword">if</span> strings.Contains(s[<span class="number">3</span>],<span class="string">"::"</span>)&#123;</span><br><span class="line">			m[<span class="string">"address"</span>] = strings.Replace(s[<span class="number">3</span>], <span class="string">"::"</span>, <span class="string">"0.0.0.0"</span>, <span class="number">1</span>)</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			m[<span class="string">"address"</span>] = strings.Replace(s[<span class="number">3</span>], <span class="string">"*"</span>, <span class="string">"0.0.0.0"</span>, <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		b := <span class="literal">false</span></span><br><span class="line">		<span class="keyword">for</span> _,v:= <span class="keyword">range</span> resultData&#123;</span><br><span class="line">			<span class="keyword">if</span> v[<span class="string">"address"</span>] == m[<span class="string">"address"</span>]&#123;</span><br><span class="line">				b = <span class="literal">true</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> b&#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		reg = regexp.MustCompile(<span class="string">`users:\(\("(.*?)",(.*?),.*?\)`</span>)</span><br><span class="line">		r := reg.FindSubmatch([]<span class="keyword">byte</span>(s[<span class="number">5</span>]))</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(<span class="keyword">string</span>(r[<span class="number">2</span>]), <span class="string">"="</span>) &#123;</span><br><span class="line">			m[<span class="string">"pid"</span>] = strings.SplitN(<span class="keyword">string</span>(r[<span class="number">2</span>]), <span class="string">"="</span>, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m[<span class="string">"pid"</span>] = <span class="keyword">string</span>(r[<span class="number">2</span>])</span><br><span class="line">		&#125;</span><br><span class="line">		m[<span class="string">"name"</span>] = <span class="keyword">string</span>(r[<span class="number">1</span>])</span><br><span class="line">		resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resultData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>login_log</strong></p>
<p>解析/var/log/wtmp或运行lastb命令获取当前主机所有用户登陆信息：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> utmp <span class="keyword">struct</span> &#123;</span><br><span class="line">	UtType <span class="keyword">uint32</span></span><br><span class="line">	UtPid  <span class="keyword">uint32</span>    <span class="comment">// PID of login process</span></span><br><span class="line">	UtLine [<span class="number">32</span>]<span class="keyword">byte</span>  <span class="comment">// device name of tty - "/dev/"</span></span><br><span class="line">	UtID   [<span class="number">4</span>]<span class="keyword">byte</span>   <span class="comment">// init id or abbrev. ttyname</span></span><br><span class="line">	UtUser [<span class="number">32</span>]<span class="keyword">byte</span>  <span class="comment">// user name</span></span><br><span class="line">	UtHost [<span class="number">256</span>]<span class="keyword">byte</span> <span class="comment">// hostname for remote login</span></span><br><span class="line">	UtExit <span class="keyword">struct</span> &#123;</span><br><span class="line">		ETermination <span class="keyword">uint16</span> <span class="comment">// process termination status</span></span><br><span class="line">		EExit        <span class="keyword">uint16</span> <span class="comment">// process exit status</span></span><br><span class="line">	&#125;</span><br><span class="line">	UtSession <span class="keyword">uint32</span> <span class="comment">// Session ID, used for windowing</span></span><br><span class="line">	UtTv      <span class="keyword">struct</span> &#123;</span><br><span class="line">		TvSec  <span class="keyword">uint32</span> <span class="comment">/* Seconds */</span></span><br><span class="line">		TvUsec <span class="keyword">uint32</span> <span class="comment">/* Microseconds */</span></span><br><span class="line">	&#125;</span><br><span class="line">	UtAddrV6 [<span class="number">4</span>]<span class="keyword">uint32</span> <span class="comment">// IP address of remote host</span></span><br><span class="line">	Unused   [<span class="number">20</span>]<span class="keyword">byte</span>  <span class="comment">// Reserved for future use</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getLast</span><span class="params">(t <span class="keyword">string</span>)</span> <span class="params">(result []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> timestamp <span class="keyword">int64</span></span><br><span class="line">	<span class="keyword">if</span> t == <span class="string">"all"</span> &#123;</span><br><span class="line">		timestamp = <span class="number">615147123</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ti, _ := time.Parse(<span class="string">"2006-01-02T15:04:05Z07:00"</span>, t)</span><br><span class="line">		timestamp = ti.Unix()</span><br><span class="line">	&#125;</span><br><span class="line">	wtmpFile, err := os.Open(<span class="string">"/var/log/wtmp"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> wtmpFile.Close()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		wtmp := <span class="built_in">new</span>(utmp)</span><br><span class="line">		err = binary.Read(wtmpFile, binary.LittleEndian, wtmp)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> wtmp.UtType == <span class="number">7</span> &amp;&amp; <span class="keyword">int64</span>(wtmp.UtTv.TvSec) &gt; timestamp &#123;</span><br><span class="line">			m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">			m[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">			m[<span class="string">"remote"</span>] = <span class="keyword">string</span>(bytes.TrimRight(wtmp.UtHost[:], <span class="string">"\x00"</span>))</span><br><span class="line">			<span class="keyword">if</span> m[<span class="string">"remote"</span>] == <span class="string">""</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			m[<span class="string">"username"</span>] = <span class="keyword">string</span>(bytes.TrimRight(wtmp.UtUser[:], <span class="string">"\x00"</span>))</span><br><span class="line">			m[<span class="string">"time"</span>] = time.Unix(<span class="keyword">int64</span>(wtmp.UtTv.TvSec), <span class="number">0</span>).Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>)</span><br><span class="line">			result = <span class="built_in">append</span>(result, m)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getLastb</span><span class="params">(t <span class="keyword">string</span>)</span> <span class="params">(result []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> cmd <span class="keyword">string</span></span><br><span class="line">	ti, _ := time.Parse(<span class="string">"2006-01-02T15:04:05Z07:00"</span>, t)</span><br><span class="line">	<span class="keyword">if</span> t == <span class="string">"all"</span> &#123;</span><br><span class="line">		cmd = <span class="string">"lastb --time-format iso"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		cmd = fmt.Sprintf(<span class="string">"lastb -s %s --time-format iso"</span>, ti.Format(<span class="string">"20060102150405"</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	out := common.Cmdexec(cmd)</span><br><span class="line">	logList := strings.Split(out, <span class="string">"\n"</span>)</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> logList[<span class="number">0</span> : <span class="built_in">len</span>(logList)<span class="number">-3</span>] &#123;</span><br><span class="line">		m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">		reg := regexp.MustCompile(<span class="string">"\\s+"</span>)</span><br><span class="line">		v = reg.ReplaceAllString(strings.TrimSpace(v), <span class="string">" "</span>)</span><br><span class="line">		s := strings.Split(v, <span class="string">" "</span>)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">4</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		m[<span class="string">"status"</span>] = <span class="string">"false"</span></span><br><span class="line">		m[<span class="string">"username"</span>] = s[<span class="number">0</span>]</span><br><span class="line">		m[<span class="string">"remote"</span>] = s[<span class="number">2</span>]</span><br><span class="line">		t, _ := time.Parse(<span class="string">"2006-01-02T15:04:05Z0700"</span>, s[<span class="number">3</span>])</span><br><span class="line">		m[<span class="string">"time"</span>] = t.Format(<span class="string">"2006-01-02T15:04:05Z07:00"</span>)</span><br><span class="line">		result = <span class="built_in">append</span>(result, m)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetLoginLog</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	resultData = getLast(common.Config.Lasttime)</span><br><span class="line">	resultData = <span class="built_in">append</span>(resultData, getLastb(common.Config.Lasttime)...)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>process_linux</strong></p>
<p>getprocesslist函数解析当前主机/proc目录获取当前运行的所有进程信息缓存全局变量中；getcmdline函数根据pid获取指定进程cmdline；getstatus函数解析/proc/pid/status中的信息；dirsUnder函数调用readdir返回/proc/子目录方便getprocesslist进行遍历：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProcessList</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> dirs []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	dirs, err = dirsUnder(<span class="string">"/proc"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(dirs) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> dirs &#123;</span><br><span class="line">		pid, err := strconv.Atoi(v)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		statusInfo := getStatus(pid)</span><br><span class="line">		command := getcmdline(pid)</span><br><span class="line">		m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">		m[<span class="string">"pid"</span>] = v</span><br><span class="line">		m[<span class="string">"ppid"</span>] = statusInfo[<span class="string">"PPid"</span>]</span><br><span class="line">		m[<span class="string">"name"</span>] = statusInfo[<span class="string">"Name"</span>]</span><br><span class="line">		m[<span class="string">"command"</span>] = command</span><br><span class="line">		resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getcmdline</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	cmdlineFile := fmt.Sprintf(<span class="string">"/proc/%d/cmdline"</span>, pid)</span><br><span class="line">	cmdlineBytes, e := ioutil.ReadFile(cmdlineFile)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">	&#125;</span><br><span class="line">	cmdlineBytesLen := <span class="built_in">len</span>(cmdlineBytes)</span><br><span class="line">	<span class="keyword">if</span> cmdlineBytesLen == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> cmdlineBytes &#123;</span><br><span class="line">		<span class="keyword">if</span> v == <span class="number">0</span> &#123;</span><br><span class="line">			cmdlineBytes[i] = <span class="number">0x20</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> strings.TrimSpace(<span class="keyword">string</span>(cmdlineBytes))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStatus</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="params">(status <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	status = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	statusFile := fmt.Sprintf(<span class="string">"/proc/%d/status"</span>, pid)</span><br><span class="line">	<span class="keyword">var</span> content []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	content, err = ioutil.ReadFile(statusFile)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, line := <span class="keyword">range</span> strings.Split(<span class="keyword">string</span>(content), <span class="string">"\n"</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(line, <span class="string">":"</span>) &#123;</span><br><span class="line">			kv := strings.SplitN(line, <span class="string">":"</span>, <span class="number">2</span>)</span><br><span class="line">			status[kv[<span class="number">0</span>]] = strings.TrimSpace(kv[<span class="number">1</span>])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dirsUnder</span><span class="params">(dirPath <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	fs, err := ioutil.ReadDir(dirPath)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">string</span>&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sz := <span class="built_in">len</span>(fs)</span><br><span class="line">	<span class="keyword">if</span> sz == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">string</span>&#123;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	ret := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, sz)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; sz; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> fs[i].IsDir() &#123;</span><br><span class="line">			name := fs[i].Name()</span><br><span class="line">			<span class="keyword">if</span> name != <span class="string">"."</span> &amp;&amp; name != <span class="string">".."</span> &#123;</span><br><span class="line">				ret = <span class="built_in">append</span>(ret, name)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>user_linux</strong></p>
<p>解析/etc/passwd中所有用户，过滤掉默认bash为nologin的用户，即无权限登陆的用户，最终返回用户名和描述组成的map：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetUser 获取系统用户列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUser</span><span class="params">()</span> <span class="params">(resultData []<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	dat, err := ioutil.ReadFile(<span class="string">"/etc/passwd"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> resultData</span><br><span class="line">	&#125;</span><br><span class="line">	userList := strings.Split(<span class="keyword">string</span>(dat), <span class="string">"\n"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(userList) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, info := <span class="keyword">range</span> userList[<span class="number">0</span> : <span class="built_in">len</span>(userList)<span class="number">-2</span>] &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(info, <span class="string">"/nologin"</span>) &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		s := strings.SplitN(info, <span class="string">":"</span>, <span class="number">2</span>)</span><br><span class="line">		m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"name"</span>: s[<span class="number">0</span>], <span class="string">"description"</span>: s[<span class="number">1</span>]&#125;</span><br><span class="line">		resultData = <span class="built_in">append</span>(resultData, m)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resultData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>web_path</strong></p>
<p>检测参数是否与apache、httpd、nginx字符串相似（正则匹配），若相似，说明主机上可能存在此服务，此时就可以直接调用命令获取当前主机的所有web路径，最终返回当前主机所有web服务路径列表：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getWebPath</span><span class="params">(webCommand <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> pathList []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> ok, _ := regexp.MatchString(<span class="string">`httpd|apache`</span>, webCommand); ok &#123;</span><br><span class="line">		out := common.Cmdexec(<span class="string">"apachectl -V"</span>)</span><br><span class="line">		<span class="keyword">if</span> !strings.Contains(<span class="keyword">string</span>(out), <span class="string">"SERVER_CONFIG_FILE"</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> pathList, errors.New(<span class="string">"Get ConfigFilePath Error!"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		reg2 := regexp.MustCompile(<span class="string">`HTTPD_ROOT="(.*?)"`</span>)</span><br><span class="line">		reg := regexp.MustCompile(<span class="string">`SERVER_CONFIG_FILE="(.*?)"`</span>)</span><br><span class="line">		configFilePath := reg2.FindStringSubmatch(<span class="keyword">string</span>(out))[<span class="number">1</span>] + <span class="string">"/"</span> + reg.FindStringSubmatch(<span class="keyword">string</span>(out))[<span class="number">1</span>]</span><br><span class="line">		<span class="keyword">if</span> configFilePath != <span class="string">"/"</span> &#123;</span><br><span class="line">			dat, err := ioutil.ReadFile(configFilePath)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> pathList, err</span><br><span class="line">			&#125;</span><br><span class="line">			reg = regexp.MustCompile(<span class="string">`&lt;Directory "(.*?)"&gt;`</span>)</span><br><span class="line">			pathM := reg.FindAllSubmatch([]<span class="keyword">byte</span>(dat), <span class="number">-1</span>)</span><br><span class="line">			<span class="keyword">for</span> _, info := <span class="keyword">range</span> pathM &#123;</span><br><span class="line">				pathList = <span class="built_in">append</span>(pathList, <span class="keyword">string</span>(info[<span class="number">1</span>]))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.Contains(webCommand, <span class="string">"nginx"</span>) &#123;</span><br><span class="line">		out := common.Cmdexec(<span class="string">"nginx -V"</span>)</span><br><span class="line">		regex, _ := regexp.Compile(<span class="string">`\-\-conf\-path\=(.*?)[ |$]`</span>)</span><br><span class="line">		result := regex.FindStringSubmatch(out)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(result) &gt;= <span class="number">2</span> &#123;</span><br><span class="line">			configFilePath := result[<span class="number">1</span>]</span><br><span class="line">			dat, err := ioutil.ReadFile(configFilePath)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> pathList, err</span><br><span class="line">			&#125;</span><br><span class="line">			pathRegex, _ := regexp.Compile(<span class="string">`root (.*?)\;`</span>)</span><br><span class="line">			pathResult := pathRegex.FindStringSubmatch(<span class="keyword">string</span>(dat))</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(pathResult) &gt;= <span class="number">2</span> &#123;</span><br><span class="line">				pathList = <span class="built_in">append</span>(pathList, pathResult[<span class="number">1</span>])</span><br><span class="line">			&#125;</span><br><span class="line">			sitePath := filepath.Dir(configFilePath) + <span class="string">"/sites-available/"</span></span><br><span class="line">			dirList, _ := ioutil.ReadDir(sitePath)</span><br><span class="line">			<span class="keyword">for</span> _, v := <span class="keyword">range</span> dirList &#123;</span><br><span class="line">				<span class="keyword">if</span> v.IsDir() &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				dat, err := ioutil.ReadFile(sitePath + v.Name())</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				pathResult = pathRegex.FindStringSubmatch(<span class="keyword">string</span>(dat))</span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">len</span>(pathResult) &gt;= <span class="number">2</span> &#123;</span><br><span class="line">					pathList = <span class="built_in">append</span>(pathList, pathResult[<span class="number">1</span>])</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pathList, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<p><strong>Init</strong></p>
<p>GetAllInfo函数调用collect模块的各子模块获取主机信息；discern函数调用GetProcessList缓存进程信息后与硬编码服务信息进行匹配，若检测到缓存的进程信息中存在硬编码中指定的进程名，则认定当前主机存在此服务，若同时此agent部署主机类型为web，则调用getWebPath根据不同服务类型解析具体服务路径信息；removeDuplicatesAndEmpty这个去重模块好像没有调用者；另外需要注意的是，此函数内部起了一个线程每1h调用一次GetComInfo获取系统信息等：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> allInfo = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tagMap = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">	<span class="string">"web"</span>: <span class="string">`nginx|httpd|apache|w3wp\.exe|tomcat|weblogic|jboss|jetty`</span>,</span><br><span class="line">	<span class="string">"db"</span>:  <span class="string">`mysql|mongo|sqlservr\.exe|oracle|elasticsearch|postgres|redis|cassandra|teradata|solr|HMaster|hbase|mariadb`</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		time.Sleep(time.Second * <span class="number">3600</span>)</span><br><span class="line">		common.ServerInfo = GetComInfo()</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllInfo 获取所有收集的信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAllInfo</span><span class="params">()</span> <span class="title">map</span>[<span class="title">string</span>][]<span class="title">map</span>[<span class="title">string</span>]<span class="title">string</span></span> &#123;</span><br><span class="line">	allInfo[<span class="string">"listening"</span>] = GetListening()</span><br><span class="line">	allInfo[<span class="string">"service"</span>] = GetServiceInfo()</span><br><span class="line">	allInfo[<span class="string">"userlist"</span>] = GetUser()</span><br><span class="line">	allInfo[<span class="string">"startup"</span>] = GetStartup()</span><br><span class="line">	allInfo[<span class="string">"crontab"</span>] = GetCrontab()</span><br><span class="line">	allInfo[<span class="string">"loginlog"</span>] = GetLoginLog()</span><br><span class="line">	allInfo[<span class="string">"processlist"</span>] = GetProcessList()</span><br><span class="line">	<span class="keyword">return</span> allInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">discern</span><span class="params">(info *common.ComputerInfo)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> tagMap &#123;</span><br><span class="line">		<span class="keyword">for</span> _, p := <span class="keyword">range</span> GetProcessList() &#123;</span><br><span class="line">			<span class="keyword">if</span> p[<span class="string">"command"</span>] == <span class="string">""</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ok, _ := regexp.MatchString(v, p[<span class="string">"command"</span>]); ok &#123;</span><br><span class="line">				info.Type = k</span><br><span class="line">				<span class="keyword">if</span> k == <span class="string">"web"</span> &#123;</span><br><span class="line">					info.Path, _ = getWebPath(p[<span class="string">"command"</span>])</span><br><span class="line">					<span class="comment">// web优先，匹配到web就退出，其他一直匹配下去</span></span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeDuplicatesAndEmpty</span><span class="params">(list []<span class="keyword">string</span>)</span> <span class="params">(ret []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	listLen := <span class="built_in">len</span>(list)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; listLen; i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; list[i<span class="number">-1</span>] == list[i]) || <span class="built_in">len</span>(list[i]) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		ret = <span class="built_in">append</span>(ret, list[i])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getInfo</strong></p>
<p>agent模块的init子模块函数的调用者为agent/client/agent.go中的a.getInfo()，函数内部调用了agent/collect/init.go中的GetAllInfo()函数，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *Agent)</span> <span class="title">getInfo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	historyCache := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(common.Config.MonitorPath) == <span class="number">0</span> &#123;</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			a.log(<span class="string">"Failed to get the configuration information"</span>)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		allData := collect.GetAllInfo()</span><br></pre></td></tr></table></figure>





<h3 id="Daemon-1"><a href="#Daemon-1" class="headerlink" title="Daemon"></a>Daemon</h3><h4 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h4><p>先从main开始看，和agent类似，最开始是参数解析，不过这块应该不是同一个人写的，daemon这边直接用flag库去做解析了；daemon支持install、uninstall、register及netloc string三种参数运行；参数解析结果分别存放到对应变量中：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flag.<span class="constructor">StringVar(&amp;<span class="params">common</span>.ServerIP, <span class="string">"netloc"</span>, <span class="string">""</span>, <span class="string">"* WebServer 192.168.1.100:443"</span>)</span></span><br><span class="line">	installBool = flag.<span class="constructor">Bool(<span class="string">"install"</span>, <span class="params">false</span>, <span class="string">"Install yulong-hids service"</span>)</span></span><br><span class="line">	uninstallBool = flag.<span class="constructor">Bool(<span class="string">"uninstall"</span>, <span class="params">false</span>, <span class="string">"Remove yulong-hids service"</span>)</span></span><br><span class="line">	registeredBool = flag.<span class="constructor">Bool(<span class="string">"register"</span>, <span class="params">false</span>, <span class="string">"Registration yulong-hids service"</span>)</span></span><br><span class="line">	flag.<span class="constructor">Parse()</span></span><br></pre></td></tr></table></figure>

<h4 id="task"><a href="#task" class="headerlink" title="task"></a>task</h4><p><strong>uninstall</strong></p>
<p>若检测到正确的uninstall参数，daemon首先卸载进程监控的lkm，之后kill掉agent，然后卸载掉daemon自身注册的服务，最后os.exit(1)退出：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> *uninstallBool &#123;</span><br><span class="line">	<span class="keyword">task</span>.UnInstallALL()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnInstallALL 卸载</span></span><br><span class="line">func UnInstallALL() &#123;</span><br><span class="line">	<span class="keyword">if</span> runtime.GOOS == <span class="string">"windows"</span> &#123;</span><br><span class="line">		common.CmdExec(<span class="string">"net stop pro"</span>)</span><br><span class="line">		<span class="comment">// common.CmdExec("net stop npf")</span></span><br><span class="line">		common.CmdExec(<span class="string">"sc delete pro"</span>)</span><br><span class="line">		<span class="comment">// common.CmdExec("sc delete npf")</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		common.CmdExec(<span class="string">"rmmod syshook_execve"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	common.KillAgent()</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> := common.Service.Uninstall(); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"Uninstall yulong-hids error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Uninstall completed"</span>)</span><br><span class="line">	os.<span class="keyword">Exit</span>(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">KillAgent</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> AgentStatus &#123;</span><br><span class="line">		<span class="keyword">return</span> Cmd.Process.Kill()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>install</strong></p>
<p>若参数为install，则进入daemon的静默安装流程；首先检测路径硬编码的daemon安装路径是否存在（common.go中定义），若不存在，则mkdir新建；之后调用install.Dependency函数进行依赖环境的安装：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> *installBool &#123;</span><br><span class="line">	<span class="comment">// 依赖环境安装</span></span><br><span class="line">	<span class="keyword">if</span> _, err = os.<span class="constructor">Stat(<span class="params">common</span>.InstallPath)</span>; err != nil &#123;</span><br><span class="line">		os.<span class="constructor">Mkdir(<span class="params">common</span>.InstallPath, 0)</span></span><br><span class="line">		err = install.<span class="constructor">Dependency(<span class="params">common</span>.ServerIP, <span class="params">common</span>.InstallPath, <span class="params">common</span>.Arch)</span></span><br><span class="line">		<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">			log.<span class="constructor">Println(<span class="string">"Install dependency, service error:"</span>, <span class="params">err</span>.Error()</span>)</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>跟进此agent/daemon/install/dependence_linux.go中的Dependency函数，首先发现daemon会从server下载进程监控对应lkm的压缩包到指定目录下，里面包含不同内核版本下的内核模块；之后会将内核模块名与主机uname -r的结果进行比较，若解压后的压缩包内存在内核模块文件名与当前主机系统内核版本一致，则进行insmod安装：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">func Dependency(ip string, installPath string, <span class="keyword">arch</span> string) <span class="keyword">error</span> &#123;</span><br><span class="line">	<span class="comment">// _, err := os.Stat("/usr/lib64/libpcap.so.1")</span></span><br><span class="line">	<span class="comment">// if err != nil &#123;</span></span><br><span class="line">	<span class="comment">// 	return err</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	url := fmt.Sprintf(<span class="string">"%s://%s/json/download?system=linux&amp;platform=%s&amp;type=data&amp;action=download"</span>, common.Proto, ip, <span class="keyword">arch</span>)</span><br><span class="line">	pcappath := installPath + <span class="string">"data.zip"</span></span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Download dependent environment package"</span>)</span><br><span class="line">	<span class="keyword">err</span> := downFile(url, pcappath)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	rc, <span class="keyword">err</span> := <span class="keyword">zip</span>.OpenReader(pcappath)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	defer rc.<span class="keyword">Close</span>()</span><br><span class="line">	<span class="keyword">out</span>, <span class="keyword">err</span> := common.CmdExec(<span class="string">"uname -r"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil || strings.<span class="keyword">Count</span>(<span class="keyword">out</span>, <span class="string">"."</span>) &lt; 2 &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">"Get kernel version identification"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	ver := strings.Join(strings.<span class="keyword">Split</span>(strings.<span class="built_in">Trim</span>(<span class="keyword">out</span>, <span class="string">"\n"</span>), <span class="string">"."</span>)[0:3], <span class="string">"."</span>)</span><br><span class="line">	<span class="keyword">for</span> _, _file := <span class="keyword">range</span> rc.<span class="keyword">File</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> _file.Name == <span class="string">"syshook_"</span>+ver+<span class="string">".ko"</span> &#123;</span><br><span class="line">			f, _ := _file.<span class="keyword">Open</span>()</span><br><span class="line">			desfile, <span class="keyword">err</span> := os.OpenFile(installPath+<span class="string">"syshook_execve.ko"</span>, os.O_CREATE|os.O_WRONLY, os.ModePerm)</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">			&#125;</span><br><span class="line">			io.CopyN(desfile, f, int64(_file.UncompressedSize64))</span><br><span class="line">			desfile.<span class="keyword">Close</span>()</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"Use syshook_"</span> + ver)</span><br><span class="line">			<span class="keyword">out</span>, <span class="keyword">err</span> = common.CmdExec(fmt.Sprintf(<span class="string">"insmod %s/syshook_execve.ko"</span>, installPath))</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !strings.Contains(<span class="keyword">out</span>, <span class="string">"ERROR"</span>) &#123;</span><br><span class="line">				<span class="keyword">log</span>.Println(<span class="string">"Insmod syshook_execve succeeded"</span>)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">log</span>.Println(<span class="string">"Insmod syshook_execve error, command output:"</span>, <span class="keyword">out</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装完依赖之后开始安装agent：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">err</span> := install.Agent(common.ServerIP, common.InstallPath, common.<span class="keyword">Arch</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"Install agent error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Installed!"</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进agent/daemon/install/agent_linux.go中的Agent函数，发现它会调用同目录下lib.go中的DownAgent从server下载编译好的agent执行文件并拷贝到对应项目安装目录，同时将安装目录下的daemon注册为服务，并在最终启动服务：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">func Agent(ip string, installPath string, <span class="keyword">arch</span> string) <span class="keyword">error</span> &#123;</span><br><span class="line">	<span class="comment">// 下载agent</span></span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Download Agent"</span>)</span><br><span class="line">	<span class="keyword">err</span> := DownAgent(ip, installPath+<span class="string">"agent"</span>, <span class="keyword">arch</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 拷贝自身到安装目录</span></span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Copy the daemon to the installation directory"</span>)</span><br><span class="line">	<span class="keyword">err</span> = copyMe(installPath)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 安装daemon为服务</span></span><br><span class="line">	os.Chmod(installPath+<span class="string">"daemon"</span>, 0750)</span><br><span class="line">	cmd := installPath + <span class="string">"daemon -register -netloc "</span> + ip</span><br><span class="line">	<span class="keyword">out</span>, <span class="keyword">err</span> := common.CmdExec(cmd)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//启动服务</span></span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Start the service"</span>)</span><br><span class="line">	cmd = <span class="string">"systemctl start yulong-hids"</span></span><br><span class="line">	<span class="keyword">out</span>, <span class="keyword">err</span> = common.CmdExec(cmd)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> == nil &amp;&amp; len(<span class="keyword">out</span>) == 0 &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"Start service successfully"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DownAgent</span><span class="params">(ip <span class="keyword">string</span>, agentPath <span class="keyword">string</span>, arch <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	url := fmt.Sprintf(<span class="string">"%s://%s/json/download?system=%s&amp;platform=%s&amp;type=agent&amp;action=download"</span>, common.Proto, ip, runtime.GOOS, arch)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Agent 下载检查和重试, 重试三次，功能性考虑</span></span><br><span class="line">	times := <span class="number">3</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		err = downFile(url, agentPath)</span><br><span class="line">		<span class="comment">// 检查文件hash是否匹配</span></span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			mstr, _ := FileMD5String(agentPath)</span><br><span class="line">			log.Println(<span class="string">"Agent file MD5:"</span>, mstr)</span><br><span class="line">			<span class="keyword">if</span> CheckAgentHash(mstr, ip, arch) &#123;</span><br><span class="line">				log.Println(<span class="string">"Agent download finished, hash check passed"</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.Println(<span class="string">"Agent is broken, retry the downloader again"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> times--; times == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> errors.New(<span class="string">"Agent Download Error"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func downFile(url string, svaepath string) <span class="keyword">error</span> &#123;</span><br><span class="line">	request, _ := http.NewRequest(<span class="string">"GET"</span>, url, nil)</span><br><span class="line">	request.<span class="keyword">Close</span> = true</span><br><span class="line">	<span class="keyword">if</span> res, <span class="keyword">err</span> := common.HTTPClient.<span class="keyword">Do</span>(request); <span class="keyword">err</span> == nil &#123;</span><br><span class="line">		defer res.Body.<span class="keyword">Close</span>()</span><br><span class="line">		<span class="keyword">file</span>, <span class="keyword">err</span> := os.Create(svaepath)</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">		&#125;</span><br><span class="line">		io.<span class="keyword">Copy</span>(<span class="keyword">file</span>, res.Body)</span><br><span class="line">		<span class="keyword">file</span>.<span class="keyword">Close</span>()</span><br><span class="line">		<span class="keyword">if</span> runtime.GOOS == <span class="string">"linux"</span> &#123;</span><br><span class="line">			os.Chmod(svaepath, 0750)</span><br><span class="line">		&#125;</span><br><span class="line">		fileInfo, <span class="keyword">err</span> := os.Stat(svaepath)</span><br><span class="line">		<span class="comment">// log.Println(res.ContentLength, fileInfo.Size())</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil || fileInfo.Size() != res.ContentLength &#123;</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"File download error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">"downfile error"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>register</strong></p>
<p>注册daemon为系统服务，调用了kardianos开源项目api，本质上封装了linux系统systemd相关；若注册成功，则启动服务：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> *registeredBool &#123;</span><br><span class="line">	<span class="keyword">err</span> = common.Service.Install()</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"Install daemon as service error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> = common.Service.Start(); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"Service start error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"Install as a service"</span>, <span class="string">"ok"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>run</strong></p>
<p>运行daemon服务进程：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">err</span> = common.Service.<span class="keyword">Run</span>()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">	<span class="keyword">log</span>.Println(<span class="string">"Service run error:"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>起一个线程调用exec启动agent，线程运行期间有一些加锁操作，猜测是防止线程抢占；启动成功后，agentstatus置位，线程等待agent执行完毕，一旦检测到agent线程退出，则主线程从wait状态中被唤醒，重新运行agent：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">func (p *<span class="keyword">program</span>) Start(s service.Service) <span class="keyword">error</span> &#123;</span><br><span class="line">	go p.<span class="keyword">run</span>()</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (p *<span class="keyword">program</span>) <span class="keyword">run</span>() &#123;</span><br><span class="line">	go task.WaitThread()</span><br><span class="line">	<span class="keyword">var</span> agentFilePath string</span><br><span class="line">	<span class="keyword">if</span> runtime.GOOS == <span class="string">"windows"</span> &#123;</span><br><span class="line">		agentFilePath = common.InstallPath + <span class="string">"agent.exe"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		agentFilePath = common.InstallPath + <span class="string">"agent"</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		common.<span class="keyword">M</span>.Lock()</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"Start Agent"</span>)</span><br><span class="line">		common.Cmd = exec.Command(agentFilePath, common.ServerIP)</span><br><span class="line">		<span class="keyword">err</span> := common.Cmd.Start()</span><br><span class="line">		common.<span class="keyword">M</span>.Unlock()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> == nil &#123;</span><br><span class="line">			common.AgentStatus = true</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"Start Agent successful"</span>)</span><br><span class="line">			<span class="keyword">err</span> = common.Cmd.Wait()</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">				common.AgentStatus = false</span><br><span class="line">				<span class="keyword">log</span>.Println(<span class="string">"Agent to exit："</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">log</span>.Println(<span class="string">"Startup Agent failed"</span>, <span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">		&#125;</span><br><span class="line">		time.<span class="keyword">Sleep</span>(time.Second * 10)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>daemon启动接收任务的线程：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="keyword">task</span>.WaitThread()</span><br></pre></td></tr></table></figure>

<p>启动线程做了这么几件事，首先调listen函数绑定65512端口并进行监听和等待accept；一旦有连接ip，确认是否为server，若是，则调用tcppipe进入通信阶段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WaitThread</span><span class="params">()</span></span> &#123;</span><br><span class="line">	setPublicKey()</span><br><span class="line">	<span class="keyword">var</span> t taskServer</span><br><span class="line">	t.run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *taskServer)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := t.listen()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">"Start the task listener thread"</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		tcpConn, err := t.TCPListener.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">"Accept new TCP listener error:"</span>, err.Error())</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		t.ServerIP = strings.SplitN(tcpConn.RemoteAddr().String(), <span class="string">":"</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> t.isServer() &#123;</span><br><span class="line">			t.tcpPipe(tcpConn)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tcpConn.Close()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>tcpPipe</strong></p>
<p>对从socket接收到的信息进行rsaDecrypt并将字符串数据转为json；之后对格式转换后的数据进行解析，取出type、command（任务类型、任务任务）两个字段信息，并将返回结果result字段和前两个字段组合传入传入task接收任务的结构体中，调用Run函数后将结果写入socket：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *taskServer)</span> <span class="title">tcpPipe</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	reader := bufio.NewReader(conn)</span><br><span class="line">	message, err := reader.ReadBytes(<span class="string">'\n'</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	decodeBytes, _ := base64.RawStdEncoding.DecodeString(<span class="keyword">string</span>(message))</span><br><span class="line">	decryptdata, err := rsaDecrypt(decodeBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"Decrypt rsa text in tcpPipe error:"</span>, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> taskData <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">	err = json.Unmarshal(decryptdata, &amp;taskData)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"Unmarshal json text in tcpPipe error"</span>, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> taskType <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> data <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := taskData[<span class="string">"type"</span>]; ok &#123;</span><br><span class="line">		taskType = taskData[<span class="string">"type"</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, ok := taskData[<span class="string">"command"</span>]; ok &#123;</span><br><span class="line">		data = taskData[<span class="string">"command"</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	result := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"status"</span>: <span class="string">"false"</span>, <span class="string">"data"</span>: <span class="string">""</span>&#125;</span><br><span class="line">	T := Task&#123;taskType, data, result&#125;</span><br><span class="line">	<span class="keyword">if</span> sendResult := T.Run(); <span class="built_in">len</span>(sendResult) != <span class="number">0</span> &#123;</span><br><span class="line">		conn.Write(sendResult)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>tcp</strong></p>
<p>之后是根据任务类型（type）进行不同的逻辑处理，并将返回值存入结构体的result字段中返回给调用层：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">Run</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> t.Type &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"reload"</span>:</span><br><span class="line">		t.reload()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"quit"</span>:</span><br><span class="line">		t.quit()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"kill"</span>:</span><br><span class="line">		t.kill()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"uninstall"</span>:</span><br><span class="line">		t.uninstall()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"update"</span>:</span><br><span class="line">		t.update()</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"delete"</span>:</span><br><span class="line">		t.<span class="built_in">delete</span>()</span><br><span class="line">		<span class="comment">// case "exec":</span></span><br><span class="line">		<span class="comment">// 	t.exec()</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> sendResult []<span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> b, err := json.Marshal(t.Result); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		msg := <span class="keyword">string</span>(b) + <span class="string">"\n"</span></span><br><span class="line">		sendResult = []<span class="keyword">byte</span>(msg)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sendResult</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">reload</span><span class="params">()</span></span> &#123;</span><br><span class="line">	t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">	<span class="keyword">if</span> err := common.KillAgent(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"status"</span>] = <span class="string">"false"</span></span><br><span class="line">		t.Result[<span class="string">"data"</span>] = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">quit</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> common.AgentStatus &#123;</span><br><span class="line">		common.Cmd.Process.Kill()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">panic</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">kill</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> redata := KillProcess(t.Command); redata != <span class="string">""</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">		t.Result[<span class="string">"data"</span>] = redata</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">uninstall</span><span class="params">()</span></span> &#123;</span><br><span class="line">	UnInstallALL()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">update</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ok, err := agentUpdate(common.ServerIP, common.InstallPath, common.Arch); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ok &#123;</span><br><span class="line">			t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">			t.Result[<span class="string">"data"</span>] = <span class="string">"更新完毕"</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">			t.Result[<span class="string">"data"</span>] = <span class="string">"已经是最新版本"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"data"</span>] = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">delete</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := os.Remove(t.Command); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">		t.Result[<span class="string">"data"</span>] = t.Command + <span class="string">" 删除成功"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"data"</span>] = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Task)</span> <span class="title">exec</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> dat, err := common.CmdExec(t.Command); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"status"</span>] = <span class="string">"true"</span></span><br><span class="line">		t.Result[<span class="string">"data"</span>] = dat</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t.Result[<span class="string">"data"</span>] = err.Error()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><h4 id="main-2"><a href="#main-2" class="headerlink" title="main"></a>main</h4><p>加载证书，注册watcher为rpc服务，暴露出33433的tcp通信端口：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	cert, err := tls.LoadX509KeyPair(<span class="string">"cert.pem"</span>, <span class="string">"private.pem"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"cert error!"</span>)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"><span class="built_in">	config </span>:= &amp;tls.Config&#123;Certificates: []tls.Certificate&#123;cert&#125;&#125;</span><br><span class="line">	s := server.NewServer(server.WithTLSConfig(config))</span><br><span class="line">	s.AuthFunc = auth</span><br><span class="line">	s.RegisterName(<span class="string">"Watcher"</span>, new(Watcher), <span class="string">""</span>)</span><br><span class="line">	log.Println(<span class="string">"RPC Server started"</span>)</span><br><span class="line">	err = s.Serve(<span class="string">"tcp"</span>, <span class="string">":33433"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err.<span class="builtin-name">Error</span>())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>watcher类型的函数有getinfo和putinfo；前者用于根据agent提供的主机信息获取此主机具体配置返回给agent；后者用于接收agent产生的事件数据：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watcher)</span> <span class="title">GetInfo</span><span class="params">(ctx context.Context, info *action.ComputerInfo, result *action.ClientConfig)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	action.ComputerInfoSave(*info)</span><br><span class="line">	config := action.GetAgentConfig(info.IP)</span><br><span class="line">	log.Println(<span class="string">"getconfig:"</span>, info.IP)</span><br><span class="line">	*result = config</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watcher)</span> <span class="title">PutInfo</span><span class="params">(ctx context.Context, datainfo *models.DataInfo, result *<span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//保证数据正常</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(datainfo.Data) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	datainfo.Uptime = time.Now()</span><br><span class="line">	log.Println(<span class="string">"putinfo:"</span>, datainfo.IP, datainfo.Type)</span><br><span class="line">	err := action.ResultSave(*datainfo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	err = action.ResultStat(*datainfo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">	safecheck.ScanChan &lt;- *datainfo</span><br><span class="line">	*result = <span class="number">1</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进具体函数内部（server/action/）,发现是封装的一些事件统计、增删改查mongo和写es的操作，不再详述：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">func ComputerInfoSave(info ComputerInfo) &#123;</span><br><span class="line">	c := models.<span class="keyword">DB</span>.C(<span class="string">"client"</span>)</span><br><span class="line">	info.Uptime = time.Now()</span><br><span class="line">	c.Upsert(bson.<span class="keyword">M</span>&#123;<span class="string">"ip"</span>: info.IP&#125;, bson.<span class="keyword">M</span>&#123;<span class="string">"$set"</span>: &amp;info&#125;)</span><br><span class="line">	c.<span class="keyword">Update</span>(bson.<span class="keyword">M</span>&#123;<span class="string">"ip"</span>: info.IP, <span class="string">"$or"</span>: []bson.<span class="keyword">M</span>&#123;bson.<span class="keyword">M</span>&#123;<span class="string">"health"</span>: 1&#125;, bson.<span class="keyword">M</span>&#123;<span class="string">"health"</span>: nil&#125;&#125;&#125;, bson.<span class="keyword">M</span>&#123;<span class="string">"$set"</span>: bson.<span class="keyword">M</span>&#123;<span class="string">"health"</span>: 0&#125;&#125;)</span><br><span class="line">&#125;</span><br><span class="line">func GetAgentConfig(ip string) ClientConfig &#123;</span><br><span class="line">	<span class="keyword">var</span> clientRes client</span><br><span class="line">	c := models.<span class="keyword">DB</span>.C(<span class="string">"config"</span>)</span><br><span class="line">	c.Find(bson.<span class="keyword">M</span>&#123;<span class="string">"type"</span>: <span class="string">"client"</span>&#125;).<span class="keyword">One</span>(&amp;clientRes)</span><br><span class="line">	config := clientRes.DIC</span><br><span class="line">	<span class="keyword">var</span> res filterres</span><br><span class="line">	c.Find(bson.<span class="keyword">M</span>&#123;<span class="string">"type"</span>: <span class="string">"filter"</span>&#125;).<span class="keyword">One</span>(&amp;res)</span><br><span class="line">	config.Filter = res.Dic</span><br><span class="line">	lastTime, <span class="keyword">err</span> := models.QueryLogLastTime(ip)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="keyword">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">		config.Lasttime = <span class="string">"all"</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		config.Lasttime = lastTime</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br><span class="line">func ResultSave(datainfo models.DataInfo) <span class="keyword">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">err</span> <span class="keyword">error</span></span><br><span class="line">	<span class="comment">// 登录日志、网络连接、进程创建、文件操作 存放在es，其余保存在mongodb</span></span><br><span class="line">	<span class="keyword">if</span> datainfo.<span class="keyword">Type</span> == <span class="string">"loginlog"</span> || datainfo.<span class="keyword">Type</span> == <span class="string">"connection"</span> || datainfo.<span class="keyword">Type</span> == <span class="string">"process"</span> || datainfo.<span class="keyword">Type</span> == <span class="string">"file"</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> datainfo.<span class="keyword">Type</span> == <span class="string">"loginlog"</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> _, logininfo := <span class="keyword">range</span> datainfo.Data &#123;</span><br><span class="line">				time, _ := time.<span class="keyword">Parse</span>(<span class="string">"2006-01-02T15:04:05Z07:00"</span>, logininfo[<span class="string">"time"</span>])</span><br><span class="line">				delete(logininfo, <span class="string">"time"</span>)</span><br><span class="line">				esdata := models.ESSave&#123;</span><br><span class="line">					IP:   datainfo.IP,</span><br><span class="line">					Data: logininfo,</span><br><span class="line">					Time: time,</span><br><span class="line">				&#125;</span><br><span class="line">				models.InsertEs(datainfo.<span class="keyword">Type</span>, esdata)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			dataTimeInt, <span class="keyword">err</span> := strconv.Atoi(datainfo.Data[0][<span class="string">"time"</span>])</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">			&#125;</span><br><span class="line">			delete(datainfo.Data[0], <span class="string">"time"</span>)</span><br><span class="line">			esdata := models.ESSave&#123;</span><br><span class="line">				IP:   datainfo.IP,</span><br><span class="line">				Data: datainfo.Data[0],</span><br><span class="line">				Time: time.Unix(int64(dataTimeInt), 0),</span><br><span class="line">			&#125;</span><br><span class="line">			models.InsertEs(datainfo.<span class="keyword">Type</span>, esdata)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		c := models.<span class="keyword">DB</span>.C(<span class="string">"info"</span>)</span><br><span class="line">		<span class="keyword">count</span>, _ := c.Find(bson.<span class="keyword">M</span>&#123;<span class="string">"ip"</span>: datainfo.IP, <span class="string">"type"</span>: datainfo.<span class="keyword">Type</span>&#125;).<span class="keyword">Count</span>()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">count</span> &gt;= 1 &#123;</span><br><span class="line">			<span class="keyword">err</span> = c.<span class="keyword">Update</span>(bson.<span class="keyword">M</span>&#123;<span class="string">"ip"</span>: datainfo.IP, <span class="string">"type"</span>: datainfo.<span class="keyword">Type</span>&#125;,</span><br><span class="line">				bson.<span class="keyword">M</span>&#123;<span class="string">"$set"</span>: bson.<span class="keyword">M</span>&#123;<span class="string">"data"</span>: datainfo.Data, <span class="string">"uptime"</span>: datainfo.Uptime&#125;&#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">err</span> = c.Insert(&amp;datainfo)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> nil</span><br><span class="line">&#125;</span><br><span class="line">func ResultStat(datainfo models.DataInfo) <span class="keyword">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> <span class="keyword">err</span> <span class="keyword">error</span></span><br><span class="line">	c := models.<span class="keyword">DB</span>.C(<span class="string">"statistics"</span>)</span><br><span class="line">	mainMapping := map[string]string&#123;</span><br><span class="line">		<span class="string">"process"</span>:    <span class="string">"name"</span>,</span><br><span class="line">		<span class="string">"userlist"</span>:   <span class="string">"name"</span>,</span><br><span class="line">		<span class="string">"listening"</span>:  <span class="string">"address"</span>,</span><br><span class="line">		<span class="string">"connection"</span>: <span class="string">"remote"</span>,</span><br><span class="line">		<span class="string">"loginlog"</span>:   <span class="string">"remote"</span>,</span><br><span class="line">		<span class="string">"startup"</span>:    <span class="string">"name"</span>,</span><br><span class="line">		<span class="string">"crontab"</span>:    <span class="string">"command"</span>,</span><br><span class="line">		<span class="string">"service"</span>:    <span class="string">"name"</span>,</span><br><span class="line">		<span class="comment">// "processlist": "name",</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _, ok := mainMapping[datainfo.<span class="keyword">Type</span>]; !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> nil</span><br><span class="line">	&#125;</span><br><span class="line">	k := mainMapping[datainfo.<span class="keyword">Type</span>]</span><br><span class="line">	ip := datainfo.IP</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> datainfo.Data &#123;</span><br><span class="line">		<span class="keyword">if</span> datainfo.<span class="keyword">Type</span> == <span class="string">"connection"</span> &#123;</span><br><span class="line">			v[k] = strings.<span class="keyword">Split</span>(v[k], <span class="string">":"</span>)[0]</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">count</span>, _ := c.Find(bson.<span class="keyword">M</span>&#123;<span class="string">"info"</span>: v[k], <span class="string">"type"</span>: datainfo.<span class="keyword">Type</span>&#125;).<span class="keyword">Count</span>()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">count</span> &gt;= 1 &#123;</span><br><span class="line">			<span class="keyword">err</span> = c.<span class="keyword">Update</span>(bson.<span class="keyword">M</span>&#123;<span class="string">"info"</span>: v[k], <span class="string">"type"</span>: datainfo.<span class="keyword">Type</span>&#125;, bson.<span class="keyword">M</span>&#123;</span><br><span class="line">				<span class="string">"$set"</span>:      bson.<span class="keyword">M</span>&#123;<span class="string">"uptime"</span>: datainfo.Uptime&#125;,</span><br><span class="line">				<span class="string">"$inc"</span>:      bson.<span class="keyword">M</span>&#123;<span class="string">"count"</span>: 1&#125;,</span><br><span class="line">				<span class="string">"$addToSet"</span>: bson.<span class="keyword">M</span>&#123;<span class="string">"server_list"</span>: ip&#125;&#125;)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			serverList := []string&#123;ip&#125;</span><br><span class="line">			<span class="keyword">err</span> = c.Insert(bson.<span class="keyword">M</span>&#123;<span class="string">"type"</span>: datainfo.<span class="keyword">Type</span>, <span class="string">"info"</span>: v[k], <span class="string">"count"</span>: 1,</span><br><span class="line">				<span class="string">"server_list"</span>: serverList, <span class="string">"uptime"</span>: datainfo.Uptime&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>intit</strong></p>
<p>分别跟进models.heartbeat、action.taskthread、safecheck.scanmonitorthread、safecheck.HealthCheckThread及models.insertthread五个重要调用：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func init<span class="literal">()</span> &#123;</span><br><span class="line">	log.<span class="constructor">Println(<span class="params">models</span>.Config)</span></span><br><span class="line">	<span class="comment">// 从数据库获取证书和RSA私钥</span></span><br><span class="line">	ioutil.<span class="constructor">WriteFile(<span class="string">"cert.pem"</span>, []<span class="params">byte</span>(<span class="params">models</span>.Config.Cert)</span>, <span class="number">0666</span>)</span><br><span class="line">	ioutil.<span class="constructor">WriteFile(<span class="string">"private.pem"</span>, []<span class="params">byte</span>(<span class="params">models</span>.Config.Private)</span>, <span class="number">0666</span>)</span><br><span class="line">	<span class="comment">// 启动心跳线程</span></span><br><span class="line">	go models.<span class="constructor">Heartbeat()</span></span><br><span class="line">	<span class="comment">// 启动推送任务线程</span></span><br><span class="line">	go action.<span class="constructor">TaskThread()</span></span><br><span class="line">	<span class="comment">// 启动安全检测线程</span></span><br><span class="line">	go safecheck.<span class="constructor">ScanMonitorThread()</span></span><br><span class="line">	<span class="comment">// 启动客户端健康检测线程</span></span><br><span class="line">	go safecheck.<span class="constructor">HealthCheckThread()</span></span><br><span class="line">	<span class="comment">// ES异步写入线程</span></span><br><span class="line">	go models.<span class="constructor">InsertThread()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="models"><a href="#models" class="headerlink" title="models"></a>models</h4><p><strong>init</strong></p>
<p>参数解析不再详述，server启动后首先连接到mongodb的agent库，然后调setconfig获取数据库中的相关配置信息（控制台相关），调setrules获取异常规则，调用结果保存在全局变量中：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">func init<span class="literal">()</span> &#123;</span><br><span class="line">	mongodb = flag.<span class="constructor">String(<span class="string">"db"</span>, <span class="string">""</span>, <span class="string">"mongodb ip:port"</span>)</span></span><br><span class="line">	es = flag.<span class="constructor">String(<span class="string">"es"</span>, <span class="string">""</span>, <span class="string">"elasticsearch ip:port"</span>)</span></span><br><span class="line">	flag.<span class="constructor">Parse()</span></span><br><span class="line">	<span class="keyword">if</span> len(os.Args) &lt;= <span class="number">2</span> &#123;</span><br><span class="line">		flag.<span class="constructor">PrintDefaults()</span></span><br><span class="line">		os.<span class="constructor">Exit(1)</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> strings.<span class="constructor">HasPrefix(<span class="operator">*</span><span class="params">mongodb</span>, <span class="string">"127."</span>)</span><span class="operator"> || </span>strings.<span class="constructor">HasPrefix(<span class="operator">*</span><span class="params">mongodb</span>, <span class="string">"localhost"</span>)</span> &#123;</span><br><span class="line">		log.<span class="constructor">Println(<span class="string">"mongodb Can not be 127.0.0.1"</span>)</span></span><br><span class="line">		os.<span class="constructor">Exit(1)</span></span><br><span class="line">	&#125;</span><br><span class="line">	DB, err = conn(*mongodb, <span class="string">"agent"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		log.<span class="constructor">Println(<span class="params">err</span>.Error()</span>)</span><br><span class="line">		flag.<span class="constructor">PrintDefaults()</span></span><br><span class="line">		os.<span class="constructor">Exit(1)</span></span><br><span class="line">	&#125;</span><br><span class="line">	LocalIP, err = get<span class="constructor">LocalIP(<span class="operator">*</span><span class="params">mongodb</span>)</span></span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		log.<span class="constructor">Println(<span class="params">err</span>)</span></span><br><span class="line">		os.<span class="constructor">Exit(1)</span></span><br><span class="line">	&#125;</span><br><span class="line">	log.<span class="constructor">Println(<span class="string">"Get Config"</span>)</span></span><br><span class="line">	set<span class="constructor">Config()</span></span><br><span class="line">	set<span class="constructor">Rules()</span></span><br><span class="line">	go es<span class="constructor">CheckThread()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func setConfig() &#123;</span><br><span class="line">	c := DB.C(<span class="string">"config"</span>)</span><br><span class="line">	res := configres&#123;&#125;</span><br><span class="line">	c.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"type"</span>: <span class="string">"server"</span>&#125;).One(&amp;res)</span><br><span class="line"></span><br><span class="line">	res2 := intelligencegres&#123;&#125;</span><br><span class="line">	c.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"type"</span>: <span class="string">"intelligence"</span>&#125;).One(&amp;res2)</span><br><span class="line"></span><br><span class="line">	res3 := blackListres&#123;&#125;</span><br><span class="line">	c.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"type"</span>: <span class="string">"blacklist"</span>&#125;).One(&amp;res3)</span><br><span class="line"></span><br><span class="line">	res4 := whiteListres&#123;&#125;</span><br><span class="line">	c.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"type"</span>: <span class="string">"whitelist"</span>&#125;).One(&amp;res4)</span><br><span class="line"></span><br><span class="line">	res5 := noticeres&#123;&#125;</span><br><span class="line">	c.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"type"</span>: <span class="string">"notice"</span>&#125;).One(&amp;res5)</span><br><span class="line"></span><br><span class="line"><span class="built_in">	Config </span>= res.Dic</span><br><span class="line">	Config.Intelligence = res2.Dic</span><br><span class="line">	Config.BlackList = res3.Dic</span><br><span class="line">	Config.WhiteList = res4.Dic</span><br><span class="line">	Config.Notice = res5.Dic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">setRules</span>() &#123;</span><br><span class="line">	<span class="attribute">c </span>:= DB.<span class="built_in">C</span>(<span class="string">"rules"</span>)</span><br><span class="line">	c.<span class="built_in">Find</span>(bson.M&#123;<span class="string">"enabled"</span>: true&#125;).<span class="built_in">All</span>(&amp;RuleDB)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后起一个线程跑escheckthread检测es中是否存在monitor_2020的索引表，1h跑一次，若没有此索引，则新建：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func esCheckThread() &#123;</span><br><span class="line">	ticker := <span class="type">time</span>.NewTicker(<span class="type">time</span>.Second * <span class="number">3600</span>)</span><br><span class="line">	<span class="keyword">for</span> _ = range ticker.C &#123;</span><br><span class="line">		nowDate := <span class="type">time</span>.Now().<span class="keyword">Local</span>().Format("2006_01")</span><br><span class="line">		nowindicesName = "monitor" + nowDate</span><br><span class="line">		indexNameList, err := Client.IndexNames()</span><br><span class="line">		<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> inArray(indexNameList, nowindicesName, <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="type">time</span>.Now().<span class="keyword">Local</span>().Day() &gt;= <span class="number">28</span> &#123;</span><br><span class="line">				nextData := <span class="type">time</span>.Now().<span class="keyword">Local</span>().AddDate(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>).Format("2006_01")</span><br><span class="line">				indicesName := "monitor" + nextData</span><br><span class="line">				<span class="keyword">if</span> !inArray(indexNameList, indicesName, <span class="keyword">false</span>) &#123;</span><br><span class="line">					newIndex(indicesName)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			newIndex(nowindicesName)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>heartbeat</strong></p>
<p>心跳线程，有四个函数调用，线程调度周期为30s：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">func</span> <span class="function"><span class="title">Heartbeat</span>() &#123;</span></span><br><span class="line"><span class="function">	<span class="variable">log.Println</span>(<span class="string">"Start heartbeat thread"</span>)</span></span><br><span class="line">	<span class="variable">for</span> &#123;</span><br><span class="line">		<span class="function"><span class="title">mgoCheck</span>()</span></span><br><span class="line">		<span class="function"><span class="title">regServer</span>()</span></span><br><span class="line">		<span class="function"><span class="title">setConfig</span>()</span></span><br><span class="line">		<span class="function"><span class="title">setRules</span>()</span></span><br><span class="line">		<span class="variable">time.Sleep</span>(<span class="variable">time.Second</span> * <span class="number">30</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>mgocheck</strong></p>
<p>检测mongodb session是否过期，若过期，则刷新session：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">mgoCheck</span>() &#123;</span><br><span class="line">	<span class="attribute">err </span>:= DB.Session.<span class="built_in">Ping</span>()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.<span class="built_in">Println</span>(err.Error())</span><br><span class="line">		DB.Session.<span class="built_in">Refresh</span>()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>regServer</strong></p>
<p>修改mongo中的server表项更新server信息：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func regServer() &#123;</span><br><span class="line">	c := DB.C(<span class="string">"server"</span>)</span><br><span class="line">	_, <span class="built_in">err</span> := c.Upsert(bson.M&#123;<span class="string">"netloc"</span>: LocalIP + <span class="string">":33433"</span>&#125;, bson.M&#123;<span class="string">"$set"</span>: bson.M&#123;<span class="string">"uptime"</span>: <span class="built_in">time</span>.<span class="built_in">Now</span>()&#125;&#125;)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">err</span> != nil &#123;</span><br><span class="line">		<span class="built_in">log</span>.Println(<span class="built_in">err</span>.<span class="keyword">Error</span>())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setconfig与setrules在init中已有说明</p>
<h4 id="action"><a href="#action" class="headerlink" title="action"></a>action</h4><p><strong>taskthread</strong></p>
<p>开启任务线程，从mongo中的queue表中获取每一条任务，调用sendtask进行任务下发：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TaskThread</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"Start Task Thread"</span>)</span><br><span class="line">	threadpool = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">100</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		res := queue&#123;&#125;</span><br><span class="line">		change := mgo.Change&#123;</span><br><span class="line">			Remove: <span class="literal">true</span>,</span><br><span class="line">		&#125;</span><br><span class="line">		models.DB.C(<span class="string">"queue"</span>).Find(bson.M&#123;&#125;).Limit(<span class="number">1</span>).Apply(change, &amp;res)</span><br><span class="line">		<span class="keyword">if</span> res.IP == <span class="string">""</span> &#123;</span><br><span class="line">			time.Sleep(time.Second * <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		threadpool &lt;- <span class="literal">true</span></span><br><span class="line">		<span class="keyword">go</span> sendTask(res, threadpool)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sendtask</strong></p>
<p>向client的daemon守护进程所在的tcp：65512端口主动发起连接，并将经rsa加密过后的任务事件压入socket中发送给daemon，并从socket中接收来自daemon的返回结果，格式化后写入task_result表中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendTask</span><span class="params">(task queue, threadpool <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-threadpool</span><br><span class="line">	&#125;()</span><br><span class="line">	sendData := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"type"</span>: task.Type, <span class="string">"command"</span>: task.Command&#125;</span><br><span class="line">	<span class="keyword">if</span> data, err := json.Marshal(sendData); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		conn, err := net.DialTimeout(<span class="string">"tcp"</span>, task.IP+<span class="string">":65512"</span>, time.Second*<span class="number">3</span>)</span><br><span class="line">		log.Println(<span class="string">"sendtask:"</span>, task.IP, sendData)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			saveError(task, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> conn.Close()</span><br><span class="line">		encryptData, err := rsaEncrypt(data)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			saveError(task, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		conn.Write([]<span class="keyword">byte</span>(base64.RawStdEncoding.EncodeToString(encryptData) + <span class="string">"\n"</span>))</span><br><span class="line">		reader := bufio.NewReader(conn)</span><br><span class="line">		msg, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(msg) == <span class="number">0</span> &#123;</span><br><span class="line">			saveError(task, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(conn.RemoteAddr().String(), msg)</span><br><span class="line">		res := taskResult&#123;&#125;</span><br><span class="line">		err = json.Unmarshal([]<span class="keyword">byte</span>(msg), &amp;res)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			saveError(task, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		res.TaskID = task.TaskID</span><br><span class="line">		res.Time = time.Now()</span><br><span class="line">		res.IP = task.IP</span><br><span class="line">		c := models.DB.C(<span class="string">"task_result"</span>)</span><br><span class="line">		err = c.Insert(&amp;res)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			saveError(task, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="safecheck"><a href="#safecheck" class="headerlink" title="safecheck"></a>safecheck</h4><p><strong>ScanMonitorThread</strong></p>
<p>开启监控扫描线程，此线程又创建10个子线程，每个线程调用run函数进行检查：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ScanMonitorThread</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"Start Scan Thread"</span>)</span><br><span class="line">	<span class="comment">// 10个检测goroutine</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			c := <span class="built_in">new</span>(Check)</span><br><span class="line">			c.CStatistics = models.DB.C(<span class="string">"statistics"</span>)</span><br><span class="line">			c.CNoice = models.DB.C(<span class="string">"notice"</span>)</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				c.Info = &lt;-ScanChan</span><br><span class="line">				c.Run()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	ticker := time.NewTicker(time.Second * <span class="number">60</span>)</span><br><span class="line">	<span class="keyword">for</span> _ = <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">		cache = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(<span class="built_in">c</span> *Check)</span></span> <span class="type">Run</span>() &#123;</span><br><span class="line">	<span class="keyword">for</span> <span class="number">_</span>, <span class="built_in">c</span>.<span class="type">V</span> = range <span class="built_in">c</span>.<span class="type">Info</span>.<span class="type">Data</span> &#123;</span><br><span class="line">		<span class="built_in">c</span>.<span class="type">BlackFilter</span>()</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">c</span>.<span class="type">WhiteFilter</span>() &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">c</span>.<span class="type">Rules</span>()</span><br><span class="line">		<span class="built_in">c</span>.<span class="type">Intelligence</span>()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>info.data为agent传给server的所有事件，对其进行黑白名单的匹配，黑白名单在server初始化时从mongo中获取，即setconfig、setrules等函数，不再赘述；c.rules进行规则匹配，以下为本项目的规则引擎：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">func (c *Check) Rules() &#123;</span><br><span class="line">	<span class="attribute">for _, r</span> := range models<span class="variable">.RuleDB</span> &#123;</span><br><span class="line">		var vulInfo []string</span><br><span class="line">		if (c<span class="variable">.Info</span><span class="variable">.System</span> != r<span class="variable">.System</span> &amp;&amp; r<span class="variable">.System</span> != "all") || c<span class="variable">.Info</span><span class="variable">.Type</span> != r<span class="variable">.Source</span> &#123;</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		i := len(r<span class="variable">.Rules</span>)</span><br><span class="line">		// log<span class="variable">.Println</span>(r<span class="variable">.Rules</span>)</span><br><span class="line">		for k, rule := range r<span class="variable">.Rules</span> &#123;</span><br><span class="line">			switch rule<span class="variable">.Type</span> &#123;</span><br><span class="line">			case "regex":</span><br><span class="line">				reg := regexp<span class="variable">.MustCompile</span>(rule<span class="variable">.Data</span>)</span><br><span class="line">				if reg<span class="variable">.MatchString</span>(strings<span class="variable">.ToLower</span>(c<span class="variable">.V</span>[k])) &#123;</span><br><span class="line">					i--</span><br><span class="line">					vulInfo = append(vulInfo, c<span class="variable">.V</span>[k])</span><br><span class="line">				&#125;</span><br><span class="line">			case "non-regex":</span><br><span class="line">				reg := regexp<span class="variable">.MustCompile</span>(rule<span class="variable">.Data</span>)</span><br><span class="line">				if c<span class="variable">.V</span>[k] != "" &amp;&amp; !reg<span class="variable">.MatchString</span>(strings<span class="variable">.ToLower</span>(c<span class="variable">.V</span>[k])) &#123;</span><br><span class="line">					i--</span><br><span class="line">					vulInfo = append(vulInfo, c<span class="variable">.V</span>[k])</span><br><span class="line">				&#125;</span><br><span class="line">			case "string":</span><br><span class="line">				if strings<span class="variable">.ToLower</span>(c<span class="variable">.V</span>[k]) == strings<span class="variable">.ToLower</span>(rule<span class="variable">.Data</span>) &#123;</span><br><span class="line">					i--</span><br><span class="line">					vulInfo = append(vulInfo, c<span class="variable">.V</span>[k])</span><br><span class="line">				&#125;</span><br><span class="line">			case "count":</span><br><span class="line">				if models<span class="variable">.Config</span><span class="variable">.Learn</span> &#123;</span><br><span class="line">					i--</span><br><span class="line">					vulInfo = append(vulInfo, c<span class="variable">.V</span>[k])</span><br><span class="line">					continue</span><br><span class="line">				&#125;</span><br><span class="line">				var statsinfo stats</span><br><span class="line">				var keyword string</span><br><span class="line">				if c<span class="variable">.Info</span><span class="variable">.Type</span> == "connection" &#123;</span><br><span class="line">					keyword = strings<span class="variable">.Split</span>(c<span class="variable">.V</span>[k], ":")[0]</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					keyword = c<span class="variable">.V</span>[k]</span><br><span class="line">				&#125;</span><br><span class="line">				err := c<span class="variable">.CStatistics</span><span class="variable">.Find</span>(bson<span class="variable">.M</span>&#123;"type": r<span class="variable">.Source</span>, "info": keyword&#125;)<span class="variable">.One</span>(&amp;statsinfo)</span><br><span class="line">				if err != nil &#123;</span><br><span class="line">					log<span class="variable">.Println</span>(err<span class="variable">.Error</span>(), r<span class="variable">.Source</span>, keyword)</span><br><span class="line">					break</span><br><span class="line">				&#125;</span><br><span class="line">				n, err := strconv<span class="variable">.Atoi</span>(rule<span class="variable">.Data</span>)</span><br><span class="line">				if err != nil &#123;</span><br><span class="line">					log<span class="variable">.Println</span>(err<span class="variable">.Error</span>())</span><br><span class="line">					break</span><br><span class="line">				&#125;</span><br><span class="line">				if statsinfo<span class="variable">.Count</span> == n &#123;</span><br><span class="line">					i--</span><br><span class="line">					vulInfo = append(vulInfo, c<span class="variable">.V</span>[k])</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if r<span class="variable">.And</span> &#123;</span><br><span class="line">			if i == 0 &#123;</span><br><span class="line">				c<span class="variable">.Source</span> = r<span class="variable">.Meta</span><span class="variable">.Name</span></span><br><span class="line">				c<span class="variable">.Level</span> = r<span class="variable">.Meta</span><span class="variable">.Level</span></span><br><span class="line">				c<span class="variable">.Description</span> = r<span class="variable">.Meta</span><span class="variable">.Description</span></span><br><span class="line">				sort<span class="variable">.Strings</span>(vulInfo)</span><br><span class="line">				c<span class="variable">.Value</span> = strings<span class="variable">.Join</span>(vulInfo, "|")</span><br><span class="line">				c<span class="variable">.warning</span>()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else if i &lt; len(r<span class="variable">.Rules</span>) &#123;</span><br><span class="line">			c<span class="variable">.Source</span> = r<span class="variable">.Meta</span><span class="variable">.Name</span></span><br><span class="line">			c<span class="variable">.Level</span> = r<span class="variable">.Meta</span><span class="variable">.Level</span></span><br><span class="line">			c<span class="variable">.Description</span> = r<span class="variable">.Meta</span><span class="variable">.Description</span></span><br><span class="line">			sort<span class="variable">.Strings</span>(vulInfo)</span><br><span class="line">			c<span class="variable">.Value</span> = strings<span class="variable">.Join</span>(vulInfo, "|")</span><br><span class="line">			c<span class="variable">.warning</span>()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>intelligence</strong></p>
<p>首先判断威胁情报的配置开关是否开启，若未开启，则直接结束；从网络事件/登陆事件/文件事件中取出remote_ip/hash，格式化后提交到自定义的威胁情报接口（控制台），通过自定义威胁正则与威胁情报api返回结果的正则匹配判断具体事件对应的ip/文件是否为恶意：</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">func (c *Check) Intelligence() &#123;</span><br><span class="line">	<span class="attribute">if !models.Config.Intelligence.Switch &#123;</span></span><br><span class="line"><span class="attribute">		return</span></span><br><span class="line"><span class="attribute">	&#125;</span></span><br><span class="line"><span class="attribute">	if c.Info.Type == "connection" || c.Info.Type == "loginlog" &#123;</span></span><br><span class="line"><span class="attribute">		ip</span> := strings<span class="variable">.Split</span>(c<span class="variable">.V</span>["remote"], ":")[0]</span><br><span class="line">		if isLan(ip) &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		if inArray(cache, c<span class="variable">.Info</span><span class="variable">.Type</span>+c<span class="variable">.Info</span><span class="variable">.IP</span>+ip, false) &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		cache = append(cache, c<span class="variable">.Info</span><span class="variable">.Type</span>+c<span class="variable">.Info</span><span class="variable">.IP</span>+ip)</span><br><span class="line">		url := strings<span class="variable">.Replace</span>(models<span class="variable">.Config</span><span class="variable">.Intelligence</span><span class="variable">.IPAPI</span>, "&#123;$ip&#125;", ip, 1)</span><br><span class="line">		resp, err := http<span class="variable">.Get</span>(url)</span><br><span class="line">		if err != nil &#123;</span><br><span class="line">			return</span><br><span class="line">		&#125;</span><br><span class="line">		defer resp<span class="variable">.Body</span><span class="variable">.Close</span>()</span><br><span class="line">		body, _ := ioutil<span class="variable">.ReadAll</span>(resp<span class="variable">.Body</span>)</span><br><span class="line">		reg := regexp<span class="variable">.MustCompile</span>(models<span class="variable">.Config</span><span class="variable">.Intelligence</span><span class="variable">.Regex</span>)</span><br><span class="line">		if reg<span class="variable">.Match</span>(body) &#123;</span><br><span class="line">			c<span class="variable">.Source</span> = "威胁情报接口"</span><br><span class="line">			c<span class="variable">.Level</span> = 0</span><br><span class="line">			c<span class="variable">.Description</span> = "威胁情报接口显示此IP存在风险"</span><br><span class="line">			c<span class="variable">.Value</span> = ip</span><br><span class="line">			c<span class="variable">.warning</span>()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else if c<span class="variable">.Info</span><span class="variable">.Type</span> == "file" &#123;</span><br><span class="line">		if c<span class="variable">.V</span>["hash"] != "" &#123;</span><br><span class="line">			if inArray(cache, c<span class="variable">.Info</span><span class="variable">.Type</span>+c<span class="variable">.Info</span><span class="variable">.IP</span>+c<span class="variable">.V</span>["hash"], false) &#123;</span><br><span class="line">				return</span><br><span class="line">			&#125;</span><br><span class="line">			cache = append(cache, c<span class="variable">.Info</span><span class="variable">.Type</span>+c<span class="variable">.Info</span><span class="variable">.IP</span>+c<span class="variable">.V</span>["hash"])</span><br><span class="line">			url := strings<span class="variable">.Replace</span>(models<span class="variable">.Config</span><span class="variable">.Intelligence</span><span class="variable">.FileAPI</span>, "&#123;$hash&#125;", c<span class="variable">.V</span>["hash"], 1)</span><br><span class="line">			resp, err := http<span class="variable">.Get</span>(url)</span><br><span class="line">			if err != nil &#123;</span><br><span class="line">				return</span><br><span class="line">			&#125;</span><br><span class="line">			defer resp<span class="variable">.Body</span><span class="variable">.Close</span>()</span><br><span class="line">			body, _ := ioutil<span class="variable">.ReadAll</span>(resp<span class="variable">.Body</span>)</span><br><span class="line">			reg := regexp<span class="variable">.MustCompile</span>(models<span class="variable">.Config</span><span class="variable">.Intelligence</span><span class="variable">.Regex</span>)</span><br><span class="line">			if reg<span class="variable">.Match</span>(body) &#123;</span><br><span class="line">				c<span class="variable">.Source</span> = "威胁情报接口"</span><br><span class="line">				c<span class="variable">.Level</span> = 0</span><br><span class="line">				c<span class="variable">.Description</span> = "威胁情报接口显示此文件存在风险"</span><br><span class="line">				c<span class="variable">.Value</span> = c<span class="variable">.V</span>["hash"]</span><br><span class="line">				c<span class="variable">.warning</span>()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>healthcheckthread</strong></p>
<p>客户端健康状态检测线程，包含离线检测、自动清理、连通性检测：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">func</span> <span class="function"><span class="title">HealthCheckThread</span>() &#123;</span></span><br><span class="line"><span class="function">	<span class="variable">log.Println</span>(<span class="string">"Start Health Check Thread"</span>)</span></span><br><span class="line">	<span class="variable">go</span> <span class="function"><span class="title">offlineCheckThread</span>()</span></span><br><span class="line">	<span class="variable">go</span> <span class="function"><span class="title">cleanThread</span>()</span></span><br><span class="line">	<span class="function"><span class="title">firewallCheckThread</span>()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>offlinecheckthread</strong></p>
<p>离线检测告警，离线场景判定，健康状态设定（0、1、2）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">offlineCheckThread</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> oneMinuteAgo time.Time</span><br><span class="line">	<span class="keyword">var</span> offlineIPList []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> msg <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> cache []<span class="keyword">string</span></span><br><span class="line">	client := models.DB.C(<span class="string">"client"</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ticker := time.NewTicker(time.Hour * <span class="number">24</span>)</span><br><span class="line">		<span class="keyword">for</span> _ = <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">			cache = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		oneMinuteAgo = time.Now().Add(time.Minute * time.Duration(<span class="number">-5</span>))</span><br><span class="line">		err := client.Find(bson.M&#123;<span class="string">"uptime"</span>: bson.M&#123;<span class="string">"$lte"</span>: oneMinuteAgo&#125;&#125;).Distinct(<span class="string">"ip"</span>, &amp;offlineIPList)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err.Error())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 超过20台掉线直接告警</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(offlineIPList) &gt;= <span class="number">20</span> &#123;</span><br><span class="line">			err = models.DB.C(<span class="string">"notice"</span>).Insert(bson.M&#123;<span class="string">"type"</span>: <span class="string">"abnormal"</span>, <span class="string">"ip"</span>: offlineIPList[<span class="number">0</span>], <span class="string">"source"</span>: <span class="string">"服务异常"</span>, <span class="string">"level"</span>: <span class="number">1</span>,</span><br><span class="line">				<span class="string">"info"</span>: offlineIPList[<span class="number">0</span>], <span class="string">"description"</span>: <span class="string">"大量主机异常下线，需尽快排查原因。"</span>, <span class="string">"status"</span>: <span class="number">0</span>, <span class="string">"time"</span>: time.Now()&#125;)</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				msg = fmt.Sprintf(<span class="string">"IP:%s,Type:%s,Info:大量主机异常下线，需尽快排查原因。"</span>, offlineIPList[<span class="number">0</span>], <span class="string">"abnormal"</span>)</span><br><span class="line">				sendNotice(<span class="number">0</span>, msg)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, ip := <span class="keyword">range</span> offlineIPList &#123;</span><br><span class="line">			<span class="comment">// 健康状态设置为离线 (0健康 1离线 2存在防火墙阻拦)</span></span><br><span class="line">			client.Update(bson.M&#123;<span class="string">"ip"</span>: ip&#125;, bson.M&#123;<span class="string">"$set"</span>: bson.M&#123;<span class="string">"health"</span>: <span class="number">1</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 如果开启了离线检测通知才进行ICMP判断并写入警告</span></span><br><span class="line">			<span class="keyword">if</span> !models.Config.OfflineCheck || <span class="built_in">len</span>(offlineIPList) &gt;= <span class="number">20</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 机器存活但服务中断5分钟</span></span><br><span class="line">			<span class="keyword">if</span> ping.Ping(ip, <span class="number">3</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> inArray(cache, ip, <span class="literal">false</span>) &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				cache = <span class="built_in">append</span>(cache, ip)</span><br><span class="line">				err = models.DB.C(<span class="string">"notice"</span>).Insert(bson.M&#123;<span class="string">"type"</span>: <span class="string">"abnormal"</span>, <span class="string">"ip"</span>: ip, <span class="string">"source"</span>: <span class="string">"服务异常"</span>, <span class="string">"level"</span>: <span class="number">1</span>,</span><br><span class="line">					<span class="string">"info"</span>: ip, <span class="string">"description"</span>: <span class="string">"主机存活但服务未正常工作，可能为被入侵者关闭。"</span>, <span class="string">"status"</span>: <span class="number">0</span>, <span class="string">"time"</span>: time.Now()&#125;)</span><br><span class="line">				<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">					msg = fmt.Sprintf(<span class="string">"IP:%s,Type:%s,Info:主机存活但服务未正常工作，可能为被入侵者关闭。"</span>, ip, <span class="string">"abnormal"</span>)</span><br><span class="line">					sendNotice(<span class="number">0</span>, msg)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					log.Println(err.Error())</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		time.Sleep(time.Second * <span class="number">30</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>cleanThread</strong></p>
<p>离线超过72h从mongo的client表中删除对应主机信息，若已离线主机超过100台，则停止修改client表：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func cleanThread() &#123;</span><br><span class="line"><span class="built_in">	client </span>:= models.DB.C(<span class="string">"client"</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		var offlineIPList []string</span><br><span class="line">		err := client.<span class="builtin-name">Find</span>(bson.M&#123;<span class="string">"uptime"</span>: bson.M&#123;<span class="string">"<span class="variable">$lte</span>"</span>: time.Now().<span class="builtin-name">Add</span>(time.Hour * time.Duration(-72))&#125;&#125;).Distinct(<span class="string">"ip"</span>, &amp;offlineIPList)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">"Mongodb query error in cleanThread:"</span>, err.<span class="builtin-name">Error</span>())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> len(offlineIPList) &gt;= 100 &#123;</span><br><span class="line">			time.Sleep(time.Second * 60)</span><br><span class="line">			continue</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _,<span class="built_in"> ip </span>:= range offlineIPList &#123;</span><br><span class="line">			err = models.DB.C(<span class="string">"client"</span>).<span class="builtin-name">Remove</span>(bson.M&#123;<span class="string">"ip"</span>: ip&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(<span class="string">"Mongodb remove error in cleanThread:"</span>, err.<span class="builtin-name">Error</span>())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		time.Sleep(time.Second * 60)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>firewallcheckthread</strong></p>
<p>检测mongo client表中健康的主机ip：65512端口能否连接，即检测与daemon的连接能力，若无法连接，则修改client的health状态为2；反之若health状态为2的主机发现可以联通，则恢复健康状态：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">firewallCheckThread</span><span class="params">()</span></span> &#123;</span><br><span class="line">	client := models.DB.C(<span class="string">"client"</span>)</span><br><span class="line">	<span class="keyword">var</span> onlineIPList []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> errIPList []<span class="keyword">string</span></span><br><span class="line">	ticker := time.NewTicker(time.Second * <span class="number">60</span>)</span><br><span class="line">	<span class="keyword">for</span> _ = <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">		client.Find(bson.M&#123;<span class="string">"health"</span>: <span class="number">0</span>&#125;).Distinct(<span class="string">"ip"</span>, &amp;onlineIPList)</span><br><span class="line">		<span class="keyword">for</span> _, ip := <span class="keyword">range</span> onlineIPList &#123;</span><br><span class="line">			conn, err := net.DialTimeout(<span class="string">"tcp"</span>, ip+<span class="string">":65512"</span>, time.Second*<span class="number">3</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				client.Update(bson.M&#123;<span class="string">"ip"</span>: ip&#125;, bson.M&#123;<span class="string">"$set"</span>: bson.M&#123;<span class="string">"health"</span>: <span class="number">2</span>&#125;&#125;)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				conn.Close()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 恢复状态</span></span><br><span class="line">		client.Find(bson.M&#123;<span class="string">"health"</span>: <span class="number">2</span>&#125;).Distinct(<span class="string">"ip"</span>, &amp;errIPList)</span><br><span class="line">		<span class="keyword">for</span> _, ip := <span class="keyword">range</span> errIPList &#123;</span><br><span class="line">			conn, err := net.DialTimeout(<span class="string">"tcp"</span>, ip+<span class="string">":65512"</span>, time.Second*<span class="number">3</span>)</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				client.Update(bson.M&#123;<span class="string">"ip"</span>: ip&#125;, bson.M&#123;<span class="string">"$set"</span>: bson.M&#123;<span class="string">"health"</span>: <span class="number">0</span>&#125;&#125;)</span><br><span class="line">				conn.Close()</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>insertthread</strong></p>
<p>异步的es写入线程，如果请求数量&gt;100或者请求体大小大于2MB则进行提交写入；同时每30s也进行一次写入：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func InsertThread() &#123;</span><br><span class="line">	<span class="built_in">var</span> <span class="built_in">data</span> esData</span><br><span class="line">	p, err := Client.BulkProcessor().</span><br><span class="line">		Name(<span class="string">"YulongWorker-1"</span>).</span><br><span class="line">		Workers(<span class="number">2</span>).</span><br><span class="line">		BulkActions(<span class="number">100</span>).                <span class="comment">// commit if # requests &gt;= 100</span></span><br><span class="line">		BulkSize(<span class="number">2</span> &lt;&lt; <span class="number">20</span>).               <span class="comment">// commit if size of requests &gt;= 2 MB</span></span><br><span class="line">		FlushInterval(<span class="number">30</span> * time.Second). <span class="comment">// commit every 30s</span></span><br><span class="line">		<span class="keyword">Do</span>(context.Background())</span><br><span class="line">	<span class="keyword">if</span> err != nil &#123;</span><br><span class="line">		<span class="keyword">log</span>.Println(<span class="string">"start BulkProcessor: "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	for &#123;</span><br><span class="line">		<span class="built_in">data</span> = &lt;<span class="params">-esChan</span></span><br><span class="line">		p.Add(elastic.NewBulkIndexRequest().Index(nowindicesName).<span class="keyword">Type</span>(<span class="built_in">data</span>.dataType).Doc(<span class="built_in">data</span>.<span class="built_in">data</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Database-1"><a href="#Database-1" class="headerlink" title="Database"></a>Database</h3><h4 id="mongodb"><a href="#mongodb" class="headerlink" title="mongodb"></a>mongodb</h4><p>数据存放在agent库，库中有client、config、file、info、notice、queue、rules、server、statistics、task、task_result几张表：</p>
<p><img src="./image-20201021174332979.png" alt="image-20201021174332979"></p>
<p><strong>client</strong></p>
<p>保存agent所在主机信息，client相对于server而言：</p>
<p><img src="./image-20201021174837323.png" alt="image-20201021174837323"></p>
<p><strong>config</strong></p>
<p>保存控制台设置中的所有配置信息：</p>
<p><img src="./image-20201021175031736.png" alt="image-20201021175031736"></p>
<p><strong>file</strong></p>
<p>创建服务时上传的build好的文件（agent、daemon、data.zip）:</p>
<p><img src="./image-20201021175143860.png" alt="image-20201021175143860"></p>
<p><strong>info</strong></p>
<p>存储agent定时收集的主机信息，即agent/collect中子模块中收集的部分数据（userlist、listening、processlist），在主机列表/信息/界面下可以看到渲染后的数据：</p>
<p><img src="./image-20201021175514821.png" alt="image-20201021175514821"></p>
<p><strong>notice</strong></p>
<p>notice存放规则匹配的告警事件，status标识处理状态，0表示未处理，1表示已处理，2表示忽略：</p>
<p><img src="./image-20201021175932368.png" alt="image-20201021175932368"></p>
<p><strong>queue</strong></p>
<p>猜测是server创建任务时当作任务队列用的，可能取的速度很快，所以每次看queue里面都没有数据</p>
<p><strong>rules</strong></p>
<p>存放server端存储的规则：</p>
<p><img src="./image-20201021190200612.png" alt="image-20201021190200612"></p>
<p><strong>server</strong></p>
<p>服务启动信息：</p>
<p><img src="./image-20201021190248527.png" alt="image-20201021190248527"></p>
<p><strong>statistics</strong></p>
<p>存放事件统计后的结果表</p>
<p><strong>task</strong></p>
<p>server创建和下发的任务具体数据和字段：</p>
<p><img src="./image-20201021191240242.png" alt="image-20201021191240242"></p>
<p><strong>task_result</strong></p>
<p>存放任务执行后的结果，在任务/查看结果/界面可以看到具体被渲染后的任务结果数据：</p>
<p><img src="./image-20201021191457781.png" alt="image-20201021191457781"></p>
<h4 id="es"><a href="#es" class="headerlink" title="es"></a>es</h4><p>es中的事件类型能看到的有file、process、loginlog，应该还能有connection事件的，但是这边没有看到emmmm</p>
<p><img src="./image-20201022101107922.png" alt="image-20201022101107922"></p>
<p><img src="./image-20201021192848216.png" alt="image-20201021192848216"></p>
<p>文件操作事件字段：</p>
<p><img src="./image-20201021193030185.png" alt="image-20201021193030185"></p>
<p>进程操作事件字段：</p>
<p><img src="./image-20201021193119756.png" alt="image-20201021193119756"></p>
<p>登陆日志事件字段：</p>
<p><img src="./image-20201021193203519.png" alt="image-20201021193203519"></p>
<h3 id="Web-1"><a href="#Web-1" class="headerlink" title="Web"></a>Web</h3><p>to be continued</p>
<h2 id="五、问题"><a href="#五、问题" class="headerlink" title="五、问题"></a>五、问题</h2><p>yulong作为国内第一个开源hids项目虽然给人带来不少惊喜，但是不可否认还是存在很多问题的，后续不再维护确实很可惜；通过对源码的分析总结出来如下一些问题：</p>
<p>1、技术选型</p>
<p>spoock师傅说过，不谈场景，说合适不合适那都是耍流氓，hook execve的lkm在甲方安全建设的场景中确实无可厚非，甲方对内部资产的熟悉掌握和控制本来就是其优势所在，这点不能说啥；问题主要在于用libpcap的流量回调方式去捕获事件实在是非常粗糙，首先有非常大的可能存在数据丢失（遍历/proc花费大量时间，丢失pid），其次拿流量做信号去遍历/proc，流量少还好，流量一多，负载会高到爆炸，这点有测过，cpu主要占用在遍历那一块了，而且本身libpcap没有比较可控的接口；然后文件监控这块用的是inotify，问题是这样就拿不到pid了，只能做文件完整性检测，不太好做后续分析、关联等等</p>
<p>2、规则</p>
<p>项目提供的默认规则太简单和宽泛了，甚至包含一些错误，比如：</p>
<p><img src="./image-20201022120401573.png" alt="image-20201022120401573"></p>
<p><img src="./image-20201022120423447.png" alt="image-20201022120423447"></p>
<p>有些不太精确，比如：</p>
<p><img src="./image-20201022120739280.png" alt="image-20201022120739280"></p>
<p>另外规则引擎的匹配算法没有做优化，规则或者事件一旦多起来，server的负载会很高</p>
<p>有些太宽泛导致误报非常高：</p>
<p><img src="./image-20201022121056325.png" alt="image-20201022121056325"></p>
<p><img src="./image-20201022121152354.png" alt="image-20201022121152354"></p>
<p>agent在测试机才装2天就有近6w条告警，这是无法运营的，当然，规则支持细粒度控制（开关）还是很不错的</p>
<p>3、功能</p>
<p>功能类型较少，功能模块划分不够细，比如没有单独的入侵检测模块，无法根据危险等级筛选告警，只能一个个去看，根据规则类型判断是否是入侵事件，没有针对性的审计告警是非常耗时的，特别是在告警数量特别庞大的情况下；</p>
<p>4、etc.</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>针对yulong-hids的功能原理、架构设计、代码结构、源码实现进行了比较粗糙的剖析，大致熟悉了一个经典hids的内部构造；分析的过程就像是读一部从未读过的经典小说，各函数间的层层调用就像小说情节的环环相扣，而作为一个读者，就在这一个个函数、一层层调用间感受作者的真意；读完全部源码后依稀有点恋恋不舍，不禁感叹工程之美，感叹源码之美，感叹设计之美；</p>
<p>针对本篇中未分析的process_monitor模块，后续将在其它篇中继续进行分析</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag"># 源码分析</a>
              <a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" rel="tag"># 二进制</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/09/24/Linux%E7%8E%AF%E5%A2%83%E4%B8%8BELF%E6%97%A0%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C%E4%B8%8E%E6%A3%80%E6%B5%8B/" rel="prev" title="Linux环境下ELF无文件执行与检测">
                  <i class="fa fa-chevron-left"></i> Linux环境下ELF无文件执行与检测
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/10/22/Yulong-Hids-Process-Monitor-Principle-Analysis/" rel="next" title="Yulong-Hids Process Monitor Principle Analysis">
                  Yulong-Hids Process Monitor Principle Analysis <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XDW</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>



    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  

</body>
</html>
