<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic|Lobster+Two:300,300italic,400,400italic,700,700italic|EB+Garamond:300,300italic,400,400italic,700,700italic|Roboto+Slab:300,300italic,400,400italic,700,700italic|Source+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"driverxdw.github.io","root":"/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":true,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>

  <meta name="description" content="一、起源大四第一次实习期间曾在公司项目中接触过这个东西，当时还不太了解应用场景，只当成是一个查询主机信息（query os）的普通跨平台开源项目，觉得它用sql进行查询的设计方式很奇怪；第三次实习期间实验室老大手把手教着写安全模型，其中模型计算所用的数据就是osquery在vpc里采集来的，那时才对osquery这类主机数据采集的应用场景有了些了解；后来真正投身主机安全领域才慢慢了解到osquer">
<meta property="og:type" content="article">
<meta property="og:title" content="Osquery检测框架初探">
<meta property="og:url" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="in0va&#39;S Blog  JustLearnM0re">
<meta property="og:description" content="一、起源大四第一次实习期间曾在公司项目中接触过这个东西，当时还不太了解应用场景，只当成是一个查询主机信息（query os）的普通跨平台开源项目，觉得它用sql进行查询的设计方式很奇怪；第三次实习期间实验室老大手把手教着写安全模型，其中模型计算所用的数据就是osquery在vpc里采集来的，那时才对osquery这类主机数据采集的应用场景有了些了解；后来真正投身主机安全领域才慢慢了解到osquer">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/image-20201029111821393.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/image-20201029152149095.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/image-20201029144955777.png">
<meta property="og:image" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/image-20201029150410846.png">
<meta property="article:published_time" content="2020-10-27T16:00:55.000Z">
<meta property="article:modified_time" content="2020-10-29T08:28:56.194Z">
<meta property="article:author" content="XDW">
<meta property="article:tag" content="二进制">
<meta property="article:tag" content="开源">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/image-20201029111821393.png">


<link rel="canonical" href="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Osquery检测框架初探 | in0va'S Blog  JustLearnM0re</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">in0va'S Blog  JustLearnM0re</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">犯二</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">69</span></a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、起源"><span class="nav-number">1.</span> <span class="nav-text">一、起源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、基本使用"><span class="nav-number">2.</span> <span class="nav-text">二、基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#介绍"><span class="nav-number">2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行"><span class="nav-number">2.3.</span> <span class="nav-text">运行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#osqueryi"><span class="nav-number">2.3.1.</span> <span class="nav-text">osqueryi</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#osqueryd"><span class="nav-number">2.3.2.</span> <span class="nav-text">osqueryd</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、问题"><span class="nav-number">3.</span> <span class="nav-text">三、问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、auditd占用"><span class="nav-number">3.1.</span> <span class="nav-text">1、auditd占用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、osqueryi和osqueryd同时运行"><span class="nav-number">3.2.</span> <span class="nav-text">2、osqueryi和osqueryd同时运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-etc"><span class="nav-number">3.3.</span> <span class="nav-text">3.etc.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、总结"><span class="nav-number">4.</span> <span class="nav-text">四、总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、参考链接"><span class="nav-number">5.</span> <span class="nav-text">五、参考链接</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XDW"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">XDW</p>
  <div class="site-description" itemprop="description">一枚很菜但是仍在学习的二进制菜逼</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.ixuchao.cn/" title="https:&#x2F;&#x2F;blog.ixuchao.cn&#x2F;" rel="noopener" target="_blank">Archerx's Blog</a>
        </li>
    </ul>
  </div>

      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://driverxdw.github.io/2020/10/28/Osquery%E6%A3%80%E6%B5%8B%E6%A1%86%E6%9E%B6%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="XDW">
      <meta itemprop="description" content="一枚很菜但是仍在学习的二进制菜逼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="in0va'S Blog  JustLearnM0re">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Osquery检测框架初探
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-28 00:00:55" itemprop="dateCreated datePublished" datetime="2020-10-28T00:00:55+08:00">2020-10-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-10-29 16:28:56" itemprop="dateModified" datetime="2020-10-29T16:28:56+08:00">2020-10-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="一、起源"><a href="#一、起源" class="headerlink" title="一、起源"></a>一、起源</h2><p>大四第一次实习期间曾在公司项目中接触过这个东西，当时还不太了解应用场景，只当成是一个查询主机信息（query os）的普通跨平台开源项目，觉得它用sql进行查询的设计方式很奇怪；第三次实习期间实验室老大手把手教着写安全模型，其中模型计算所用的数据就是osquery在vpc里采集来的，那时才对osquery这类主机数据采集的应用场景有了些了解；后来真正投身主机安全领域才慢慢了解到osquery应用场景还是挺广泛的，目前国内也有很多甲方厂商在安全建设中用直接用它来做数据采集（包括一些知名厂子），而此项目之所以受到甲方安全欢迎，很大程度上包含以下几点原因：</p>
<a id="more"></a>

<p>1、轮子</p>
<p>2、稳定</p>
<p>3、扩展</p>
<p>首先很多甲方安全部门可能人比较少，甚至存在一个人的安全部，直接用轮子相比从头自研工作量小踩坑少见效快，只要环境不是太过特殊，或者对安全有非常高的要求，其实没有必要定制化；其次，osquery这个项目从2014年开源起已经过去很久了，加上不那么侵入的技术选型和各种优化，它的稳定性还是有一个比较好的保障（技术特性+时间考验+大众审计+业界反馈），而稳定恰恰是甲方最关心的一点，安全不能影响业务，不能因为安全问题带来业务问题；最后，osquery功能的可扩展性也是一个点，osquery是不带server的，这使得osquery其实无法直接成为一个hids，而只能是一个数据采集框架，也是因为这点，甲方安全人员可以基于数据采集进行各种扩展和场景适配，同时osquery本身带有一些心跳监控和日志记录等较灵活的功能，甲方人员可以基于osquery本身较强和灵活的功能特点对osquery的后续做框架拼接，做消息缓存，做实时检测，做离线计算等，利用osquery良好的兼容性和稳定性在甲方特有的较大量级（百万级）资产场景下部署并完成每一台主机的细粒度监控、处置</p>
<p>之所以写这篇文章是因为考虑一两年两三年后可能也会去甲方也做类似的主机安全建设，所以先提前记录一波，顺带着思考一下应用场景、需求、能力、价值、架构设计等等（可能以上列举的跟真实的甲方安全需求并不完全一致，期待后续能真正参与到像<a href="https://tech.meituan.com/2019/01/17/distributed-hids-cluster-architecture-design.html" target="_blank" rel="noopener">美团</a>那样量级的hids安全建设中学习一下）</p>
<h2 id="二、基本使用"><a href="#二、基本使用" class="headerlink" title="二、基本使用"></a>二、基本使用</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>osquery是facebook开源的一款基于sql引擎的跨平台主机信息查询和监控框架；osquery的设计思想比较奇特，其将主机比作一个数据库，将主机产生的日志信息当成库表，支持使用sql语法对表中存储的主机日志信息进行查询；osquery支持查询的信息几乎涵盖主机产生的所有类型的日志数据，查询方式支持实时和调度，非常灵活</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>osquery项目<a href="https://osquery.io/downloads" target="_blank" rel="noopener">主页</a>上可以进行下载，支持源码安装和安装包安装，这边在ubuntu16.04下进行源码安装：</p>
<pre><code>export OSQUERY_KEY=1484120AC4E9F8A1A577AEEE97A80C63C9D8B80B
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys $OSQUERY_KEY
sudo add-apt-repository &#39;deb [arch=amd64] https://pkg.osquery.io/deb deb main&#39;
sudo apt-get update
sudo apt-get install osquery</code></pre><p>可以通过运行osqueryi查看是否安装成功</p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><h4 id="osqueryi"><a href="#osqueryi" class="headerlink" title="osqueryi"></a>osqueryi</h4><p><strong>内置命令</strong></p>
<p>osqueryi和osqueryd是两个完全分离的程序，osqueryi支持用户终端界面基于sql做交互查询，osqueryd是osquery守护进程，运行后会在后台静默部署以服务形式基于配置文件采集数据，一般如果是测试可以用osqueryi，实际环境下都是用osqueryd；运行osqueryi，进入交互模式后可以先看下内置命令，这边注释都很清晰：</p>
<pre><code>➜  ~ osqueryi
Using a virtual database. Need help, type &#39;.help&#39;
osquery&gt; .help
Welcome to the osquery shell. Please explore your OS!
You are connected to a transient &#39;in-memory&#39; virtual database.

.all [TABLE]     Select all from a table
.bail ON|OFF     Stop after hitting an error
.echo ON|OFF     Turn command echo on or off
.exit            Exit this program
.features        List osquery&#39;s features and their statuses
.headers ON|OFF  Turn display of headers on or off
.help            Show this message
.mode MODE       Set output mode where MODE is one of:
                   csv      Comma-separated values
                   column   Left-aligned columns see .width
                   line     One value per line
                   list     Values delimited by .separator string
                   pretty   Pretty printed SQL results (default)
.nullvalue STR   Use STRING in place of NULL values
.print STR...    Print literal STRING
.quit            Exit this program
.schema [TABLE]  Show the CREATE statements
.separator STR   Change separator used by output mode
.socket          Show the osquery extensions socket path
.show            Show the current values for various settings
.summary         Alias for the show meta command
.tables [TABLE]  List names of tables
.types [SQL]     Show result of getQueryColumns for the given query
.width [NUM1]+   Set column widths for &quot;column&quot; mode
.timer ON|OFF      Turn the CPU timer measurement on or off</code></pre><p>比较常用的几个如下：</p>
<pre><code>.mode: sql查询结果的显示模式
.schema: 后面跟表名输出表结构
.show: 输出osqueryi当前的配置
.features: 列出osquery的功能和开启状态
.tables: 列出当前osquery支持的所有表名</code></pre><p><strong>sql语法</strong></p>
<p>官方文档里说明了osqueryi修改自sqlite shell，所以其支持原生sqlite的sql查询语法：</p>
<blockquote>
<p>osqueryi is a modified version of the SQLite shell. It accepts several meta-commands, prefixed with a ‘.’:</p>
</blockquote>
<p><strong>表</strong></p>
<p>具体支持的表的类型、结构、描述都在<a href="https://osquery.io/schema/4.5.1/#process_events" target="_blank" rel="noopener">官网</a>有说明，文档非常清晰，不得不说osquery在项目文档这块做的是真的好；带evented_table标识的表示此表事件来自于（auditd）实时收集：</p>
<p><img src="./image-20201029111821393.png" alt="image-20201029111821393"></p>
<h4 id="osqueryd"><a href="#osqueryd" class="headerlink" title="osqueryd"></a>osqueryd</h4><p><strong>启动</strong></p>
<p>安装后自动注册systemctl：</p>
<pre><code>➜  ~ systemctl status osqueryd.service
● osqueryd.service - The osquery Daemon
   Loaded: loaded (/usr/lib/systemd/system/osqueryd.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
➜  ~ systemctl restart osqueryd.service
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===
Authentication is required to restart &#39;osqueryd.service&#39;.
Authenticating as: xdw,,, (xdw)
Password:
==== AUTHENTICATION COMPLETE ===
➜  ~ systemctl status osqueryd.service
● osqueryd.service - The osquery Daemon
   Loaded: loaded (/usr/lib/systemd/system/osqueryd.service; disabled; vendor preset: enabled)
   Active: active (running) since Thu 2020-10-29 11:30:49 CST; 2s ago
  Process: 20897 ExecStartPre=/bin/sh -c if [ -f $LOCAL_PIDFILE ]; then mv $LOCAL_PIDFILE $PIDFILE; fi (code=e
  Process: 20881 ExecStartPre=/bin/sh -c if [ ! -f $FLAG_FILE ]; then touch $FLAG_FILE; fi (code=exited, statu
 Main PID: 20900 (osqueryd)
    Tasks: 13
   Memory: 7.4M
      CPU: 37ms
   CGroup: /system.slice/osqueryd.service
           ├─20900 /usr/bin/osqueryd --flagfile /etc/osquery/osquery.flags --config_path /etc/osquery/osquery.
           └─20917 /usr/bin/osqueryd

Oct 29 11:30:49 ubuntu systemd[1]: Stopped The osquery Daemon.
Oct 29 11:30:49 ubuntu systemd[1]: Starting The osquery Daemon...
Oct 29 11:30:49 ubuntu systemd[1]: Started The osquery Daemon.
Oct 29 11:30:49 ubuntu osqueryd[20900]: osqueryd started [version=4.5.1]
Oct 29 11:30:49 ubuntu osqueryd[20900]: W1029 11:30:49.270629 20917 init.cpp:587] Error reading config: config
Oct 29 11:30:49 ubuntu osqueryd[20900]: I1029 11:30:49.270979 20917 events.cpp:867] Event publisher not enable
Oct 29 11:30:49 ubuntu osqueryd[20900]: I1029 11:30:49.271317 20917 events.cpp:867] Event publisher not enable
➜  ~</code></pre><p><strong>配置</strong></p>
<p>osqueryd两个配置文件路径默认都在/etc/osquery/目录下，分别为osquery.conf,osquery.flags，前者存储osqueryd运行后的一些配置，后者则为标志位存储文件，即用标志位表示程序启动时的功能启停设置，具体标志位详情见<a href="https://osquery.readthedocs.io/en/stable/installation/cli-flags/" target="_blank" rel="noopener">Command Line Flags</a>；另外之前试过把osquery.flags中的内容放到osquery.conf中，效果和分开存储是一样的，就跟spoock师傅说的一样，其实osquery.conf可以说是osquery.flags的一个超集；</p>
<p><strong>osquery.conf</strong></p>
<p>osquery项目提供了一份配置样例：</p>
<pre><code>{
  // Configure the daemon below:
  &quot;options&quot;: {
    // Select the osquery config plugin.
    &quot;config_plugin&quot;: &quot;filesystem&quot;,

    // Select the osquery logging plugin.
    &quot;logger_plugin&quot;: &quot;filesystem&quot;,

    // The log directory stores info, warning, and errors.
    // If the daemon uses the &#39;filesystem&#39; logging retriever then the log_dir
    // will also contain the query results.
    //&quot;logger_path&quot;: &quot;/var/log/osquery&quot;,

    // Set &#39;disable_logging&#39; to true to prevent writing any info, warning, error
    // logs. If a logging plugin is selected it will still write query results.
    //&quot;disable_logging&quot;: &quot;false&quot;,

    // Splay the scheduled interval for queries.
    // This is very helpful to prevent system performance impact when scheduling
    // large numbers of queries that run a smaller or similar intervals.
    //&quot;schedule_splay_percent&quot;: &quot;10&quot;,

    // A filesystem path for disk-based backing storage used for events and
    // query results differentials. See also &#39;use_in_memory_database&#39;.
    //&quot;database_path&quot;: &quot;/var/osquery/osquery.db&quot;,

    // Comma-delimited list of table names to be disabled.
    // This allows osquery to be launched without certain tables.
    //&quot;disable_tables&quot;: &quot;foo_bar,time&quot;,

    // Comma-delimited list of table names to be enabled.
    // This allows osquery to be launched with certain tables only.
    //&quot;enable_tables&quot;: &quot;foo_bar,time&quot;,

    &quot;utc&quot;: &quot;true&quot;
  },

  // Define a schedule of queries:
  &quot;schedule&quot;: {
    // This is a simple example query that outputs basic system information.
    &quot;system_info&quot;: {
      // The exact query to run.
      &quot;query&quot;: &quot;SELECT hostname, cpu_brand, physical_memory FROM system_info;&quot;,
      // The interval in seconds to run this query, not an exact interval.
      &quot;interval&quot;: 3600
    }
  },

  // Decorators are normal queries that append data to every query.
  &quot;decorators&quot;: {
    &quot;load&quot;: [
      &quot;SELECT uuid AS host_uuid FROM system_info;&quot;,
      &quot;SELECT user AS username FROM logged_in_users ORDER BY time DESC LIMIT 1;&quot;
    ]
  },

  // Add default osquery packs or install your own.
  //
  // There are several &#39;default&#39; packs installed with &#39;make install&#39; or via
  // packages and/or Homebrew.
  //
  // Linux:        /usr/share/osquery/packs
  // OS X:         /var/osquery/packs
  // Homebrew:     /usr/local/share/osquery/packs
  // make install: {PREFIX}/share/osquery/packs
  //
  &quot;packs&quot;: {
    // &quot;osquery-monitoring&quot;: &quot;/usr/share/osquery/packs/osquery-monitoring.conf&quot;,
    // &quot;incident-response&quot;: &quot;/usr/share/osquery/packs/incident-response.conf&quot;,
    // &quot;it-compliance&quot;: &quot;/usr/share/osquery/packs/it-compliance.conf&quot;,
    // &quot;osx-attacks&quot;: &quot;/usr/share/osquery/packs/osx-attacks.conf&quot;,
    // &quot;vuln-management&quot;: &quot;/usr/share/osquery/packs/vuln-management.conf&quot;,
    // &quot;hardware-monitoring&quot;: &quot;/usr/share/osquery/packs/hardware-monitoring.conf&quot;,
    // &quot;ossec-rootkit&quot;: &quot;/usr/share/osquery/packs/ossec-rootkit.conf&quot;,
    // &quot;windows-hardening&quot;: &quot;C:\\Program Files\\osquery\\packs\\windows-hardening.conf&quot;,
    // &quot;windows-attacks&quot;: &quot;C:\\Program Files\\osquery\\packs\\windows-attacks.conf&quot;
  },

  // Provides feature vectors for osquery to leverage in simple statistical 
  // analysis of results data. 
  //
  // Currently this configuration is only used by Windows in the Powershell
  // Events table, wherein character_frequencies is a list of doubles 
  // representing the aggregate occurrence of character values in Powershell 
  // Scripts. A default configuration is provided which was adapated from 
  // Lee Holmes cobbr project: 
  // https://gist.github.com/cobbr/acbe5cc7a186726d4e309070187beee6
  // 
  &quot;feature_vectors&quot;: {
    &quot;character_frequencies&quot;: [
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.00045,  0.01798,
      0.0,      0.03111,  0.00063,  0.00027,   0.0,      0.01336,  0.0133,
      0.00128,  0.0027,   0.00655,  0.01932,   0.01917,  0.00432,  0.0045,
      0.00316,  0.00245,  0.00133,  0.001029,  0.00114,  0.000869, 0.00067,
      0.000759, 0.00061,  0.00483,  0.0023,    0.00185,  0.01342,  0.00196,
      0.00035,  0.00092,  0.027875, 0.007465,  0.016265, 0.013995, 0.0490895,
      0.00848,  0.00771,  0.00737,  0.025615,  0.001725, 0.002265, 0.017875,
      0.016005, 0.02533,  0.025295, 0.014375,  0.00109,  0.02732,  0.02658,
      0.037355, 0.011575, 0.00451,  0.005865,  0.003255, 0.005965, 0.00077,
      0.00621,  0.00222,  0.0062,   0.0,       0.00538,  0.00122,  0.027875,
      0.007465, 0.016265, 0.013995, 0.0490895, 0.00848,  0.00771,  0.00737,
      0.025615, 0.001725, 0.002265, 0.017875,  0.016005, 0.02533,  0.025295,
      0.014375, 0.00109,  0.02732,  0.02658,   0.037355, 0.011575, 0.00451,
      0.005865, 0.003255, 0.005965, 0.00077,   0.00771,  0.002379, 0.00766,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0,      0.0,       0.0,      0.0,      0.0,
      0.0,      0.0,      0.0
    ]
  }    
}</code></pre><p>其中主要包含如下几个字段：</p>
<pre><code>options
config_plugin
logger_plugin
schedule
decorators
packs</code></pre><p><strong>options</strong></p>
<p>官方文档给出的描述如下，那些不是用来控制启动配置的flags被归类为options内：</p>
<blockquote>
<p>Flags that do not control startup settings may be included as “options” within configuration. Essentially, any flag needed to help osquery determine and discover a configuration must be supplied via command-line arguments. Google Flags enhances this to allow flags to be set within environment variables or via a “master” flag file.</p>
</blockquote>
<p><strong>config_plugin</strong></p>
<p>配置相关的选项，默认是从本地磁盘上读取配置的，即filesystem选项，一旦配置为filesystem，则从config_path指向的路径读取配置；除了filesystem，osquery还支持tls读取配置，不过由于暂时未涉及，暂时不深入，猜测是用于集群环境下的批量配置部署：</p>
<blockquote>
<p>–config_plugin=filesystem</p>
<p>Config plugin name. The type of configuration retrieval, the default filesystem plugin reads a configuration JSON from disk.</p>
<p>Built-in options include: filesystem, tls</p>
<p>–config_path=/etc/osquery/osquery.conf</p>
</blockquote>
<p><strong>logger_plugin</strong></p>
<p>日志记录相关的配置，默认将osquery产生的日志保存在文件上（filesystem），除了本地文件存储，osquery还支持tls、syslog、kafka_producer等传输日志消息；支持多日志记录插件配置：</p>
<blockquote>
<p>–logger_plugin=filesystem</p>
<p>Logger plugin name. The default logger is filesystem. This writes the various log types as JSON to specific file paths.</p>
<p>Multiple logger plugins may be used simultaneously, effectively copying logs to each interface. Separate plugin names with a comma when specifying the configuration (–logger_plugin=filesystem,syslog).</p>
<p>Built-in options include: filesystem, tls, syslog, and several Amazon/AWS options.</p>
<p>–disable_logging=false</p>
<p>osquery includes logger plugins that support configurable logging to a variety of interfaces. The built in logger plugins are filesystem (default), tls, syslog (for POSIX), windows_event_log (for Windows), kinesis, firehose, and kafka_producer. Multiple logger plugins may be used simultaneously, effectively copying logs to each interface. To enable multiple loggers set the –logger_plugin option to a comma separated list, do not include spaces, of the requested plugins.</p>
<p>For information on configuring logger plugins, see logging/results flags. Developing new logger plugins is explored in the development docs. We recommend setting the logger plugin and logger settings via the osquery flagfile.</p>
</blockquote>
<p><strong>日志入kafka</strong></p>
<p>配置如下，具体见<a href="https://osquery.readthedocs.io/en/stable/deployment/logging/" target="_blank" rel="noopener">文档</a></p>
<pre><code>ubuntu@VM-0-17-ubuntu:~$ cat /etc/osquery/osquery.conf
{
  &quot;options&quot;: {
    &quot;config_plugin&quot;: &quot;filesystem&quot;,
    &quot;logger_plugin&quot;: &quot;kafka_producer&quot;,
    &quot;logger_path&quot;: &quot;/var/log/osquery&quot;,
    &quot;disable_logging&quot;: &quot;false&quot;,
    &quot;log_result_events&quot;: &quot;true&quot;,
    &quot;schedule_splay_percent&quot;: &quot;10&quot;,
    &quot;pidfile&quot;: &quot;/var/osquery/osquery.pidfile&quot;,
    &quot;events_expiry&quot;: &quot;3600&quot;,
    &quot;database_path&quot;: &quot;/var/osquery/osquery.db&quot;,
    &quot;verbose&quot;: &quot;false&quot;,
    &quot;worker_threads&quot;: &quot;6&quot;,
    &quot;enable_monitor&quot;: &quot;true&quot;,
    &quot;disable_events&quot;: &quot;false&quot;,
    &quot;disable_audit&quot;: &quot;false&quot;,
    &quot;audit_allow_config&quot;: &quot;true&quot;,
    &quot;host_identifier&quot;: &quot;hostname&quot;,
    &quot;enable_syslog&quot;: &quot;true&quot;,
    &quot;audit_allow_sockets&quot;: &quot;true&quot;,
    &quot;schedule_default_interval&quot;: &quot;3600&quot;,
    &quot;logger_kafka_brokers&quot;: &quot;127.0.0.1:9092&quot;,
    &quot;logger_kafka_topic&quot;: &quot;process-port&quot;,
    &quot;logger_kafka_acks&quot;: &quot;1&quot;
  },
  &quot;schedule&quot;: {
    &quot;process&quot;: {
      &quot;query&quot;: &quot;SELECT * FROM process_events;&quot;,
      &quot;interval&quot;: 3600
    }
  },
  &quot;decorators&quot;: {
    &quot;load&quot;: [
      &quot;SELECT uuid AS host_uuid FROM system_info;&quot;,
      &quot;SELECT user AS username FROM logged_in_users ORDER BY time DESC LIMIT 1;&quot;
    ]
  },
  &quot;packs&quot;: {
     &quot;osquery-monitoring&quot;: &quot;/usr/share/osquery/packs/osquery-monitoring.conf&quot;,
     &quot;incident-response&quot;: &quot;/usr/share/osquery/packs/incident-response.conf&quot;,
     &quot;it-compliance&quot;: &quot;/usr/share/osquery/packs/it-compliance.conf&quot;,
     &quot;vuln-management&quot;: &quot;/usr/share/osquery/packs/vuln-management.conf&quot;,
     &quot;system-snapshot&quot;: {
    &quot;queries&quot;: {
        &quot;processes_by_port&quot;: {
          &quot;query&quot;: &quot;select * from process_events&quot;,
          &quot;interval&quot;: 3600,
          &quot;snapshot&quot;: false
        }
      }
    }
  },
  &quot;kafka_topics&quot;: {
    &quot;process-port&quot;: [
      &quot;pack_system-snapshot_processes_by_port&quot;
    ]
  }
}</code></pre><p><img src="./image-20201029152149095.png" alt="image-20201029152149095"></p>
<p><strong>schedule</strong></p>
<p>osquery调度相关，query里是查询语句，interval代表调度周期，其它一些比较重要的可选字段如removed，snapshot等都在<a href="https://osquery.readthedocs.io/en/stable/deployment/configuration/#schedule" target="_blank" rel="noopener">文档</a>中有解释；其中snapshot这个字段比较重要，它表示查询结果是增量模式还是快照模式，若为快照模式，则输出当时查询的全量结果，若为增量模式，则每次查询只输出与上次查询有差异的部分（增量），这个要注意一下：</p>
<pre><code>  &quot;schedule&quot;: {
    // This is a simple example query that outputs basic system information.
    &quot;system_info&quot;: {
      // The exact query to run.
      &quot;query&quot;: &quot;SELECT hostname, cpu_brand, physical_memory FROM system_info;&quot;,
      // The interval in seconds to run this query, not an exact interval.
      &quot;interval&quot;: 3600
    }
  },</code></pre><pre><code>The basic scheduled query specification includes:

query: the SQL query to run
interval: an interval in seconds to run the query (subject to splay/smoothing)
removed: a boolean to determine if &quot;removed&quot; actions should be logged, default true
snapshot: a boolean to set &#39;snapshot&#39; mode, default false
platform: restrict this query to a given platform, default is &#39;all&#39; platforms; you may use commas to set multiple platforms
version: only run on osquery versions greater than or equal-to this version string
shard: restrict this query to a percentage (1-100) of target hosts
denylist: a boolean to determine if this query may be denylisted (when stopped for excessive resource consumption), default true</code></pre><p><strong>decorators</strong></p>
<p>decorators，为osquery查询结果增加额外的装饰器，大意就是配置装饰器将在查询前后执行装饰器内部定义的查询语句并将结果添加到osquery日志结果中去；装饰器支持几种模式，load是在每次配置加载时启动装饰器，always在schedule中的每条语句执行前运行装饰器，interval则是以调度模式启动装饰器：</p>
<pre><code>Decorator queries exist in osquery versions 1.7.3+ and are used to add additional &quot;decorations&quot; to results and snapshot logs. There are three types of decorator queries based on when and how you want the decoration data.

{
  &quot;decorators&quot;: {
    &quot;load&quot;: [
      &quot;SELECT version FROM osquery_info;&quot;,
      &quot;SELECT uuid AS host_uuid FROM system_info;&quot;
    ],
    &quot;always&quot;: [
      &quot;SELECT user AS username FROM logged_in_users WHERE user &lt;&gt; &#39;&#39; ORDER BY time LIMIT 1;&quot;
    ],
    &quot;interval&quot;: {
      &quot;3600&quot;: [
        &quot;SELECT total_seconds AS uptime FROM uptime;&quot;
      ]
    }
  }
}
The types of decorators are:

load: run these decorators when the configuration loads (or is reloaded)
always: run these decorators before each query in the schedule
interval: a special key that defines a map of interval times, see below

Each decorator query should return at most 1 row. A warning will be generated if more than 1 row is returned as they will be forcefully ignored and constitute undefined behavior. Each decorator query should be careful not to emit column collisions, this is also undefined behavior.

The columns, and their values, will be appended to each log line as follows. Assuming the above set of decorators is used, and the schedule is execution for over an hour (3600 seconds):</code></pre><p>目前只试过load：</p>
<pre><code>  &quot;decorators&quot;: {
    &quot;load&quot;: [
      &quot;SELECT uuid AS host_uuid FROM system_info;&quot;,
      &quot;SELECT user AS username FROM logged_in_users ORDER BY time DESC LIMIT 1;&quot;
    ]
  },</code></pre><p><img src="./image-20201029144955777.png" alt="image-20201029144955777"></p>
<p><strong>packs</strong></p>
<p>打包好的sechdule查询语句，可以将同一类型的查询语句打包放在一个packs中，osquery项目自带了一些默认的packs集合：</p>
<blockquote>
<p>The above section on packs almost covers all you need to know about query packs. The specification contains a few caveats since packs are designed for distribution. Packs use the packs key, a map where the key is a pack name and the value can be either a string or a dictionary (object). When a string is used the value is passed back into the config plugin and acts as a “resource” request.</p>
</blockquote>
<pre class=" language-json"><code class="language-json">  <span class="token property">"packs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    // <span class="token property">"osquery-monitoring"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/osquery-monitoring.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"incident-response"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/incident-response.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"it-compliance"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/it-compliance.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"osx-attacks"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/osx-attacks.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"vuln-management"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/vuln-management.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"hardware-monitoring"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/hardware-monitoring.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"ossec-rootkit"</span><span class="token operator">:</span> <span class="token string">"/usr/share/osquery/packs/ossec-rootkit.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"windows-hardening"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\osquery\\packs\\windows-hardening.conf"</span><span class="token punctuation">,</span>
    // <span class="token property">"windows-attacks"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\osquery\\packs\\windows-attacks.conf"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p><strong>/usr/share/osquery/packs/osquery-monitoring.conf</strong></p>
<p>osquery自带的状态监控pack：</p>
<pre><code>{
  &quot;queries&quot;: {
    &quot;schedule&quot;: {
      &quot;query&quot;: &quot;select name, interval, executions, output_size, wall_time, (user_time/executions) as avg_user_time, (system_time/executions) as avg_system_time, average_memory, last_executed from osquery_schedule;&quot;,
      &quot;interval&quot;: 7200,
      &quot;removed&quot;: false,
      &quot;blacklist&quot;: false,
      &quot;version&quot;: &quot;1.6.0&quot;,
      &quot;description&quot;: &quot;Report performance for every query within packs and the general schedule.&quot;
    },
    &quot;events&quot;: {
      &quot;query&quot;: &quot;select name, publisher, type, subscriptions, events, active from osquery_events;&quot;,
      &quot;interval&quot;: 86400,
      &quot;removed&quot;: false,
      &quot;blacklist&quot;: false,
      &quot;version&quot;: &quot;1.5.3&quot;,
      &quot;description&quot;: &quot;Report event publisher health and track event counters.&quot;
    },
    &quot;osquery_info&quot;: {
      &quot;query&quot;: &quot;select i.*, p.resident_size, p.user_time, p.system_time, time.minutes as counter from osquery_info i, processes p, time where p.pid = i.pid;&quot;,
      &quot;interval&quot;: 600,
      &quot;removed&quot;: false,
      &quot;blacklist&quot;: false,
      &quot;version&quot;: &quot;1.2.2&quot;,
      &quot;description&quot;: &quot;A heartbeat counter that reports general performance (CPU, memory) and version.&quot;
    }
  }
}</code></pre><p><strong>osquery.flags</strong></p>
<p>基本都在<a href="https://osquery.readthedocs.io/en/stable/installation/cli-flags/" target="_blank" rel="noopener">CommandLineFlags</a>中，不再详述</p>
<p><strong>log</strong></p>
<p>本地日志存储在/var/log/osquery/目录下，几个软链接指向的都是当前最新修改的日志文件；其中osqueryi.xxxxx和osqueryd.xxxxxx分别存储osqueryi和osqueryd的相关日志输出，前面也说过二者是分离的；error存储osquery运行过程中的一些报错日志，warn存储告警日志，info存储运行日志，results.log存储增量日志，snapshot存储快照日志，具体放在哪个文件里由前面的配置决定：</p>
<p><img src="./image-20201029150410846.png" alt="image-20201029150410846"></p>
<blockquote>
<p>Snapshot logs<br>Snapshot logs are an alternate form of query result logging. A snapshot is an ‘exact point in time’ set of results, with no differentials. For instance if you always want a list of mounts, not the added and removed mounts, then use a snapshot. In the mounts case, where differential results are seldom emitted (assuming hosts do not often mount and unmount), a complete snapshot will log after every query execution. This will be a lot of data amortized across your fleet.</p>
<p>Data snapshots may generate a large amount of output. For log collection safety, output is written to a dedicated sink. The filesystem logger plugin writes snapshot results to /var/log/osquery/osqueryd.snapshots.log.</p>
</blockquote>
<blockquote>
<p>The osquery daemon uses a default filesystem logger plugin. Like the config, output from the filesystem plugin is written as JSON. Results from the query schedule are written to /var/log/osquery/osqueryd.results.log.</p>
<p>There are two types of logs:</p>
<p>Status logs (INFO, WARNING, ERROR)<br>Query schedule results logs, including logs from snapshot queries</p>
</blockquote>
<h2 id="三、问题"><a href="#三、问题" class="headerlink" title="三、问题"></a>三、问题</h2><p>之前玩osquery的时候遇到过一些问题，记录一下：</p>
<h3 id="1、auditd占用"><a href="#1、auditd占用" class="headerlink" title="1、auditd占用"></a>1、auditd占用</h3><p>用户态的原生的auditd应用在osqueryd启动时应该kill掉，由osquery自实现audit系统接管netlink，否则可能会因为netlink占用问题起冲突，一些由内核kauditd捕获的实时事件无法通过netlink传输到osquery audit审计系统，从而导致部分走auditd获取数据的表的sql查询输出为空，相关问题其实文档里已经有说明了，当时记得折腾了半天：</p>
<blockquote>
<p>On Linux, osquery uses the Audit system to collect and process audit events from the kernel. It accomplishes this by monitoring the execve() syscall. auditd should not be running when using osquery’s process auditing, as it will conflict with osqueryd over access to the audit netlink socket. You should also ensure auditd is not configured to start at boot.</p>
</blockquote>
<h3 id="2、osqueryi和osqueryd同时运行"><a href="#2、osqueryi和osqueryd同时运行" class="headerlink" title="2、osqueryi和osqueryd同时运行"></a>2、osqueryi和osqueryd同时运行</h3><p>osqueryi和osqueryd若同时运行，先运行者会占用后运行者的auditd数据传输通道，从而导致只有前者能获取到数据而后者无法获取到</p>
<h3 id="3-etc"><a href="#3-etc" class="headerlink" title="3.etc."></a>3.etc.</h3><p>后续有发现继续记录</p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>针对osquery的使用结合自身的一些经历做了一个比较粗糙的分析，后续在使用上有了新的发现将继续在此篇进行补充，另外不得不提一下osquery的文档做的是真的好，细节说明非常清晰，各种配置、参数、使用方式、问题等都能在文档中找到，之后将继续对文档深入学习；随着对osquery的慢慢熟悉，后续将进行较深入一点的架构层次上的学习与分析；osquery相关的文章国内研究输出的好像不是非常多，这边都是参考spoock师傅的教程，写的是真的好，受益匪浅</p>
<h2 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h2><p><a href="https://blog.spoock.com/2018/11/27/usage-of-osqueryd/" target="_blank" rel="noopener">https://blog.spoock.com/2018/11/27/usage-of-osqueryd/</a></p>
<p><a href="https://blog.spoock.com/2018/11/26/osquery-intro/" target="_blank" rel="noopener">https://blog.spoock.com/2018/11/26/osquery-intro/</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" rel="tag"># 二进制</a>
              <a href="/tags/%E5%BC%80%E6%BA%90/" rel="tag"># 开源</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/10/22/Yulong-Hids-Process-Monitor-Principle-Analysis/" rel="prev" title="Yulong-Hids Process Monitor Principle Analysis">
                  <i class="fa fa-chevron-left"></i> Yulong-Hids Process Monitor Principle Analysis
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/10/28/Osquery%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90/" rel="next" title="Osquery架构设计分析">
                  Osquery架构设计分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XDW</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>



    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/prismjs@1.21.0/components/prism-core.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  















  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>








  

  

</body>
</html>
